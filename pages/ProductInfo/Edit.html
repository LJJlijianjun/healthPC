<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>产品中心</title>
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.css" rel="stylesheet" />
    <link href="../../assets/vendors/blueimp-file-upload/css/jquery.fileupload.css" rel="stylesheet" />
    <link href="../../assets/vendors/blueimp-file-upload/css/jquery.fileupload-ui.css" rel="stylesheet" />
    <link href="../../assets/vendors/select2/dist/css/select2.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/lightbox2/dist/css/lightbox.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../assets/vendors/gw-recommendedUserSelector/dist/gw-recommendedUserSelector.min.css?v=1.0.0" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />


</head>
<body>
    <div class="productInfo-publishView">
        <div class="container-fluid">
            <div class="row processInfo">
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 pl10 textLeft">
                    <span>当前操作：</span>
                    <span class="process-currentTask"></span>
                </div>
                <div class="col-xs-6 pr10 textRight">
                    <a class="process-detail" href="#">流转明细及回退意见</a>&nbsp;&nbsp;
                    <!--<a href="#" class="process-picture" data-lightbox="processPic" data-title="流程图示">流程图示</a>-->
                </div>
                <div class="col-xs-12 pl10 textLeft">
                    <span class="process-backReasonDesc"></span>
                    <span class="process-backReason"></span>
                </div>
            </div>

            <div class="row processToolBar">
                <div class="col-xs-6 textLeft">
                    <div class="alert alert-danger formTip">
                        <span class="fa fa-info-circle"></span>
                        <span>红色标识字段为必填项！</span>
                    </div>
                </div>
                <div class="col-xs-6 textRight">
                    <div class="btn-group processButtonGroup">
                    </div>
                </div>
            </div>

            <form id="form1" class="mt10" novalidate="novalidate">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="panel-title">
                            基本信息
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-xs-4">
                                <div class="input-group pr15">
                                    <span class="input-group-addon required">产品名称</span>
                                    <input class="form-control" id="txtTitle" name="txtTitle" data-popover-placement="bottom" type="text" maxlength="500" placeholder="产品名称" />
                                </div>
                            </div>
                            <div class="col-xs-4">
                                <div class="input-group pr15">
                                    <span class="input-group-addon required">产品类型</span>
                                    <select class="form-control" id="selProductType" name="selProductType"></select>
                                </div>
                            </div>
                            <div class="col-xs-4">
                                <div class="input-group">
                                    <span class="input-group-addon required">产品周期</span>
                                    <input class="form-control" id="txtPeriod" name="txtPeriod" data-popover-placement="bottom" type="text" maxlength="4" placeholder="产品周期" />
                                    <span class="input-group-addon">天</span>
                                </div>
                            </div>
                        </div>
                        <div class="row mt10">
                            <div class="col-xs-4">
                                <div class="input-group pr15">
                                    <span class="input-group-addon required">产品金额</span>
                                    <input class="form-control" id="txtWorth" name="txtWorth" data-popover-placement="bottom" type="text" maxlength="8" placeholder="产品金额" />
                                    <span class="input-group-addon">万元</span>
                                </div>
                            </div>
                            <div class="col-xs-4 pr15">
                                <div class="input-group">
                                    <span class="input-group-addon required">预期收益率</span>
                                    <input class="form-control" id="txtExpectIncome" name="txtExpectIncome" data-popover-placement="bottom" type="text" maxlength="6" placeholder="预期收益率（例8.88）" />
                                    <span class="input-group-addon">%</span>
                                </div>
                            </div>
                            <div class="col-xs-4">
                                <div class="input-group">
                                    <span class="input-group-addon required">产品阶段</span>
                                    <select class="form-control" id="selProductStageType" name="selProductStageType">
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mt10">
                            <div class="col-xs-8">
                                <div class="input-group pr15">
                                    <span class="input-group-addon required">产品链接</span>
                                    <input class="form-control" id="txtProductLink" name="txtProductLink" data-popover-placement="bottom" type="text" maxlength="500" placeholder="如无产品链接请输入经营单位网址,例http://www.gwamcc.com" />
                                </div>
                            </div>
                            <div class="col-xs-4">
                                <div class="input-group">
                                    <span class="input-group-addon">产品代码</span>
                                    <input class="form-control" id="txtProductCode" name="txtProductCode" data-popover-placement="bottom" type="text" maxlength="500" placeholder="产品代码(保存后系统自动生成)" readonly="readonly"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt10">
                    <div class="col-xs-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <div class="panel-title required">资金用途</div>
                            </div>
                            <div class="panel-body">
                                <div id="editPurpose" style="height:150px">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt10">
                    <div class="col-xs-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <div class="panel-title required">退出方式</div>
                            </div>
                            <div class="panel-body">
                                <div id="editIncomeMode" style="height:150px">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt10">
                    <div class="col-xs-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <div class="panel-title required">风控措施</div>
                            </div>
                            <div class="panel-body">
                                <div id="editRiskManage" style="height:150px">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt10">
                    <div class="col-xs-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <div class="panel-title">联系方式</div>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-xs-3 pr10">
                                        <div class="input-group">
                                            <span class="input-group-addon required">联系人</span>
                                            <input class="form-control" id="txtContactsName" name="txtContactsName" data-popover-placement="top" type="text" maxlength="20" placeholder="联系人" />
                                        </div>
                                    </div>
                                    <div class="col-xs-3 pr10">
                                        <div class="input-group">
                                            <span class="input-group-addon required">电话</span>
                                            <input class="form-control" id="txtAreaFixedTel" name="txtAreaFixedTel" data-popover-placement="top" type="text" maxlength="4" placeholder="区号" />
                                            <span class="input-group-addon required">-</span>
                                            <input style="min-width:110px" class="form-control" id="txtContactsFixedTel" name="txtContactsFixedTel" data-popover-placement="top" type="text" maxlength="20" placeholder="电话" />
                                        </div>
                                    </div>
                                    <div class="col-xs-3 pr10">
                                        <div class="input-group">
                                            <span class="input-group-addon minWidth64 required">手机</span>
                                            <input class="form-control" id="txtContactsMobileTel" name="txtContactsMobileTel" data-popover-placement="top" type="text" maxlength="11" placeholder="手机" />
                                        </div>
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="input-group">
                                            <span class="input-group-addon minWidth64 required">邮箱</span>
                                            <input class="form-control" id="txtContactsEmail" name="txtContactsEmail" data-popover-placement="top" type="text" maxlength="100" placeholder="邮箱" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top:10px; margin-bottom: 15px " class="col-xs-12 textRight">
                    <div class="btn-group processButtonGroup">
                    </div>
                </div>
            </form>
        </div>
        <a id="totop" href="#" title="回到顶部"><i class="fa fa-angle-up"></i></a>
        <input type="hidden" id="hidProductInfoId" value="-1" />
        <input type="hidden" id="hidPublishOrgID" />
        <input type="hidden" id="hidProductInfoStatus" />
        <a class="w1 h1 none" id="hidPreviewLink" href="" target="_blank"></a>
    </div>
    <!--[if lt IE 9]>
        <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
        <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <script src="../../assets/vendors/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="../../assets/js/jquery-tools-min.js" type="text/javascript"></script>
    <script src="../../assets/js/config.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/js/auth.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../assets/js/common.min.js?v=1.0.3" type="text/javascript"></script>
    <script src="../../assets/js/workFlow.min.js?v=1.0.2" type="text/javascript"></script>
    <script src="../../assets/vendors/select2/dist/js/select2.full.min.js"></script>
    <script src="../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.js" type="text/javascript"></script>
    <script src="../../assets/vendors/jquery-validation/dist/jquery.validate.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/jquery-validation/src/localization/messages_zh.js"></script>
    <!-- The XDomainRequest Transport is included for cross-domain file deletion for IE 8 and IE 9 -->
    <!--[if (gte IE 8)&(lt IE 10)]>
        <script src="../../assets/vendors/blueimp-file-upload/js/cors/jquery.xdr-transport.js" type="text/javascript"></script>
    <![endif]-->
    <script src="../../assets/vendors/underscore/underscore-min.js"></script>
    <script src="../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script src="../../assets/vendors/gw-recommendedUserSelector/dist/gw-recommendedUserSelector.min.js?v=1.0.0"></script>
    <script src="../../assets/vendors/xss/dist/xss.min.js"></script>
    <script src="../../assets/vendors/lightbox2/dist/js/lightbox.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/platform.js/platform.js" type="text/javascript"></script>
    <script src="../../assets/vendors/bootbox.js/bootbox.js" type="text/javascript"></script>
    <script src="../../assets/vendors/ueditor/ueditor.config.js"></script>
    <script src="../../assets/vendors/ueditor/ueditor.all.js"></script>
    <script type="text/javascript">
        $('#selProductType').select2({ width: 'resolve' });
        $('#selProductStageType').select2({ width: 'resolve' });
    </script>
    <script type="text/javascript">
        var cooperativeOrgServiceTypeDic;
        var bModifiedFlag = false;
        var bDeleteFlag = false;
        var editorPurpose;
        var editorIncomeMode;
        var editorRiskManage;

        $(function () {
            AuthUtility.Auth(function () {
                initWorkFlow();
                editorPurpose = UE.getEditor('editPurpose');
                editorIncomeMode = UE.getEditor('editIncomeMode');
                editorRiskManage = UE.getEditor('editRiskManage');

                initProductTypeSelector();
                initProductStageTypeSelector();
                initValidator();

                loadForm();
                bindEvent();
                //initLightBox();
            });
        });

        // 初始化工作流
        function initWorkFlow() {
            $(document).Workflow('ProcessInfo', {
                Btn: {
                    // 点击保存按钮
                    Save: function () {
                        saveForm('save', function () {
                            WorkflowAction.Save();
                        });
                    },
                    // 点击预览
                    Preview: function () {
                        saveForm('preview', function () {
                            document.getElementById('hidPreviewLink').click();
                        });
                    },
                    // 点击邮件预览
                    EmailPreview: function () {
                        saveForm('emailPreview', function () {
                            var emailPreviewUrl = 'EmailPreview.html?productInfoId=' + $('#hidProductInfoId').val();
                            $('#emailPreviewFrame').attr('src', emailPreviewUrl);
                            $('#emailPreviewModel').modal({ backdrop: 'static', keyboard: false });
                        });
                    },
                    // 点击下一步按钮
                    Next: function () {
                        saveForm('next', function () {
                            WorkflowAction.Next();
                        });
                    },
                    // 点击删除按钮
                    Delete: function () {
                        if ($('#hidProductInfoId').val() == -1) {
                            bootbox.alert({ message: '未新建产品！' });
                            return;
                        }
                        bootbox.confirm({
                            size: 'small',
                            message: "确定要删除吗？",
                            callback: function (result) {
                                if (result === true) {
                                    deleteForm(function (data) {
                                        if (data && data.Success === true && data.Data === 0) {
                                            bModifiedFlag = false;
                                            bDeleteFlag = true;
                                            bootbox.alert({
                                                message: '删除成功！',
                                                callback: function () {
                                                    WorkflowEngine.RedirectToDoListPage();
                                                }
                                            });
                                        } else {
                                            bootbox.alert({ message: '删除失败！' });
                                        }
                                    });
                                }
                            }
                        });
                    }
                }
            });
        }

        // 初始化表单验证控件
        function initValidator() {
            $.validator.addMethod("antiSqlInject", function (value, element, params) {
                if (value) {
                    return !AntiSqlInject($(element).val());
                } else {
                    return value;
                }
            }, "输入内容中包含非法字符！");

            $.validator.addMethod("checkAreaFixedTel", function (value, element) {
                var fixedTel = /^(0[0-9]{2,3})?$/;
                return this.optional(element) || fixedTel.test(value);
            }, "请填写正确的电话区号！");

            $.validator.addMethod("checkFixedTel", function (value, element) {
                var fixedTel = /^([1-9][0-9]{6,7})+(\-[0-9]{1,4})?$/;
                return this.optional(element) || fixedTel.test(value);
            }, "请填写正确的电话号码！");

            $.validator.addMethod("checkMobileTel", function (value, element) {
                var mobileTel = /^1\d{10}$/;
                return this.optional(element) || mobileTel.test(value);
            }, "请填写正确的手机号码！");

            $.validator.addMethod("checkEmail", function (value, element) {
                var email = /^[0-9a-z][_.0-9a-z-]{0,31}@([0-9a-z][0-9a-z-]{0,30}[0-9a-z]\.){1,4}[a-z]{2,4}$/;
                return this.optional(element) || email.test(value);
            }, "邮箱格式不正确！");

            $.validator.addMethod("checkNaN", function (value, element) {
                //var period = /^d+$/;
                return this.optional(element) || !isNaN(value);
            }, "只能输入数字！");

            $('#form1').validate({
                rules: {
                    txtTitle: { required: true, antiSqlInject: true },
                    selProductType: { required: true },
                    txtPeriod: { required: true, checkNaN: true },
                    txtWorth: { required: true, checkNaN: true },
                    txtExpectIncome: { required: true, checkNaN:true },
                    selProductStageType: { required: true },
                    txtProductLink: { required: true,url: true },
                    txtContactsName: { required: true, antiSqlInject: true },
                    txtAreaFixedTel: { required: false, checkAreaFixedTel: true },
                    txtContactsFixedTel: { required: true, checkFixedTel: true },
                    txtContactsMobileTel: { required: true, checkMobileTel: true },
                    txtContactsEmail: { required: true, checkEmail: true }
                },
                messages: {
                    txtTitle: { required: '产品名称不能为空！' },
                    selProductType: { required: '产品类型不能为空！' },
                    txtPeriod: { required: '产品周期不能为空！' },
                    txtWorth: { required: '产品金额不能为空！' },
                    txtExpectIncome: { required: '预期收益率不能为空！' },
                    selProductStageType: { required: '产品阶段不能为空！' },
                    txtProductLink: { required: '产品链接不能为空！' },
                    txtContactsName: { required: "联系人不能为空！" },
                    txtContactsFixedTel: { required: "联系人电话不能为空！" },
                    txtContactsMobileTel: { required: "联系人手机不能为空！" },
                    txtContactsEmail: { required: "联系人邮箱不能为空！" }
                    
                },
                onkeyup:false,
                showErrors: jqValidationShowErrors
            });
        }

        // 加载表单
        var loadStatus = 0;
        function loadForm() {
            $.ajax({
                url: dataServiceBaseUrl + 'api/ProductInfo/ProductInfo/GetProductInfoByProcessId?sid=' + sid,
                type: 'get',
                data: {
                    processId: $.url().param("processId").trim()
                },
                beforeSend: function () {
                    $('body').loadingUI({ text: '加载中...' });
                },
                async: true,
                cache: false,
                dataType: 'json',
                success: function (data) {
                    if (data && data.Success === true && data.Data) {
                        if (data.Data.ProductInfo != null) {
                            // 保存产品信息ID
                            $('#hidProductInfoId').val(data.Data.ProductInfo.ID);
                            // 保存发布单位ID
                            $('#hidPublishOrgID').val(data.Data.ProductInfo.PublishOrgID);
                            // 设置预览a标签链接
                            $('#hidPreviewLink').attr('href', 'Preview.html#id=' + data.Data.ProductInfo.ID);
                            // 保存产品状态字段
                            $('#hidProductInfoStatus').val(data.Data.ProductInfo.Status);
                            // 产品名称
                            $('#txtTitle').val(data.Data.ProductInfo.Title);
                            $('#txtProductCode').val(data.Data.ProductInfo.Code);
                            // 业务类型
                            initProductTypeSelector(data.Data.ProductInfo.ProductTypeKV);
                            initProductStageTypeSelector(data.Data.ProductInfo.StageKV);
                            $('#txtPeriod').val(data.Data.ProductInfo.Period);
                            $('#txtWorth').val(data.Data.ProductInfo.Worth);
                            $('#txtExpectIncome').val(data.Data.ProductInfo.ExpectIncome);
                            $('#txtProductLink').val(data.Data.ProductInfo.ProductLink);
                            $('#txtContactsName').val(data.Data.ProductInfo.ContactsName);
                            var tel = data.Data.ProductInfo.ContactsFixedTel.split('-');
                            if (tel.length === 1) {
                                $('#txtContactsFixedTel').val(data.Data.ProductInfo.ContactsFixedTel);
                            } else if (tel.length === 2) {
                                if (tel[0].length > 4) {
                                    $('#txtContactsFixedTel').val(data.Data.ProductInfo.ContactsFixedTel);
                                } else {
                                    $('#txtAreaFixedTel').val(tel[0]);
                                    $('#txtContactsFixedTel').val(tel[1]);
                                }
                            } else if (tel.length === 3) {
                                $('#txtAreaFixedTel').val(tel[0]);
                                $('#txtContactsFixedTel').val(tel[1] + '-' + tel[2]);
                            }
                            $('#txtContactsMobileTel').val(data.Data.ProductInfo.ContactsMobileTel);
                            $('#txtContactsEmail').val(data.Data.ProductInfo.ContactsEmail);

                            editorPurpose.ready(function () {
                                editorPurpose.setContent(unescape(data.Data.ProductInfo.Purpose.replace(/\$/g, '%')));
                            });
                            editorIncomeMode.ready(function () {
                                editorIncomeMode.setContent(unescape(data.Data.ProductInfo.IncomeMode.replace(/\$/g, '%')));
                            });
                            editorRiskManage.ready(function () {
                                editorRiskManage.setContent(unescape(data.Data.ProductInfo.RiskManage.replace(/\$/g, '%')));
                            });
                        }
                    }
                    else {
                        bootbox.alert({ message: '加载失败！' });
                    }
                    if (loadStatus === 0) {
                        $('body').loadingUI('hide');
                    }
                },
                error: function () {
                    bootbox.alert({ message: '加载失败！' });
                    $('body').loadingUI('hide');
                }
            });
        }

        // 初始化，添加收件人
        var currentReceiver = 0;
        function addEmailReceiver(data) {
            if (currentReceiver < data.length) {
                $('#divSendEmail .bootstrap-tagsinput input').focus();
                $('#txtMailReceiverName').tagsinput('add', data[currentReceiver]);
                bModifiedFlag = false;
                setTimeout(function () {
                    if (currentReceiver >= data.length - 1) {
                        $('#divSendEmail .bootstrap-tagsinput input').blur();
                        loadStatus = 0;
                        $('body').loadingUI('hide');
                        $('html,body').animate({ scrollTop: 0 }, 1000);
                    } else {
                        currentReceiver = currentReceiver + 1;
                        addEmailReceiver(data);
                    }
                }, 20);
            }
        }

        // 检查表单状态，如果有未保存的修改，返回true，否则返回false
        function checkFormModified() {
            return bModifiedFlag;
        }

        // 绑定事件
        function bindEvent() {

            // 回到顶部功能
            $(window).scroll(function () {
                if ($(this).scrollTop() < 100) {
                    $('#totop').fadeOut();
                } else {
                    $('#totop').fadeIn();
                }
            });
            $('#totop').on('click', function () {
                $('html,body').animate({ scrollTop: 0 }, 'fast');
                return false;
            });

            //// 拟合作单位选择
            //$('#btnSelectCooperativeOrg').on('click', function () {
            //    openOrgSelector();
            //    return false;
            //});
        }

        // 初始化产品类型选择列表
        function initProductTypeSelector(val) {
            var sel = $("#selProductType");
            var url = dataServiceBaseUrl + 'api/SysMaintain/Dictionary';
            var data = {
                searchModel: {
                    TypeId: 2,
                    PageNum: 1,
                    PageSize: 0,
                    IsActive: 1
                },
                sid: sid
            };
            bindSelector(sel, url, data, val);
        }

        // 初始化产品阶段选择列表
        function initProductStageTypeSelector(val) {
            var sel = $("#selProductStageType");
            var url = dataServiceBaseUrl + 'api/SysMaintain/Dictionary?sid=' + sid;
            var data = {
                searchModel: {
                    TypeId: 3,
                    PageNum: 1,
                    PageSize: 0,
                    IsActive: 1
                }
            };
            bindSelector(sel, url, data, val);
        }

        //select2绑定数据
        function bindSelector(sel, url, data, val) {
            sel.select2({
                selectOnClose: false,
                allowClear: false,
                minimumResultsForSearch: Infinity,
                width: '99.9%'
            });

            $.ajax({
                url: url,
                data: data,
                type: 'get',
                async: false,
                cache: false,
                success: function (result) {
                    if (result && result.Success === true && result.Data) {
                        if (sel.attr('id') == 'selProductStageType') {
                            cooperativeOrgServiceTypeDic = result.Data.rows;
                        }
                        sel.empty();
                        $.each(result.Data.rows, function (i, item) {
                            sel.append("<option value='" + item.Dkey + "'>" + item.DValue + "</option>");
                        });
                        sel.val(val);
                        sel.trigger('change.select2');
                        bModifiedFlag = false;
                    }
                }
            });
        }

        // 保存表单
        function saveForm(action, callback) {
            if ($('#form1').valid()) {
                var formData = {};
                var urlStr = '';
                var type = '';
                if (editorPurpose.getContent() && editorIncomeMode.getContent() && editorRiskManage.getContent()) {

                    if ($('#hidProductInfoId').val() == -1) {
                        urlStr = dataServiceBaseUrl + 'api/ProductInfo/ProductInfo?processId=' + $.url().param("processId").trim() + '&sid=' + sid + '&clientInfo=' + getClientInfo();
                        type = 'post';
                    } else {
                        formData.ID = $('#hidProductInfoId').val();
                        urlStr = dataServiceBaseUrl + 'api/ProductInfo/ProductInfo?sid=' + sid + '&clientInfo=' + getClientInfo();
                        type = 'put';
                    }
                    formData.ProcessID = $.url().param("processId").trim();
                    formData.Title = filterXSS($('#txtTitle').val().trim());
                    formData.ProductTypeKV = $('#selProductType').val();
                    formData.Period = filterXSS($('#txtPeriod').val().trim());
                    formData.Worth = filterXSS($('#txtWorth').val().trim());
                    formData.ExpectIncome = filterXSS($('#txtExpectIncome').val().trim());
                    formData.StageKV = $('#selProductStageType').val();
                    formData.Purpose = escape(editorPurpose.getContent()).replace(/%/g,'$');
                    formData.IncomeMode = escape(editorIncomeMode.getContent()).replace(/%/g, '$');
                    formData.RiskManage = escape(editorRiskManage.getContent()).replace(/%/g, '$');
                    formData.ContactsName = filterXSS($('#txtContactsName').val().trim());
                    formData.ContactsMobileTel = filterXSS($('#txtContactsMobileTel').val().trim());
                    formData.ContactsFixedTel = filterXSS(($('#txtAreaFixedTel').val().trim() === "" ? "" : $('#txtAreaFixedTel').val().trim() + '-') + $('#txtContactsFixedTel').val().trim());
                    formData.ContactsEmail = filterXSS($('#txtContactsEmail').val().trim());
                    formData.ProductLink = filterXSS($('#txtProductLink').val().trim());

                    $.ajax({
                        url: urlStr,
                        type: type,
                        data: JSON.stringify(formData),
                        beforeSend: function () {
                            if (action === 'save') {
                                $('body').loadingUI({ text: '保存中...' });
                                $('button[name=btnWf_Save]').button('loading');
                            }
                        },
                        contentType: 'application/json; charset=utf-8',
                        dataType: 'json',
                        async: true,
                        cache: false,
                        success: function (data) {
                            if (data && data.Success === true) {
                                if(data.Data !== 0){
                                    $('#hidProductInfoId').val(data.Data.ID);
                                    $('#txtProductCode').val(data.Data.Code);
                                    $('#hidPreviewLink').attr('href', 'Preview.html#id=' + data.Data.ID);
                                }
                                callback();
                            } else {
                                bootbox.alert({ message: '保存失败！' });
                            }
                            if (action === 'save') {
                                $('body').loadingUI('hide');
                                $('button[name=btnWf_Save]').button('reset');
                            }
                        },
                        error: function () {
                            bootbox.alert({ message: '保存失败！' });
                            if (action === 'save') {
                                $('body').loadingUI('hide');
                                $('button[name=btnWf_Save]').button('reset');
                            }
                        }
                    });
                } else {
                    if(editorPurpose.getContent() == ''){
                        bootbox.alert({ message: '请编辑资金用途！' });
                        return;
                    }
                    if (editorIncomeMode.getContent() == '') {
                        bootbox.alert({ message: '请编辑退出方式！' });
                        return;
                    };
                    if (editorRiskManage.getContent() == '') {
                        bootbox.alert({ message: '请编辑风控措施！' });
                        return;
                    }
                }
            }
        }

        // 删除表单
        function deleteForm(callback) {

            $.ajax({
                url: dataServiceBaseUrl + 'api/ProductInfo/ProductInfo?productInfoId=' + $('#hidProductInfoId').val() + '&sid=' + sid + '&clientInfo=' + getClientInfo(),
                type: 'delete',
                async: false,
                cache: false,
                dataType: 'json',
                success: function (data) {
                    if (callback) callback(data);
                }
            });
        }

        // 初始化图片查看控件
        function initLightBox() {
            lightbox.option({
                showImageNumberLabel: true,
                albumLabel: '第%1张，共%2张。',
                disableScrolling: false,
                alwaysShowNavOnTouchDevices: true,
                wrapAround: true
            });
        }
    </script>
</body>
</html>
