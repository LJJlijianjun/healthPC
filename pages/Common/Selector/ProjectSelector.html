<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>项目选择</title>
    <link href="../../../assets/css/base.css" rel="stylesheet" />
    <link href="../../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../../assets/vendors/gw-selectOrg/dist/gw-selectOrg.min.css?v=1.0.1" rel="stylesheet" />
    <link href="../../../assets/vendors/select2/dist/css/select2.min.css" rel="stylesheet" />
    <link href="../../../assets/vendors/iCheck/skins/square/blue.css" rel="stylesheet" />
    <link href="../../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.css?v=1.0.1" rel="stylesheet" />
    <link href="../../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.css" rel="stylesheet" />
    <link href="../../../assets/vendors/smalot-bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <link href="../../../assets/vendors/gw-projectPeriodSelector/src/gw-projectPeriodSelector.css" rel="stylesheet" />
    <link href="../../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />
</head>
<body class="project-Selector">
    <div class="modal-context">
        <div class="modal-head">
            <div class="modal-title">
                <span>选择项目</span><span id="multi"></span>
            </div>
            <div>
                <button class="close" id="btnCloseModal" type="button" title="关闭">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="projectInfo-listView">
                <div class="searchArea">
                    <div class="row">
                        <div class="col-xs-6 mt10">
                            <div class="input-group">
                                <span class="input-group-addon">名称</span>
                                <input class="form-control" id="txtTitle" name="txtTitle" type="text" placeholder="名称" />
                            </div>
                        </div>
                        <div class="col-xs-6 mt10">
                            <div class="input-group">
                                <span class="input-group-addon ">发布时间从</span>
                                <input class="form-control" id="txtPublishTimeStart" type="text" readonly="readonly" placeholder="开始时间" />
                                <span class="input-group-addon">至</span>
                                <input class="form-control" id="txtPublishTimeEnd" type="text" readonly="readonly" placeholder="结束时间" />
                            </div>
                        </div>
                        <div class="col-xs-6 mt10">
                            <div class="input-group">
                                <span class="input-group-addon">发布单位</span>
                                <div class="GWSelectOrg w320" id="selPublishOrg" name="selPublishOrg"></div>
                            </div>
                        </div>
                        <div class="col-xs-6 mt10">
                            <div class="input-group">
                                <span class="input-group-addon">预期你单位年化收益率</span>
                                <input class="form-control" id="txtCooperativeOrgAnnualReturnBegin" type="text" maxlength="10" placeholder="最小" />
                                <span class="input-group-addon">至</span>
                                <input class="form-control" id="txtCooperativeOrgAnnualReturnEnd" type="text" maxlength="10" placeholder="最大" />
                                <span class="input-group-addon clear-border-left">%</span>
                            </div>
                        </div>
                        <div class="col-xs-6 mt10">
                            <div class="input-group" id="divProjectPeriod">
                                <span class="input-group-addon">预计项目周期</span>
                                <div class="gwProjectPeriodSelector" id="selProjectPeriodBegin"></div>
                                <span class="input-group-addon projectPeriodYearAddOn">至 </span>
                                <div class="gwProjectPeriodSelector" id="selProjectPeriodEnd"></div>
                            </div>
                        </div>
                        <div class="col-xs-3 mt10" style="width: 31.5%;">
                            <div class="input-group">
                                <span class="input-group-addon">是否完结</span>
                                <select class="form-control" id="selIsComplete">
                                    <option value="-1">全部</option>
                                    <option value="1">是</option>
                                    <option value="0" selected="selected">否</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-xs-3 mt10 textRight" style="width: 18.5%;">
                            <div class="btn-group">
                                <button class="btn btn-default" id="btnSearch" type="button" disabled="disabled">
                                    <span class="fa fa-search"></span> 检索
                                </button>
                                <button class="btn btn-default" id="btnReset" type="button" disabled="disabled">
                                    <span class="fa fa-repeat"></span> 重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dataList mt10">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="row">
                <div class="col-xs-8" style="width: 643px; padding-right: 0;">
                    <div class="input-group">
                        <span class="input-group-addon" id="spanCooperativeItems">已选择项目</span>
                        <input class="form-control cp" id="txtCooperativeItems" name="txtCooperativeItems" type="text" readonly="readonly" />
                    </div>
                </div>
                <div class="col-xs-4 textRight" style="width: 25%; padding-left: 5px;">
                    <button class="btn btn-primary" id="btn_clear" type="button">
                        <span>清空</span>
                    </button>
                    <button class="btn btn-primary" id="btnAffirmProjectToList" type="button">
                        <span>确定</span>&nbsp;<span class="badge" id="candidateProjectNumBadge">0</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="flyingSign" id="flyingAdd">+</div>
    <div class="flyingSign" id="flyingSubduct">-</div>
    <script src="../../../assets/vendors/jquery/dist/jquery.min.js"></script>
    <script src="../../../assets/js/jquery-tools-min.js"></script>
    <script src="../../../assets/js/config.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../../assets/js/auth.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../../assets/js/common.min.js?v=1.0.3" type="text/javascript"></script>
    <script src="../../../assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../../../assets/vendors/gw-selectOrg/dist/gw-selectOrg.min.js?v=1.0.1"></script>
    <script src="../../../assets/vendors/select2/dist/js/select2.full.min.js"></script>
    <script src="../../../assets/vendors/smalot-bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="../../../assets/vendors/smalot-bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    <script src="../../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.js" type="text/javascript"></script>
    <script src="../../../assets/vendors/iCheck/icheck.min.js"></script>
    <script src="../../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script src="../../../assets/vendors/twbs-pagination/jquery.twbsPagination.js"></script>
    <script src="../../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.js?v=1.0.1"></script>
    <script src="../../../assets/vendors/gw-projectPeriodSelector/src/gw-projectPeriodSelector.js"></script>
    <script src="../../../assets/vendors/xss/dist/xss.min.js"></script>
    <script src="../../../assets/vendors/bootbox.js/bootbox.js"></script>
    <script src="../../../assets/vendors/underscore/underscore-min.js"></script>
    <script type="text/javascript">
        $('#selIsComplete').select2({ width: '100%', minimumResultsForSearch: Infinity });
    </script>
    <script type="text/javascript">
        var selectedProjectStr = $.url().param('selectedProjectStr');
        var selectedProjectArr;
        var multiCheck = (typeof $.url().param('multiCheck')) == 'undefined' ? true : ($.url().param('multiCheck') == 1 ? true : false);
        var selectOrgId = (typeof $.url().param('selectOrgId')) == 'undefined' ? 0 : $.url().param('selectOrgId');
        var dataListScModel = {
            Title: '',
            PublishOrgID: selectOrgId,
            PublishTimeStart: '',
            PublishTimeEnd: '',
            CooperativeOrgAnnualReturnBegin: '',
            CooperativeOrgAnnualReturnEnd: '',
            ProjectPeriodYearBegin: -1,
            ProjectPeriodMonthBegin: -1,
            ProjectPeriodYearEnd: -1,
            ProjectPeriodMonthEnd: -1,
            IsComplete: 0
        };

        $(function () {
            AuthUtility.Auth(function () {
                initSearch();
                initProjectInfoByIds();
                initCooperativeProjectInput();
                bindEvent();
            });
        });

        // 检索区域
        function initSearch() {
            $('#multi').html(multiCheck ? '（多选）' : '（单选）');
            initPublishOrgSelector();
            initDateSelecter();

            $('#selProjectPeriodBegin').GWProjectPeriodSelector({
                valueYear: 0,// 设置初始年数，如无则为0
                valueMonth: 0, // 设置初始月数，如无则为0
                addOnPosition: 'mid'
            });

            $('#selProjectPeriodEnd').GWProjectPeriodSelector({
                valueYear: 0,// 设置初始年数，如无则为0
                valueMonth: 0, // 设置初始月数，如无则为0
                addOnPosition: 'right'
            });

            $("#btnSearch").click(function () {
                dataListScModel.Title = filterXSS($('#txtTitle').val().trim());
                dataListScModel.PublishOrgID = selectOrgId != 0 ? selectOrgId : $('#selPublishOrg').GWSelectOrg('getSelectedOrgIDs').join(',');
                dataListScModel.PublishTimeStart = filterXSS($('#txtPublishTimeStart').val());
                dataListScModel.PublishTimeEnd = filterXSS($('#txtPublishTimeEnd').val());
                dataListScModel.CooperativeOrgAnnualReturnBegin = filterXSS($('#txtCooperativeOrgAnnualReturnBegin').val());
                dataListScModel.CooperativeOrgAnnualReturnEnd = filterXSS($('#txtCooperativeOrgAnnualReturnEnd').val());
                dataListScModel.ProjectPeriodYearBegin = $('#selProjectPeriodBegin').val().year;
                dataListScModel.ProjectPeriodMonthBegin = $('#selProjectPeriodBegin').val().month;
                dataListScModel.ProjectPeriodYearEnd = $('#selProjectPeriodEnd').val().year;
                dataListScModel.ProjectPeriodMonthEnd = $('#selProjectPeriodEnd').val().month;
                dataListScModel.IsComplete = $('#selIsComplete').val();
                $('.dataList button.operate').prop('disabled', true);
                $('.dataList').GWDataTable('load', dataListScModel);
            });

            $("#btnReset").click(function () {
                $('#txtTitle').val('');
                if (selectOrgId == 0) {
                    $('#selPublishOrg').GWSelectOrg('reSetSelected');
                }
                $('#txtPublishTimeStart').val('');
                $('#txtPublishTimeEnd').val('');
                $('#selIsComplete').val('0');
                $('#selIsComplete').trigger('change.select2');
                $('#txtCooperativeOrgAnnualReturnBegin').val('');
                $('#txtCooperativeOrgAnnualReturnEnd').val('');
                $('#selProjectPeriodBegin').GWProjectPeriodSelector('setNullProjectPeriod');
                $('#selProjectPeriodEnd').GWProjectPeriodSelector('setNullProjectPeriod');
                dataListScModel.Title = '';
                dataListScModel.PublishOrgID = selectOrgId != 0 ? selectOrgId : 0;
                dataListScModel.PublishTimeStart = '';
                dataListScModel.PublishTimeEnd = '';
                dataListScModel.CooperativeOrgAnnualReturnBegin = '';
                dataListScModel.CooperativeOrgAnnualReturnEnd = '';
                dataListScModel.ProjectPeriodYearBegin = -1;
                dataListScModel.ProjectPeriodMonthBegin = -1;
                dataListScModel.ProjectPeriodYearEnd = -1;
                dataListScModel.ProjectPeriodMonthEnd = -1;
                dataListScModel.IsComplete = 0;
                $('.dataList button.operate').prop('disabled', true);
                $('.dataList').GWDataTable('load', dataListScModel);
            });

            $('#txtTitle').on('keydown', function (e) {
                if (e.keyCode === 13 && $(this).val().trim() != "") {
                    $("#btnSearch").click();
                }
            });
        }

        function initProjectInfoByIds() {
            if (selectedProjectStr) {
                $.ajax({
                    url: dataServiceBaseUrl + 'api/ProjectInfo/ProjectInfo/GetProjectInfoByIds?ids=' + selectedProjectStr + '&sid=' + sid,
                    type: 'get',
                    async: true,
                    cache: false,
                    success: function (result) {
                        selectedProjectArr = result.Data;
                        initDataList();
                    }
                });
            } else {
                selectedProjectArr = [];
                initDataList();
            }
        }

        // 初始化表格
        function initDataList() {
            var option = {
                tableTitle: '',
                tableIcon: true,
                checkbox: true,
                showLine: true,
                multiCheck: multiCheck,
                columns:
                [
                    {
                        title: '项目名称',
                        field: 'Title',
                        align: 'left',
                        formatter: function (value, rowData) {
                            return '<a href="../../ProjectInfo/Read.html#id=' + rowData.ID + '" target="_blank" title="' + value + '">' + (rowData.Status === 4 ? '（暂时关闭）' : '') + value + '</a>';
                        }
                    },
                    {
                        title: '发布单位',
                        field: 'PublishOrgName',
                        align: 'left',
                        width: '150',
                        formatter: function (value) {
                            return '<span title="' + value + '">' + value + '</span>';
                        }
                    },
                    {
                        title: '发布时间',
                        field: 'PublishTime',
                        align: 'center',
                        width: '100',
                        formatter: function (value) {
                            return new Date(value.replace(/-/g, '/')).Format('yyyy-MM-dd');
                        }
                    },
                    {
                        title: '预期你单位年化收益率',
                        field: 'CooperativeOrgAnnualReturn',
                        align: 'center',
                        width: '100',
                        formatter: function (value) {
                            if (value) {
                                return '<span>' + value + '%</span>';
                            } else {
                                return '<span>-</span>';
                            }
                        }
                    },
                    {
                        title: '预计项目周期',
                        align: 'center',
                        width: '110',
                        formatter: function (value, rowData) {
                            return '<span>' +
                                (rowData.ProjectPeriodYear > 0 ? rowData.ProjectPeriodYear + '年' : '') +
                                (rowData.ProjectPeriodMonth > 0 ? rowData.ProjectPeriodMonth + '个月' : '') +
                                '</span>';
                        }
                    },
                    {
                        title: '预期你单位回报获取周期',
                        field: 'CooperativeOrgReturnPeriod',
                        align: 'center',
                        width: '120',
                        formatter: function (value) {
                            if (value) {
                                return '<span>' + value + '</span>';
                            } else {
                                return '<span>-</span>';
                            }
                        }
                    },
                    {
                        title: '是否完结',
                        field: 'Status',
                        align: 'center',
                        width: '90',
                        formatter: function (value) {
                            if (value === 6) {
                                return '<span>已完结</span>';
                            } else {
                                return '<span>未完结</span>';
                            }
                        }
                    }
                ],
                dataUrl: dataServiceBaseUrl + 'api/ProjectInfo/ProjectInfo/GetProjectInfoBySC?sid=' + sid + '&t=' + new Date().getMilliseconds(),
                queryParams: function (pageNumber, pageSize) {
                    dataListScModel.PageNum = pageNumber;
                    dataListScModel.PageSize = pageSize;
                    return { scModel: dataListScModel };
                },
                pagination: true,
                pageSize: 4,
                onLoadSuccess: function (table) {
                    var rows = table.find('div[class=table-row]');
                    $.each(rows, function (index, element) {
                        var newRow = _.where(selectedProjectArr, { ProjectInfoID: $(element).data('id') });
                        if (newRow.length == 1) {
                            $('.dataList').GWDataTable('checkRow', index);
                        }
                    });
                    $(table).find('.table-content-container .table-body .Title a').each(function () {
                        var txtTitle = $('#txtTitle').val().trim();
                        if (txtTitle != '' && txtTitle != '+') {
                            var html = $(this).html().replace(new RegExp(txtTitle, 'gi'), '<label class="highlight">' + txtTitle + '</label>');
                            $(this).html(html);
                        }
                    });
                    refreshBadge();
                }
            };
            option.idField = 'ID';
            option.onRowCheck = function (rowIndex, rowData) {
                var newRow = _.where(selectedProjectArr, { ProjectInfoID: rowData.ID });
                if (newRow.length == 1) {

                } else {
                    if (multiCheck) {
                        selectedProjectArr.push({ ProjectInfoID: rowData.ID, ProjectInfoTitle: rowData.Title, PublishOrgID: rowData.PublishOrgID });
                    } else {
                        selectedProjectArr[0] = { ProjectInfoID: rowData.ID, ProjectInfoTitle: rowData.Title, PublishOrgID: rowData.PublishOrgID };
                    }
                    var row = $('.table-body').find('div[data-id=' + rowData.ID + ']').find('input[type=checkbox]');
                    flyingAnimate($(row), $('#flyingAdd'), $('#btnAffirmProjectToList'), refreshBadge);
                }
            };
            option.onRowUnCheck = function (rowIndex, rowData) {
                var newRow = _.where(selectedProjectArr, { ProjectInfoID: rowData.ID });
                if (newRow.length == 1) {
                    var unCheckRow;
                    $.each(selectedProjectArr, function (index, element) {
                        if (rowData.ID == element.ProjectInfoID) {
                            unCheckRow = index;
                        }
                    });
                    selectedProjectArr.splice(unCheckRow, 1);
                    var row = $('.table-body').find('div[data-id=' + rowData.ID + ']').find('input[type=checkbox]');
                    flyingAnimate($(row), $('#flyingSubduct'), $('#btnAffirmProjectToList'), refreshBadge);
                }
            };
            option.onRowCheckAll = function (rows) {
                if (multiCheck) {
                    $.each(rows, function (index, element) {
                        var newRow = _.where(selectedProjectArr, { ProjectInfoID: element.ID });
                        if (newRow.length != 1) {
                            selectedProjectArr.push({ ProjectInfoID: element.ID, ProjectInfoTitle: element.Title, PublishOrgID: rowData.PublishOrgID });
                        }
                    });
                    var checkAll = $('.dataList input[class=checkAll]');
                    flyingAnimate($(checkAll), $('#flyingAdd'), $('#btnAffirmProjectToList'), refreshBadge);
                }
            };
            option.onRowUnCheckAll = function (rows) {
                if (multiCheck) {
                    $.each(rows, function (index, element) {
                        var newRow = _.where(selectedProjectArr, { ProjectInfoID: element.ID });
                        if (newRow.length == 1) {
                            var unCheckRow;
                            $.each(selectedProjectArr, function (index, ele) {
                                if (element.ID == ele.ProjectInfoID) {
                                    unCheckRow = index;
                                }
                            });
                            selectedProjectArr.splice(unCheckRow, 1);
                        }
                    });
                    var checkAll = $('.dataList input[class=checkAll]');
                    flyingAnimate($(checkAll), $('#flyingSubduct'), $('#btnAffirmProjectToList'), refreshBadge);
                }
            };
            $('.dataList').GWDataTable(option);
        }

        // 刷新产品选择徽章计数
        function refreshBadge() {
            $('#candidateProjectNumBadge').text(selectedProjectArr.length);
            renewProductBox();
        }

        // 更新已选择条目输入框（人员选择）
        function renewProductBox() {
            $('#txtCooperativeItems').tagsinput('removeAll');
            if (selectedProjectArr && selectedProjectArr.length > 0) {
                $('.bootstrap-tagsinput input').val('');
                for (var i = 0; i < selectedProjectArr.length; i++) {
                    $('#txtCooperativeItems').tagsinput('add', selectedProjectArr[i]);
                }
            }
        }

        // 初始化归属项目选择框
        function initCooperativeProjectInput() {
            $('#txtCooperativeItems').tagsinput({
                itemValue: 'ProjectInfoID',
                itemText: 'ProjectInfoTitle',
                tagClass: function () {
                    return 'label label-info';
                }
            });

            $('#txtCooperativeItems').on('itemRemoved', function (event) {
                var row = $('.table-body').find('div[data-id=' + event.item.ProjectInfoID + ']');
                if (row.length == 1) {
                    $('.dataList').GWDataTable('uncheckRow', row.data('rowindex'));
                } else {
                    var unCheckRow;
                    $.each(selectedProjectArr, function (index, element) {
                        if (event.item.ProjectInfoID == element.ProjectInfoID) {
                            unCheckRow = index;
                        }
                    });
                    selectedProjectArr.splice(unCheckRow, 1);
                    refreshBadge();
                }
            });

            $('#txtCooperativeItems').prev().find('input').prop('readonly', true).css('width', 90);
        }

        // 初始化单位选择框
        function initPublishOrgSelector() {
            if (selectOrgId != '') {
                $('#selPublishOrg').prop('readonly', 'readonly');
                $('#selPublishOrg').css('display', 'table-cell');
                $('#selPublishOrg').css('padding-left', '12px');

                $.ajax({
                    url: dataServiceBaseUrl + 'api/UserOrg/Org/GetOrganizeInfoByOrgID?orgId=' + selectOrgId + '&sid=' + sid,
                    type: 'get',
                    async: true,
                    cache: false,
                    success: function (result) {
                        if (result && result.Success === true && result.Data) {
                            $('#selPublishOrg').html(result.Data.Name);
                        }
                    }
                });
            } else {
                $('#selPublishOrg').GWSelectOrg({
                    dataUrl: dataServiceBaseUrl + 'api/UserOrg/Org/GetOrgDeptList?sid=' + sid,
                    singleSelect: false,
                    onDataLoadCompleted: function () {

                    }
                });
            }
            $('#btnSearch,#btnReset').prop('disabled', false);
        }

        function getSelectedProjectArr() {
            return selectedProjectArr;
        }

        // 初始化时间选择
        function initDateSelecter() {
            var option = {
                language: 'zh-CN',
                weekStart: 1,
                todayBtn: 1,
                todayHighlight: 1,
                startView: 2,
                minView: 2,
                autoclose: 1,
                format: 'yyyy-mm-dd',
                forceParse: true,
                pickerPosition: "bottom-right"
            }
            $('#txtPublishTimeStart').datetimepicker(option);
            $('#txtPublishTimeEnd').datetimepicker(option);
        }

        // 加减动作动画
        function flyingAnimate(ev, thingFly, flyToDom, callback) {
            var $offset = $(ev).offset();
            var $offsetfavbar = $(flyToDom).offset();
            $(thingFly).css('left', $offset.left + 'px');
            $(thingFly).css('top', $offset.top + 'px');
            $(thingFly).animate({
                left: ($offsetfavbar.left + 30) + "px",
                top: ($offsetfavbar.top - 10) + "px",
                opacity: "0.8",
                fontSize: "24px"
            }, 500, function () {
                $(thingFly).css({
                    left: "-1000px",
                    top: "-100px",
                    opacity: "1",
                    fontSize: "50px"
                });
                callback();
            });
        }

        function bindEvent() {
            $('#btnCloseModal').on('click', function () {
                $('#btnCloseProjectInfoSelectModal', parent.document).click();
                return false;
            });

            $('#btn_clear').on('click', function () {
                selectedProjectArr.length = 0;
                $('.dataList').GWDataTable('uncheckAll');
                refreshBadge();
                return false;
            });

            $('#btnAffirmProjectToList').on('click', function () {
                parent.addProjectToList();
                return false;
            });
        }
    </script>
</body>
</html>
