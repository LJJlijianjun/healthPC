<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>用户注册信息审核</title>
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/lightbox2/dist/css/lightbox.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />
</head>
<body>
    <div class="fileInfo-publishView">
        <div class="container-fluid">
            <div class="row processToolBar" style="padding-left:15px">
                <div class="col-xs-6 textLeft" >
                    <!--<div class="alert alert-danger formTip">
                        <span class="fa fa-info-circle"></span>
                        <span>红色标识字段为必填项！</span>
                    </div>-->
                    <span id="spTitle" style="line-height:35px;">用户注册信息审核</span>
                </div>
                <div class="col-xs-6 textRight">
                    <div class="btn-group processButtonGroup">
                        <button type="button" class="btn btn-default" id="btnGoBack_0" name="btnGoBack"><span class="fa fa-mail-reply"></span>&nbsp;返回</button>
                        <button type="button" class="btn btn-default" id="btnComplete_0" name="btnComplete"><span class="fa fa-check"></span>&nbsp;审核通过</button>
                        <button type="button" class="btn btn-default" id="btnRefuse_0" name="btnRefuse"><span class="fa fa-trash-o"></span>&nbsp;未通过</button>
                    </div>
                </div>
            </div>

            <!--咨询基本信息-->
            <div class="panel panel-default mt10">
                <div class="panel-heading">
                    <div class="panel-title">
                        基本信息
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row mt10">
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">用户名</span>
                                <input class="form-control" id="txtAccount" name="txtAccount" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">真实姓名</span>
                                <input class="form-control" id="txtUserName" name="txtUserName" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">公司名称</span>
                                <input class="form-control" id="txtCompanyName" name="txtCompanyName" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">所在部门</span>
                                <input class="form-control" id="txtDepartment" name="txtDepartment" type="text" readonly="readonly" />
                            </div>
                        </div>
                    </div>
                    <div class="row mt10">
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">身份证</span>
                                <input class="form-control" id="txtIDCard" name="txtIDCard" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">职&emsp;位&emsp;</span>
                                <input class="form-control" id="txtPosition" name="txtPosition" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">固&emsp;话&emsp;</span>
                                <input class="form-control" id="txtTelephone" name="txtTelephone" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">手&emsp;机</span>
                                <input class="form-control" id="txtUserPhone" name="txtUserPhone" type="text" readonly="readonly" />
                            </div>
                        </div>
                    </div>
                    <div class="row mt10">
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">电子邮箱</span>
                                <input class="form-control" id="txtUserEmail" name="txtUserEmail" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">注册时间</span>
                                <input class="form-control" id="txtCreateTime" name="txtCreateTime" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">推荐人</span>
                                <input class="form-control" id="txtRecommender" name="txtRecommender" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">推荐机构</span>
                                <input class="form-control" id="txtRecommendOrg" name="txtRecommendOrg" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <!--<div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">风险测评</span>
                                <input class="form-control" id="txtEvaluation" name="txtEvaluation" type="text" readonly="readonly" />
                            </div>
                        </div>-->
                    </div>
                </div>
            </div>
            <div class="panel panel-default mt10">
                <div class="panel-heading">
                    <div class="panel-title">
                        用户名片（点击大图）
                    </div>
                </div>
                <div class="panel-body">
                    <div id="Card" style="width:400px;height:250px; margin:0 auto; text-align:center; line-height:250px;">
                        <img style="max-width:100%;max-height:100%"/>
                    </div>
                </div>
            </div>
            <div class="row processMessage mt10">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="panel panel-default mb0">
                        <div class="panel-heading">
                            <div class="panel-title">
                                审批意见
                                <a id="btnSelectApproveWords" style="display:inline">常用词</a>
                            </div>
                        </div>
                        <div class="panel-body">
                            <!--<table class="table table-bordered table-condensed none">
                                <thead>
                                    <tr>
                                        <th class="w200">步骤名称</th>
                                        <th class="w150">审批人</th>
                                        <th class="w150">审批时间</th>
                                        <th>审批意见</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>-->
                            <form id="formMessage">
                                <div class="input-group">
                                    <span class="input-group-addon required">审批意见：</span>
                                    <textarea class="form-control" id="txtMessage" name="txtMessage" data-popover-placement="top" rows="3" maxlength="200" placeholder="输入您的审批意见"></textarea>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div style="margin-top:10px; margin-bottom: 15px " class="col-xs-12 textRight">
                <div class="btn-group processButtonGroup">
                    <button type="button" class="btn btn-default" id="btnGoBack_1" name="btnGoBack"><span class="fa fa-mail-reply"></span>&nbsp;返回</button>
                    <button type="button" class="btn btn-default" id="btnComplete_1" name="btnComplete"><span class="fa fa-check"></span>&nbsp;审核通过</button>
                    <button type="button" class="btn btn-default" id="btnRefuse_1" name="btnRefuse"><span class="fa fa-trash-o"></span>&nbsp;未通过</button>
                </div>
            </div>
        </div>
        <input type="hidden" id="hidCustomerInfoId" />
        <a id="totop" href="#" title="回到顶部"><i class="fa fa-angle-up"></i></a>
        <!--审批常用词模态框-->
        <div class="modal fade" id="approveWordSelectModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" id="approveWordsDialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <button type="button" class="close none" id="btnCloseApproveWordSelectModal" data-dismiss="modal" aria-hidden="true" title="关闭">&times;</button>
                        <iframe id="frameApproveWordSelector" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>
        <!--大图模态框-->
        <div class="modal fade" id="IDCardModal" tabindex="-1" role="dialog" aria-labelledby="IDCardModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width:800px; height:450px;margin-top:60px;">
                <div class="modal-content">
                    <div class="modal-body" style="width:100%;height:450px; text-align:center; line-height:420px;">
                        <button class="close" style="position:absolute;top:0;right:3px" data-dismiss="modal" type="button" aria-hidden="true" title="关闭">&times;</button>
                        <img style="max-width:100%; max-height:100%"/>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--[if lt IE 9]>
    <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <script src="../../assets/vendors/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="../../assets/js/jquery-tools-min.js" type="text/javascript"></script>
    <script src="../../assets/js/config.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/js/auth.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../assets/js/common.min.js?v=1.0.3" type="text/javascript"></script>
    <!--<script src="../../assets/js/workFlow.js?v=1.0.2" type="text/javascript"></script>-->
    <script src="../../assets/vendors/underscore/underscore-min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/blueimp-tmpl/js/tmpl.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/xss/dist/xss.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/jquery-validation/dist/jquery.validate.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/jquery-validation/src/localization/messages_zh.js"></script>
    <script src="../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script src="../../assets/vendors/lightbox2/dist/js/lightbox.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/platform.js/platform.js" type="text/javascript"></script>
    <script src="../../assets/vendors/bootbox.js/bootbox.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            AuthUtility.Auth(function () {
                //注册审核
                if (!$.url().param("Status")) {
                    initValidator();

                } else { //机构变更
                    //$('#btnComplete').html('<span class="fa fa-check"></span>&nbsp;审核通过');
                    //$('#btn_Approve').removeClass('hidden');
                    $('#spTitle').html('机构变更审核');
                    $('.processMessage').addClass('hidden');
                    
                }
                bindEvent();
                bindtop();
                loadForm();
            });
        });

        function bindtop() {
            // 回到顶部功能
            $(window).scroll(function () {
                if ($(this).scrollTop() < 100) {
                    $('#totop').fadeOut();
                } else {
                    $('#totop').fadeIn();
                }
            });
            $('#totop').on('click', function () {
                $('html,body').animate({ scrollTop: 0 }, 'fast');
                return false;
            });

            // 常用词选择
            $('#btnSelectApproveWords').on('click', function () {
                openApproveWordSelector();
                return false;
            });

        }

        function showIDCardModal() {
            $('#Card img').click(function () {
                $('#IDCardModal').modal({ backdrop: 'static', keyboard: false });
            });
        }

        // 打开审批意见选择框
        function openApproveWordSelector() {
            $('#frameApproveWordSelector').attr('src', '../Common/Selector/ApproveWordSelector.html');
            $('#approveWordSelectModal').modal();
        }

        // 选择审批意见
        function addApproveCommonWord() {
            var selectedApproveCommonWords = document.getElementById('frameApproveWordSelector').contentWindow.getCommonWord();
            $('#btnCloseApproveWordSelectModal').click();
            $('#txtMessage').focus().val(selectedApproveCommonWords);
        }

        // 初始化工作流
        //function initWorkFlow() {
        //    $(document).Workflow('ProcessInfo', {
        //        Btn: {
        //            Complete: function () {
        //                checkForm(function () {
        //                    publishCustomerInfo(function () {
        //                        WorkflowAction.Complete();
        //                    });
        //                });
        //            },
        //            Refuse: function () {
        //                checkForm(function () {
        //                    refuseCustomerInfo(function () {
        //                        WorkflowAction.Complete();
        //                    });
        //                });
        //            }
        //        }
        //    });
        //}

        // 检查表单
        function checkForm(callback) {
            if ($('#formMessage').valid()) {
                callback();
            }
        }

        // 初始化表单验证控件
        function initValidator() {
            $.validator.addMethod("antiSqlInject", function (value, element, params) {
                if (value) {
                    return !AntiSqlInject($(element).val());
                } else {
                    return true;
                }
            }, "输入内容中包含非法字符！");

            $('#formMessage').validate({
                rules: {
                    txtMessage: { required: true, antiSqlInject: true }
                },
                messages: {
                    txtMessage: { required: '审批意见不能为空！' }
                },
                showErrors: jqValidationShowErrors
            });
        }

        // 绑定事件
        function bindEvent() {
            $('button[name="btnGoBack"]').click(function () {
                window.history.back(-1);
            })

            $('button[name="btnComplete"]').click(function () {
                if ($.url().param("Status")) {
                    ApproveCustomerInfo();
                } else {
                    checkForm(function () {
                        publishCustomerInfo();
                    });
                }
            });

            $('button[name="btnRefuse"]').click(function () {
                if ($.url().param("Status")) {
                    refuseCustomerInfo();
                } else {
                    checkForm(function () {
                        refuseCustomerInfo();
                    });
                }
            })
        }

        // 加载表单
        function loadForm() {
            $.ajax({
                url: dataServiceBaseUrl + 'api/CustomInfo/CustomInfo/GetCustomInfoByID?sid=' + sid,
                type: 'get',
                data: {
                    CustomInfoID: $.url().param("CustomInfoID").trim()
                },
                async: true,
                cache: false,
                dataType: 'json',
                success: function (data) {
                    $('#hidCustomerInfoId').val(data.Data.ID);
                    $('#txtAccount').val(data.Data.CustomerCode);
                    $('#txtUserName').val(data.Data.CustomerName);
                    $('#txtCompanyName').val(data.Data.EnterpriseName);
                    $('#txtDepartment').val(data.Data.Department);
                    $('#txtIDCard').val(data.Data.CustomerCardID);
                    $('#txtPosition').val(data.Data.Position);
                    $('#txtTelephone').val(data.Data.FixedTelephone);
                    $('#txtUserPhone').val(data.Data.MobileTelephone);
                    $('#txtUserEmail').val(data.Data.CustomerEmail);
                    $('#txtCreateTime').val(data.Data.CreateTime);
                    $('#txtRecommender').val(data.Data.Recommender);
                    $('#txtRecommendOrg').val(data.Data.RecommendOrg);
                    //$('#txtEvaluation').val(data.Data.Evaluation === '' ? '未进行测评' : data.Data.Evaluation);
                    //图片
                    if (data.Data.FileName) {
                        $('#Card img').attr('src', dataServiceBaseUrl + 'api/Common/FileManage?sid=' + sid + '&path=' + encodeURIComponent(data.Data.FilePath +'/'+ data.Data.FileName));
                        $('#IDCardModal img').attr('src', dataServiceBaseUrl + 'api/Common/FileManage?sid=' + sid + '&path=' + encodeURIComponent(data.Data.FilePath + '/' + data.Data.FileName));
                        showIDCardModal();
                    } else {
                        $('#Card img').attr('src', '../../assets/img/clock.png');
                    }
                }
            });
        }

        // 注册用户审核通过
        function publishCustomerInfo(callback) {
            bootbox.confirm({
                message: '将要通过用户注册，是否继续？',
                callback: function (result) {
                    if (result === true) {
                        $.ajax({
                            url: dataServiceBaseUrl + 'api/CustomInfo/CustomInfo/ApproveCustomInfo?sid=' + sid + '&CustomInfoID=' + $('#hidCustomerInfoId').val().trim() + '&ApproveMessage=' + encodeURIComponent($('#txtMessage').val().trim()),
                            type: 'patch',
                            beforeSend: function () {
                                //$('body').loadingUI({ text: '正在审核，请稍候...' });
                            },
                            async: false,
                            cache: false,
                            dataType: 'json',
                            success: function (data) {
                                if (data && data.Success === true) {
                                    bootbox.alert({
                                        message: '审核通过！', callback: function () {
                                            parent.getApproveCustomerToDoCount();
                                            window.history.back(-1);
                                        }
                                    });
                                } else {
                                    bootbox.alert({ message: '审核失败！' });
                                    //$('body').loadingUI('hide');
                                }
                            },
                            error: function () {
                                bootbox.alert({ message: '审核失败！' });
                                //$('body').loadingUI('hide');
                            }
                        });
                    }
                }
            });
        }

        function ApproveCustomerInfo() {
            // 用户变更信息审核
            bootbox.confirm({
                message: '将要通过用户机构变更，是否继续？',
                callback: function (result) {
                    if (result === true) {
                        $.ajax({
                            url: dataServiceBaseUrl + 'api/CustomInfo/CustomInfo/ApproveEnterpriseOfCustomInfo?sid=' + sid + '&CustomInfoID=' + $('#hidCustomerInfoId').val().trim(),
                            type: 'patch',
                            beforeSend: function () {
                                //$('body').loadingUI({ text: '正在审核，请稍候...' });
                            },
                            async: false,
                            cache: false,
                            dataType: 'json',
                            success: function (data) {
                                if (data && data.Success === true) {
                                    bootbox.alert({
                                        message: '审核通过！', callback: function () {
                                            parent.getApproveCustomerToDoCount();
                                            window.history.back(-1);
                                        }
                                    });
                                } 
                            },
                            error: function () {
                                bootbox.alert({ message: '审核失败！' });
                                //$('body').loadingUI('hide');
                            }
                        });
                    }
                }
            });
        }

        // 注册用户审核不通过
        function refuseCustomerInfo() {
            bootbox.confirm({
                message: '审核不通过用户将无法登录，是否继续？',
                callback: function (result) {
                    if (result === true) {
                        $.ajax({
                            url: dataServiceBaseUrl + 'api/CustomInfo/CustomInfo?sid=' + sid + '&CustomInfoID=' + $('#hidCustomerInfoId').val().trim() + '&ApproveMessage=' + encodeURIComponent($('#txtMessage').val().trim()),
                            type: 'delete',
                            beforeSend: function () {
                                //$('body').loadingUI({ text: '正在审核，请稍候...' });
                            },
                            async: false,
                            cache: false,
                            dataType: 'json',
                            success: function (data) {
                                if (data && data.Success === true) {
                                    bootbox.alert({
                                        message: '处理成功！', callback: function () {
                                            parent.getApproveCustomerToDoCount();
                                            window.history.back(-1);
                                        }
                                    });
                                } 
                            },
                            error: function () {
                                bootbox.alert({ message: '审核失败！' });
                                //$('body').loadingUI('hide');
                            }
                        });
                    }
                }
            });
        }
    </script>
</body>
</html>
