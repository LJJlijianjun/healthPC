<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>用户咨询信息处理</title>
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/lightbox2/dist/css/lightbox.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />
</head>
<body>
    <div class="projectInfo-publishView">
        <div class="container-fluid">
            <div class="row processInfo">
                <div class="col-xs-6 pl10 textLeft">
                    <span>当前操作：</span>
                    <span class="process-currentTask"></span>
                </div>
                <div class="col-xs-6 pr10 textRight">
                    <a class="process-detail" href="#">流转明细及回退意见</a>&nbsp;&nbsp;
                    <!--<a class="process-picture" data-lightbox="processPic" data-title="流程图示" href="#">流程图示</a>-->
                </div>
                <div class="col-xs-12 pl10 textLeft">
                    <span class="process-backReasonDesc"></span>
                    <span class="process-backReason"></span>
                </div>
            </div>

            <div class="row processToolBar">
                <div class="col-xs-6 textLeft">
                    <div class="alert alert-danger formTip">
                        <span class="fa fa-info-circle"></span>
                        <span>红色标识字段为必填项！</span>
                    </div>
                </div>
                <div class="col-xs-6 textRight">
                    <div class="btn-group processButtonGroup">
                    </div>
                </div>
            </div>

            <!--咨询基本信息-->
            <div class="panel panel-default mt10">
                <div class="panel-heading">
                    <div class="panel-title">
                        用户咨询基本信息
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">咨询产品名称</span>
                                <input class="form-control" id="txtTitle" name="txtTitle" type="text" style="text-decoration: underline; color:blue; cursor:pointer " readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">产品代码</span>
                                <input class="form-control" id="txtCode" name="txtCode" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">咨询用户</span>
                                <input class="form-control" id="txtUserName" name="txtUserName" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="input-group">
                                <span class="input-group-addon">用户邮箱</span>
                                <input class="form-control" id="txtEmail" name="txtEmail" type="text" readonly="readonly" />
                            </div>
                        </div>
                    </div>
                    <div class="row mt10">
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">用户公司</span>
                                <input class="form-control" id="txtCompanyName" name="txtCompanyName" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">座机</span>
                                <input class="form-control" id="txtTelephone" name="txtTelephone" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">手机</span>
                                <input class="form-control" id="txtUserPhone" name="txtUserPhone" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <div class="input-group">
                                <span class="input-group-addon">咨询时间</span>
                                <input class="form-control" id="txtCreateTime" name="txtCreateTime" type="text" readonly="readonly" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt10">
                <div class="col-xs-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title">产品经理联系方式</div>
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-xs-3 pr10">
                                    <div class="input-group">
                                        <span class="input-group-addon">联系人</span>
                                        <input class="form-control" id="txtContactsName" name="txtContactsName" type="text" readonly="readonly" />
                                    </div>
                                </div>
                                <div class="col-xs-3 pr10">
                                    <div class="input-group">
                                        <span class="input-group-addon">电话</span>
                                        <input class="form-control" id="txtContactsFixedTel" name="txtContactsFixedTel" type="text" readonly="readonly" />
                                    </div>
                                </div>
                                <div class="col-xs-3 pr10">
                                    <div class="input-group">
                                        <span class="input-group-addon minWidth64">手机</span>
                                        <input class="form-control" id="txtContactsMobileTel" name="txtContactsMobileTel" type="text" readonly="readonly" />
                                    </div>
                                </div>
                                <div class="col-xs-3">
                                    <div class="input-group">
                                        <span class="input-group-addon minWidth64">邮箱</span>
                                        <input class="form-control" id="txtContactsEmail" name="txtContactsEmail" type="text" readonly="readonly" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel panel-default mt10">
                <div class="panel-heading">
                    <div class="panel-title">
                        咨询内容
                    </div>
                </div>
                <div class="panel-body">
                    <div id="consultContent">

                    </div>
                    <!--<textarea style="width:100%; height:150px;" id="consultContent" readonly="readonly"></textarea>-->
                </div>
            </div>

            <div class="row processMessage mt10">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="panel panel-default mb0">
                        <div class="panel-heading">
                            <div class="panel-title">
                                审批意见
                                <a id="btnSelectApproveWords" style="display:inline">常用词</a>
                            </div>
                        </div>
                        <div class="panel-body">
                            <table class="table table-bordered table-condensed none">
                                <thead>
                                    <tr>
                                        <th class="w200">步骤名称</th>
                                        <th class="w150">审批人</th>
                                        <th class="w150">审批时间</th>
                                        <th>审批意见</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <form id="formWorkFlowMessage">
                                <div class="input-group">
                                    <span class="input-group-addon required">审批意见：</span>
                                    <textarea class="form-control workFlowMessage" id="txtWorkFlowMessage" name="txtWorkFlowMessage" data-popover-placement="top" rows="3" maxlength="200" placeholder="输入您的审批意见"></textarea>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row processToolBar">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 textRight">
                    <div class="btn-group processButtonGroup">
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" id="hidPublishOrgID" value="0"/>
        <input type="hidden" id="consultInfoID" />
        <input type="hidden" id="ProductInfoID" />
        <a id="totop" href="#" title="回到顶部"><i class="fa fa-angle-up"></i></a>
        <!--审批常用词模态框-->
        <div class="modal fade" id="approveWordSelectModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" id="approveWordsDialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <button type="button" class="close none" id="btnCloseApproveWordSelectModal" data-dismiss="modal" aria-hidden="true" title="关闭">&times;</button>
                        <iframe id="frameApproveWordSelector" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--[if lt IE 9]>
        <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
        <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <script src="../../assets/vendors/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="../../assets/js/jquery-tools-min.js" type="text/javascript"></script>
    <script src="../../assets/js/config.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/js/auth.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../assets/js/common.min.js?v=1.0.3" type="text/javascript"></script>
    <script src="../../assets/js/workFlow.js?v=1.0.2" type="text/javascript"></script>
    <script src="../../assets/vendors/underscore/underscore-min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/blueimp-tmpl/js/tmpl.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/xss/dist/xss.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/jquery-validation/dist/jquery.validate.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/jquery-validation/src/localization/messages_zh.js"></script>
    <script src="../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script src="../../assets/vendors/lightbox2/dist/js/lightbox.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/platform.js/platform.js" type="text/javascript"></script>
    <script src="../../assets/vendors/bootbox.js/bootbox.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            AuthUtility.Auth(function () {
                
                initWorkFlow();
                initValidator();
                bindEvent();
                loadForm();
                //initLightBox
            });
        });

         //初始化表单验证控件
        function initValidator() {
            $.validator.addMethod("antiSqlInject", function (value, element, params) {
                if (value) {
                    return !AntiSqlInject($(element).val());
                } else {
                    return true;
                }
            }, "输入内容中包含非法字符！");

            $('#formWorkFlowMessage').validate({
                rules: {
                    txtWorkFlowMessage: { required: true, antiSqlInject: true }
                },
                messages: {
                    txtWorkFlowMessage: { required: '审批意见不能为空！' }
                },
                showErrors: jqValidationShowErrors
            });
        }

        // 初始化工作流
        function initWorkFlow() {
            $(document).Workflow('ProcessInfo', {
                Btn: {
                    Next: function () {
                        checkForm(function () {
                            WorkflowAction.Next();
                        });
                    },
                    Complete: function () {
                        checkForm(function () {
                            publishConsultInfo(function () {
                                WorkflowAction.Complete();
                            });
                        });
                    }
                }
            });
        }

        // 绑定事件
        function bindEvent() {

            // 回到顶部功能
            $(window).scroll(function () {
                if ($(this).scrollTop() < 100) {
                    $('#totop').fadeOut();
                } else {
                    $('#totop').fadeIn();
                }
            });
            $('#totop').on('click', function () {
                $('html,body').animate({ scrollTop: 0 }, 'fast');
                return false;
            });

             //常用词选择
            $('#btnSelectApproveWords').on('click', function () {
                openApproveWordSelector();
                return false;
            });

            //产品链接
            $('#txtTitle').on('click', function () {
                var id = $('#ProductInfoID').val();
                //location.open = "../Productinfo/Read.html#id=" + id + "";
                window.open(" ../Productinfo/Read.html#id=" + id );
            });

        }

        // 加载数据
        function loadForm() {
            var url;
            var data;
            if ($.url().param("ConsultInfoID")) {
                url = dataServiceBaseUrl + 'api/ConsultInfo/ConsultInfo/GetConsultInfoByID?sid=' + sid;
                data = { ConsultInfoID: $.url().param("ConsultInfoID").trim()};
            } else {
                url = dataServiceBaseUrl + 'api/ConsultInfo/ConsultInfo/GetConsultInfoByProcessID?sid=' + sid;;
                data = { ProcessID:$.url().param("processId").trim()};
            }
            $.ajax({
                url: url,
                type: 'get',
                data: data,
                async: true,
                cache: false,
                dataType: 'json',
                success: function (data) {
                    $('#consultInfoID').val(data.Data.ID);
                    $('#ProductInfoID').val(data.Data.ProductInfoID);
                    $('#txtTitle').val(data.Data.Title);
                    //$('#txtTitle').attr('<a href="#" title="' + data.Data.Title + '">');
                    $('#txtCode').val(data.Data.Code);
                    $('#txtUserName').val(data.Data.CustomerName);
                    $('#txtCompanyName').val(data.Data.EnterpriseName);
                    $('#txtTelephone').val(data.Data.FixedTelephone);
                    $('#txtUserPhone').val(data.Data.MobileTelephone);
                    $('#txtCreateTime').val(data.Data.CreateTime);
                    $('#txtEmail').val(data.Data.CustomerEmail);
                    $('#consultContent').text(data.Data.ConsultContent);
                    $('#consultStatus').text(data.Data.Status);
                    $('#txtContactsName').val(data.Data.ContactsName);
                    $('#txtContactsMobileTel').val(data.Data.ContactsMobileTel);
                    $('#txtContactsFixedTel').val(data.Data.ContactsFixedTel);
                    $('#txtContactsEmail').val(data.Data.ContactsEmail);
                }
            });
        }

        // 检查表单
        function checkForm(callback) {
            if ($('#formWorkFlowMessage').valid()) {
                if ($.url().param("ConsultInfoID")) {
                    saveConsultInfo(callback);
                } else {
                    callback();
                }
            }
        }

        function saveConsultInfo(callback) {
            $.ajax({
                url: dataServiceBaseUrl + 'api/ConsultInfo/ConsultInfo/UpdateProcessIDOfConsultInfo?sid=' + sid + '&ProcessID=' + $.url().param("processId").trim() + '&ConsultInfoID=' + $.url().param("ConsultInfoID").trim(),
                type: 'patch',
                async: true,
                cache: false,
                dataType: 'json',
                success: function (data) {
                    if (data.Data == 0) {
                        callback();
                    }
                }
            });
        }

        function publishConsultInfo(callback) {
            $.ajax({
                url: dataServiceBaseUrl + 'api/ConsultInfo/ConsultInfo/PublishConsultInfo?sid=' + sid + '&ConsultInfoID=' + $('#consultInfoID').val().trim(),
                type: 'patch',
                async: true,
                cache: false,
                dataType: 'json',
                success: function (data) {
                    callback();
                }
            });
        }

        // 打开审批意见选择框
        function openApproveWordSelector() {
            $('#frameApproveWordSelector').attr('src', '../Common/Selector/ApproveWordSelector.html');
            $('#approveWordSelectModal').modal();
        }

        // 选择审批意见
        function addApproveCommonWord() {
            var selectedApproveCommonWords = document.getElementById('frameApproveWordSelector').contentWindow.getCommonWord();
            $('#btnCloseApproveWordSelectModal').click();
            $('#txtWorkFlowMessage').focus().val(selectedApproveCommonWords);
        }

    </script>
</body>
</html>
