<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>案例库信息</title>
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/lightbox2/dist/css/lightbox.min.css" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=0.1." rel="stylesheet" />
    <link href="../../assets/css/page.min.css?v=0.1." rel="stylesheet" />
</head>
<body>
    <div class="caseInfo-publishView">
        <div class="container-fluid">
            <div class="row processInfo">
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 pl10 textLeft">
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 pr10 textRight">
                    <a class="process-detail" href="#">流转明细及回退意见</a>&nbsp;&nbsp;
                    <!--<a class="process-picture" data-lightbox="processPic" data-title="流程图示" href="#">流程图示</a>-->
                </div>
            </div>

            <div class="row processToolBar none">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 textRight">
                    <div class="btn-group processButtonGroup">
                    </div>
                </div>
            </div>
            <div class="row mt10">
                <div class="col-xs-6 pr15">
                    <div class="input-group">
                        <span class="input-group-addon required">成交情况标题</span>
                        <input class="form-control" id="txtTitle" name="txtTitle" data-popover-placement="bottom" type="text" maxlength="500" placeholder="" value="十月成交情况" readonly="readonly" />
                    </div>
                </div>

            </div>
            <div class="panel panel-default mt10">
                <div class="panel-heading" style="padding:2px 15px;">
                    <div class="panel-title">
                        <div class="row">
                            <div class="col-xs-12" style="line-height:35px;">成交情况编辑</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <table class="table table-bordered" id="tblTrade">
                            <tr>
                                <td style="width:25%">
                                    <div class="input-group">
                                        <span class="input-group-addon">产品</span>
                                        <input class="form-control" type="text" name="txtProduct" readonly="readonly"/>
                                    </div>
                                </td>
                                <td style="width:25%">
                                    <div class="input-group">
                                        <span class="input-group-addon">成交对手方</span>
                                        <input class="form-control" type="text" name="txtUser" readonly="readonly" />
                                    </div>
                                </td>
                                <td style="width:25%">
                                    <div class="input-group">
                                        <span class="input-group-addon">成交金额</span>
                                        <input type="text" class="form-control" name="txtVolume" readonly="readonly"/>
                                    </div>
                                </td>
                                <td style="width:25%">
                                    <div class="input-group">
                                        <span class="input-group-addon">成交时间</span>
                                        <input class="form-control" type="text" name="txtTradeTime" readonly="readonly" />
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="row processMessage mt10">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="panel panel-default mb0">
                        <div class="panel-heading">
                            <div class="panel-title">审批意见</div>
                        </div>
                        <div class="panel-body">
                            <table class="table table-bordered table-condensed none">
                                <thead>
                                    <tr>
                                        <th class="w200">步骤名称</th>
                                        <th class="w150">审批人</th>
                                        <th class="w150">审批时间</th>
                                        <th>审批意见</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <a id="totop" href="#" title="回到顶部"><i class="fa fa-angle-up"></i></a>
        <iframe class="w1 h1 none" id="hidFileFrame"></iframe>
    </div>
    <!--[if lt IE 9]>
    <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <script src="../../assets/vendors/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="../../assets/js/jquery-tools-min.js" type="text/javascript"></script>
    <script src="../../assets/js/config.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/js/auth.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../assets/js/common.min.js?v=1.0.3" type="text/javascript"></script>
    <script src="../../assets/js/workFlow.min.js?v=1.0.2" type="text/javascript"></script>
    <script src="../../assets/vendors/underscore/underscore-min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/blueimp-tmpl/js/tmpl.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/bootbox.js/bootbox.js" type="text/javascript"></script>
    <script src="../../assets/vendors/lightbox2/dist/js/lightbox.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            AuthUtility.Auth(function () {
                initWorkFlow();
                bindEvent();
                loadForm();
                initLightBox();
            });
        });

        // 初始化工作流
        function initWorkFlow() {
            WorkflowEngine.InstanceCanRollBack();
            WorkflowEngine.GetMessage();
        }

        // 绑定事件
        function bindEvent() {
            // 回到顶部功能
            $(window).scroll(function () {
                if ($(this).scrollTop() < 100) {
                    $('#totop').fadeOut();
                } else {
                    $('#totop').fadeIn();
                }
            });
            $('#totop').on('click', function () {
                $('html,body').animate({ scrollTop: 0 }, 'fast');
                return false;
            });
        }

        // 加载表单
        function loadForm() {
            $.ajax({
                url: dataServiceBaseUrl + 'api/TradeInfo/TradeInfo/GetTradeInfoByProcessId?sid=' + sid,
                type: 'get',
                data: {
                    processId: $.url().param("processId").trim()
                },
                async: true,
                cache: false,
                dataType: 'json',
                success: function (data) {
                    if (data && data.Success === true && data.Data.TradeInfoList.length > 0) {
                        $('#hidPublishOrgID').val(data.Data.PublishOrgID);
                        $.each(data.Data.TradeInfoList, function (row, obj) {
                            if (row !== 0) {
                                addRow();
                            } else {
                                $('#txtTitle').val(obj.Title);
                            }
                            $("#tblTrade").find("tr").eq(row).find("input[name=txtTradeInfoID]").val(obj.ID);
                            var productDom = $("#tblTrade").find("tr").eq(row).find("input[name=txtProduct]");
                            productDom.data('id', obj.ProductInfoID);
                            productDom.val(obj.ProductName);
                            var userDom = $("#tblTrade").find("tr").eq(row).find("input[name=txtUser]");
                            userDom.data('id', obj.CustomerUserID);
                            userDom.val(obj.CustomerName);
                            $("#tblTrade").find("tr").eq(row).find("input[name=txtVolume]").val(obj.TradeAmount);
                            $("#tblTrade").find("tr").eq(row).find("input[name=txtTradeTime]").val(obj.TradeTime);
                        });
                    } else {
                        bootbox.alert({ message: '加载失败！' });
                    }
                },
                error: function () {
                    bootbox.alert({ message: '加载失败！' });
                }
            });
        }

        function addRow() {
            var rowStr = '';
            rowStr += '<tr><td style="width:25%"><div class="input-group"><span class="input-group-addon">产品</span>';
            rowStr += '<input class="form-control" type="text" name="txtProduct" readonly="readonly"/>';

            rowStr += '<td style="width:25%"><div class="input-group"><span class="input-group-addon">成交对手方</span>';
            rowStr += '<input class="form-control" type="text" name="txtUser" readonly="readonly"/>';

            rowStr += '<td style="width:25%"><div class="input-group"><span class="input-group-addon">成交金额</span>';
            rowStr += '<input type="text" class="form-control" name="txtVolume" readonly="readonly"/></div></td>';

            rowStr += '<td style="width:25%"><div class="input-group"><span class="input-group-addon">成交时间</span>';
            rowStr += '<input class="form-control" type="text" name="txtTradeTime" readonly="readonly"/></div></td></tr>';

            $('#tblTrade').append(rowStr);
        }

        // 绑定文件信息
        function bindFileInfo(containerId, documentType, data) {
            var $container = $('#' + containerId);

            // 绑定数据
            if (data && data.files.length > 0) {
                var tempData = _.where(data.files, { DocumentType: documentType });
                if (containerId === 'formMainDoc' && tempData && tempData.length > 0) {
                    tempData = _.where(tempData, { Type: 'pdf' });
                }
                if (tempData && tempData.length > 0) {
                    var docData = { files: tempData };

                    $container.find('tbody.files').html(tmpl(document.getElementById('common-template-show').innerHTML.trim(), docData));

                    $container.on('click', 'tbody.files button.download', function () {
                        return downLoadFile(this);
                    });

                    $container.on('click', 'tbody.files button.delete', function () {
                        var $row = $(this);
                        $.ajax({
                            url: $row.data('deleteurl'),
                            type: 'delete',
                            async: false,
                            cache: false,
                            success: function (data) {
                                if (data && data.Success === true && data.Data === 0) {
                                    $row.parent().parent().parent().remove();
                                    if ($container.find('tbody.files tr').length === 0) {
                                        $container.find('table').hide();
                                        $container.find('div.noRecordTip').show();
                                    }
                                }
                            }
                        });
                        return false;
                    });

                    $container.find('table').show();
                } else {
                    $container.find('div.noRecordTip').show();
                }
            } else {
                $container.find('div.noRecordTip').show();
            }
        }

        // 绑定产品归属信息
        function bindCaseInfoRelProductInfo(data) {
            if (data && data.length > 0) {
                for (var i = 0; i < data.length; i++) {
                    $('#divCaseInfoRelProductInfo .panel-body table tbody').append('<tr class="h35">' +
                                '<td class="textCenter">' + (i + 1) + '</td>' +
                                '<td class="textLeft"><a href="../ProductInfo/Read.html#id=' + data[i].ProductInfoID + '" target="_blank" title="' + data[i].ProductInfoTitle + '">' + data[i].ProductInfoTitle + '</a></td>' +
                                '</tr>');
                }
                $('#divCaseInfoRelProductInfo table').show();
            } else {
                $('#divCaseInfoRelProductInfo div.noRecordTip').show();
            }
        }

        // 绑定关联项目信息
        function bindCaseInfoRelProjectInfo(data) {
            if (data && data.length > 0) {
                for (var i = 0; i < data.length; i++) {
                    $('#divCaseInfoRelProjectInfo .panel-body table tbody').append('<tr class="h35">' +
                                '<td class="textCenter">' + (i + 1) + '</td>' +
                                '<td class="textLeft"><a href="../ProjectInfo/Read.html#id=' + data[i].ProjectInfoID + '" target="_blank" title="' + data[i].ProjectInfoTitle + '">' + data[i].ProjectInfoTitle + '</a></td>' +
                                '</tr>');
                }
                $('#divCaseInfoRelProjectInfo table').show();
            } else {
                $('#divCaseInfoRelProjectInfo div.noRecordTip').show();
            }
        }

        // 初始化图片查看控件
        function initLightBox() {
            lightbox.option({
                showImageNumberLabel: true,
                albumLabel: '第%1张，共%2张。',
                disableScrolling: false,
                alwaysShowNavOnTouchDevices: true,
                wrapAround: true
            });
        }
    </script>
</body>
</html>