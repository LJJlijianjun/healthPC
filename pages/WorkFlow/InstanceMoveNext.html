<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>流程流转</title>
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/iCheck/skins/square/blue.css" rel="stylesheet" />
    <link href="../../assets/vendors/lightbox2/dist/css/lightbox.min.css" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <style type="text/css">
        .workFlow-instanceMoveNext {
            margin: 0 auto;
            width: 500px;
            text-align: center;
        }

        .panel-heading {
            position: relative;
            text-align: left;
        }

        .process-picture {
            display: none;
            position: absolute;
            top: 10px;
            right: 15px;
            text-decoration: underline;
        }

        .nextTaskUserList .userSelect {
            line-height: 25px;
        }

            .nextTaskUserList .userSelect .selector {
                display: inline-block;
                width: 70px;
                text-align: right;
            }

            .nextTaskUserList .userSelect .userInfo {
                display: inline-block;
                padding-left: 10px;
                width: 300px;
                text-align: left;
                font-size: 14px;
            }

                .nextTaskUserList .userSelect .userInfo label {
                    margin-bottom: 0;
                    font-weight: normal;
                    cursor: pointer;
                }

        .panel-footer {
            padding: 8px 15px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="workFlow-instanceMoveNext">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title"></h3>
                <!--<a class="process-picture" data-lightbox="processPic" data-title="流程图示" title="流程图示" href="#">流程图示</a>-->
            </div>
            <div class="panel-body">
                <div class="nextTaskUserList">
                </div>
            </div>
            <div class="panel-footer">
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-default w80" id="btnConfirm" data-loading-text="处理中..." disabled="disabled">确定</button>
                    <button type="button" class="btn btn-default w80" id="btnGoBack" onclick="javascript: window.history.back();">返回</button>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="hidNextTaskId" />
    <script src="../../assets/vendors/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="../../assets/js/jquery-tools-min.js" type="text/javascript"></script>
    <script src="../../assets/js/config.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/js/auth.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/bootbox.js/bootbox.js" type="text/javascript"></script>
    <script src="../../assets/js/workFlow.min.js?v=1.0.2" type="text/javascript"></script>
    <script src="../../assets/vendors/mustache.js/mustache.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/lightbox2/dist/js/lightbox.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/iCheck/icheck.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            AuthUtility.Auth(function () {
                WorkflowEngine.GetNextTask(function (data) {
                    if (data) {
                        $('#hidNextTaskId').val(data.NextTaskId);
                        $('.panel-title').text('确定下一个任务【' + data.NextTaskName + '】的办理人：');

                        if (data.NextTaskUsers && data.NextTaskUsers.length > 0) {
                            // 单人办理
                            if (data.NextTaskMode === 0) {
                                $('.nextTaskUserList').html(Mustache.render("{{#.}}" +
                                                                                                    "<div class=\"userSelect\">" +
                                                                                                        "<div class=\"selector\">" +
                                                                                                            "<input type=\"radio\" name=\"user\" id=\"user-{{EmpId}}\" data-empid=\"{{EmpId}}\" />" +
                                                                                                        "</div>" +
                                                                                                        "<div class=\"userInfo\">" +
                                                                                                            "<label for=\"user-{{EmpId}}\">{{TopDeptName}} -> {{UserName}}</label>" +
                                                                                                        "</div>" +
                                                                                                    "</div>" +
                                                                                                "{{/.}}", data.NextTaskUsers));

                                $('input[type=radio]').iCheck({
                                    radioClass: 'iradio_square-blue-16'
                                });
                                $('#user-' + data.NextTaskUsers[0].EmpId).iCheck('check');
                                setConfirmButton();
                            }
                            else if (data.NextTaskMode === 1) {  // 多人办理
                                $('.nextTaskUserList').html(Mustache.render("{{#.}}" +
                                                                        "<div class=\"userSelect\">" +
                                                                            "<div class=\"selector\">" +
                                                                                "<input type=\"checkbox\" name=\"user\" id=\"userMulti-{{EmpId}}\" data-empid=\"{{EmpId}}\" />" +
                                                                            "</div>" +
                                                                            "<div class=\"userInfo\">" +
                                                                                "<label for=\"userMulti-{{EmpId}}\">{{DeptName}} -> {{UserName}}</label>" +
                                                                            "</div>" +
                                                                        "</div>" +
                                                                    "{{/.}}", data.NextTaskUsers));
                                $('input[type=checkbox]').iCheck({
                                    checkboxClass: 'icheckbox_square-blue-16'
                                });
                                setConfirmButton();
                            }
                        }

                        $('.process-picture').show();
                        //initLightBox();
                    }
                });
            });
        });

        function setConfirmButton() {
            var $btnConfirm = $('#btnConfirm');

            $btnConfirm.on('click', function () {
                $('#btnConfirm,#btnGoBack').prop('disabled', true);
                var nextTaskId = $('#hidNextTaskId').val();
                var nextTaskEmpIds = '';

                var selectedUsers = $('input[name=user]:checked');
                if (selectedUsers.length === 0) {
                    bootbox.alert({ message: '请选择办理人！', size: 'small' });
                    $('#btnConfirm,#btnGoBack').prop('disabled', false);
                } else {
                    $('input[name=user]').prop('disabled', true);
                    $('#btnConfirm').button('loading');
                    $.each(selectedUsers, function (i, item) {
                        nextTaskEmpIds += $(item).data('empid') + '$';
                    });
                    nextTaskEmpIds = nextTaskEmpIds.substring(0, nextTaskEmpIds.length - 1);
                    WorkflowEngine.InstanceMoveNext({
                        NextTaskId: nextTaskId,
                        NextTaskEmpIds: nextTaskEmpIds
                    }, function (modelid, processid, result) {
                        if (result > 0) {
                            if (modelid === 6) {
                                sendReportInfoRemind(processid, nextTaskEmpIds);
                            }
                            WorkflowEngine.RedirectToDoListPage();
                        } else {
                            $('input[name=user]').prop('disabled', false);
                            bootbox.alert({ message: '执行失败！' });
                        }
                    });
                }
            });

            $btnConfirm.prop('disabled', false);
        }

        function sendReportInfoRemind(processid, nextTaskEmpIds) {
            // 发送报表待办通知
            $.ajax({
                url: dataServiceBaseUrl + 'api/ReportInfo/ReportInfo/SendToDoNotification?sid=' + sid,
                type: 'get',
                data: { processID: processid, nextTaskEmpIds: nextTaskEmpIds },
                async: true,
                success: function (data) {
                    // do nothing
                }
            });
        }

        // 初始化图片查看控件
        //function initLightBox() {
        //    var modelid = $.url().param('modelId');
        //    if (parseInt(modelid) > 0) {
        //        $('.process-picture').attr('href', '../../assets/img/ProcessPic/' + modelid + '.png');
        //    }
        //    lightbox.option({
        //        showImageNumberLabel: true,
        //        albumLabel: '第%1张，共%2张。',
        //        disableScrolling: false,
        //        alwaysShowNavOnTouchDevices: true,
        //        wrapAround: true
        //    });
        //}
    </script>
</body>
</html>
