<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>流程转办</title>
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/iCheck/skins/square/blue.css" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <style type="text/css">
        .workFlow-instanceRedirectContainer {
            width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        .panel-heading {
            text-align: left;
        }

        .nextTaskUserList .userSelect {
            height: 25px;
            line-height: 25px;
        }

            .nextTaskUserList .userSelect .selector {
                width: 120px;
                text-align: right;
                display: inline-block;
            }

            .nextTaskUserList .userSelect .userInfo {
                width: 300px;
                text-align: left;
                cursor: pointer;
                padding-left: 10px;
                font-size: 14px;
                display: inline-block;
            }

                .nextTaskUserList .userSelect .userInfo label {
                    font-weight: normal;
                    margin-bottom: 0;
                }

        .panel-footer {
            text-align: right;
            padding: 8px 15px;
        }
    </style>
</head>
<body>
    <div class="workFlow-instanceRedirectContainer">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title"></h3>
            </div>
            <div class="panel-body">
                <div class="nextTaskUserList">
                </div>
            </div>
            <div class="panel-footer">
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-default w80" id="btnConfirm" data-loading-text="处理中..." disabled="disabled">确定</button>
                    <button type="button" class="btn btn-default w80" id="btnGoBack" onclick="javascript: window.history.back();">返回</button>
                </div>
            </div>
        </div>
    </div>
    <script src="../../assets/vendors/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="../../assets/js/jquery-tools-min.js" type="text/javascript"></script>
    <script src="../../assets/js/config.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/js/auth.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/bootbox.js/bootbox.js" type="text/javascript"></script>
    <script src="../../assets/js/workFlow.min.js?v=1.0.2" type="text/javascript"></script>
    <script src="../../assets/vendors/mustache.js/mustache.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/iCheck/icheck.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            AuthUtility.Auth(function () {
                WorkflowEngine.GetInstanceRedirectTaskInfo(loadForm);
            });
        });

        var loadForm = function (data) {
            if (data) {
                $('.panel-title').text('请选择办理人：');

                if (data.NextTaskUsers && data.NextTaskUsers.length > 0) {
                    var container = $('div.nextTaskUserList');
                    container.html(Mustache.render("{{#.}}" +
                                                                        "<div class=\"userSelect\">" +
                                                                            "<div class=\"selector\">" +
                                                                                "<input type=\"radio\" name=\"user\" id=\"user-{{EmpId}}\" data-empid=\"{{EmpId}}\" />" +
                                                                            "</div>" +
                                                                            "<div class=\"userInfo\">" +
                                                                                "<label for=\"user-{{EmpId}}\">{{DeptName}} -> {{UserName}}</label>" +
                                                                            "</div>" +
                                                                        "</div>" +
                                                                   "{{/.}}", data.NextTaskUsers));

                    $('input[type=radio]').iCheck({
                        radioClass: 'iradio_square-blue-16'
                    });

                    setConfirmButton();
                }
            }
        }

        function setConfirmButton() {
            var $btnConfirm = $('#btnConfirm');

            $btnConfirm.on('click', function () {
                $('#btnConfirm,#btnGoBack').prop('disabled', true);
                var redirectEmpId = '';

                var selectedUsers = $('input[name=user]:checked');
                if (selectedUsers.length !== 1) {
                    bootbox.alert({ message: '请选择办理人！', size: 'small' });
                    $('#btnConfirm,#btnGoBack').prop('disabled', false);
                } else {
                    $('input[name=user]').prop('disabled', true);
                    $('#btnConfirm').button('loading');
                    redirectEmpId = selectedUsers.data('empid');
                    WorkflowEngine.InstanceRedirect({
                        RedirectEmpId: redirectEmpId
                    }, function (modelid, processid, result) {
                        if (result > 0) {
                            if (modelid === 6) {
                                sendReportInfoRemind(processid, redirectEmpId);
                            }
                            WorkflowEngine.RedirectToDoListPage();
                        } else {
                            $('input[name=user]').prop('disabled', false);
                            bootbox.alert({ message: '执行失败！' });
                        }
                    });
                }
            });

            $btnConfirm.prop('disabled', false);
        }

        function sendReportInfoRemind(processid, redirectEmpId) {
            // 发送报表待办通知
            $.ajax({
                url: dataServiceBaseUrl + 'api/ReportInfo/ReportInfo/SendToDoNotification?sid=' + sid,
                type: 'get',
                data: { processID: processid, nextTaskEmpIds: redirectEmpId },
                async: true,
                success: function (data) {
                    // do nothing
                }
            });
        }
    </script>
</body>
</html>
