<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>业务动态</title>
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/lightbox2/dist/css/lightbox.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />
</head>
<body>
    <div class="newsInfo-publishView">
        <div class="container-fluid">
            <div class="row processInfo">
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 pl10 textLeft">
                    <span>当前操作：</span>
                    <span class="process-currentTask"></span>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 pr10 textRight">
                    <a class="process-detail" href="#">流转明细及回退意见</a>&nbsp;&nbsp;
                    <!--<a class="process-picture" data-lightbox="processPic" data-title="流程图示" href="#">流程图示</a>-->
                </div>
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 pl10 textLeft">
                    <span class="process-backReasonDesc"></span>
                    <span class="process-backReason"></span>
                </div>
            </div>

            <div class="row processToolBar">
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 textLeft">
                    <div class="alert alert-danger formTip">
                        <span class="fa fa-info-circle"></span>
                        <span>红色标识字段为必填项！</span>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 textRight">
                    <div class="btn-group processButtonGroup">
                    </div>
                </div>
            </div>
            <div>&nbsp</div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="panel-title">
                        新闻信息
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-6 pr15">
                            <div class="input-group">
                                <span class="input-group-addon">动态名称</span>
                                <input class="form-control" id="txtTitle" name="txtTitle" type="text" readonly="readonly" />
                            </div>
                        </div>
                        <div class="col-xs-6">
                            <div class="input-group">
                                <span class="input-group-addon minWidth64">新闻类型</span>
                                <input class="form-control" id="txtNewsType" name="txtNewsType" type="text" readonly="readonly" />
                            </div>
                        </div>                      
                    </div>
                </div>
            </div>

            <div class="row mt10">
                <div class="col-xs-12">
                     <form class="fileupload" id="formMainDoc">
                         <div class="panel panel-default">
                            <div class="panel-heading">
                                <div class="panel-title">新闻图片</div>
                            </div>
                            <div class="panel-body">
                                <table class="table table-condensed table-bordered fileTable" role="presentation">
                                   <thead>
                                       <tr>
                                           <td>名称</td>
                                           <td class="w150">大小</td>
                                           <td class="w135">操作</td>
                                       </tr>
                                    </thead>
                                   <tbody class="files"></tbody>
                                   </table>
                                 <div class="noRecordTip"></div>
                             </div>
                          </div>
                      </form>
                  </div>                
            </div> 
            <div class="row mt10">
                <div class="col-xs-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="panel-title required">
                            新闻内容
                        </div>
                    </div>
                    <div class="panel-body">
                        <div id="editNewsInfo" name="editor" style="height:350px">
                        </div>
                    </div>
                </div>
                </div>
            </div>   
            <div class="row processMessage mt10">
                <div class="col-xs-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title">
                                审批意见
                                <a id="btnSelectApproveWords" style="display:inline">常用词</a>
                            </div>
                        </div>
                        <div class="panel-body">
                            <table class="table table-bordered table-condensed none">
                                <thead>
                                    <tr>
                                        <th class="w200">步骤名称</th>
                                        <th class="w150">审批人</th>
                                        <th class="w150">审批时间</th>
                                        <th>审批意见</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <form id="formWorkFlowMessage">
                                <div class="input-group">
                                    <span class="input-group-addon required">审批意见：</span>
                                    <textarea class="form-control workFlowMessage" id="txtWorkFlowMessage" name="txtWorkFlowMessage" data-popover-placement="top" rows="3" maxlength="200" placeholder="输入您的审批意见"></textarea>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div style="margin-top:10px; margin-bottom: 15px " class="col-xs-12 textRight">
                    <div class="btn-group processButtonGroup">
                    </div>
                </div>
            </div>
        </div>
        <script id="common-template-show" type="text/x-tmpl">
            {% for (var i=0, file; file=o.files[i]; i++) { %}
            <tr class="template-show">
                <td style="text-align: left;">
                    <div class="name">
                        <i class="{%=getAttachIcon(file.Name)%}"></i>
                        {% if (file.Url) { %}
                        <a href="#" title="{%=decodeURI(file.Name)%}" data-downloadurl="{%=file.Url%}" onclick="return downLoadFile(this);">{%=decodeURI(file.Name)%}</a>
                        {% } else { %}
                        <span>{%=decodeURI(file.Name)%}</span>
                        {% } %}
                    </div>
                    {% if (file.Error) { %}
                    <div><span class="label label-danger">Error</span> {%=file.Error%}</div>
                    {% } %}
                </td>
                <td>
                    <span class="size">{%= formatFileSize(file.Size)%}</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        
                    </div>
                </td>
            </tr>
            {% } %}
        </script>
        <a id="totop" href="#" title="回到顶部"><i class="fa fa-angle-up"></i></a>
        <input id="hidNewsInfoId" type="hidden" />
        <input type="hidden" id="hidPublishOrgID" />
        <!--是否机构部门，工作流使用字段-->
        <input id="wfIsCollaborateDept" type="hidden" />
        <iframe class="w1 h1 none" id="hidFileFrame"></iframe>
        <!--审批常用词模态框-->
        <div class="modal fade" id="approveWordSelectModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" id="approveWordsDialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <button type="button" class="close none" id="btnCloseApproveWordSelectModal" data-dismiss="modal" aria-hidden="true" title="关闭">&times;</button>
                        <iframe id="frameApproveWordSelector" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>
        <a class="w1 h1 none" id="hidPreviewLink" href="" target="_blank"></a>
    </div>
    <!--[if lt IE 9]>
    <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <script src="../../assets/vendors/jquery/dist/jquery.min.js" type="text/javascript"></script>
    <script src="../../assets/js/jquery-tools-min.js" type="text/javascript"></script>
    <script src="../../assets/js/config.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/js/auth.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../assets/js/common.min.js?v=1.0.3" type="text/javascript"></script>
    <script src="../../assets/js/workFlow.min.js?v=1.0.2" type="text/javascript"></script>
    <script src="../../assets/vendors/underscore/underscore-min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/blueimp-tmpl/js/tmpl.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/jquery-validation/dist/jquery.validate.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/jquery-validation/src/localization/messages_zh.js" type="text/javascript"></script>
    <script src="../../assets/vendors/LoadingUI/jquery.loadingui.js" type="text/javascript"></script>
    <script src="../../assets/vendors/bootbox.js/bootbox.js" type="text/javascript"></script>
    <script src="../../assets/vendors/xss/dist/xss.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/lightbox2/dist/js/lightbox.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/ueditor/ueditor.config.js"></script>
    <script src="../../assets/vendors/ueditor/ueditor.all.js"></script>
    <script src="../../assets/vendors/platform.js/platform.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function () {
            AuthUtility.Auth(function () {
                initWorkFlow();
                initValidator();
                bindEvent();
                loadForm();
                initLightBox();
                editor = UE.getEditor('editNewsInfo', {
                    toolbars: [[
                        'bold', 'italic', 'underline', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset',
                        '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|', 'rowspacingtop',
                        'rowspacingbottom', 'lineheight', '|', 'fontfamily', 'fontsize', '|', 'indent', '|', 'justifyleft', 'justifycenter',
                        'justifyright', 'justifyjustify', '|', 'link', 'unlink', '|', 'imagenone', 'imageleft', 'imageright', 'imagecenter', '|',
                        'simpleupload', '|', 'horizontal', 'spechars'
                    ]]
                });
            });
        });

        // 初始化工作流
        function initWorkFlow() {
            $(document).Workflow('ProcessInfo', {
                Btn: {
                    // 点击预览
                    Preview: function () {
                        document.getElementById('hidPreviewLink').click();
                    },
                    Next: function () {
                        checkForm(function () {
                            WorkflowAction.Next();
                        });
                    },
                    Complete: function () {
                        checkForm(function () {
                            publishNewsInfo(function () {
                                WorkflowAction.Complete();
                            });
                        });
                    },
                    Back: function () {
                        WorkflowAction.Back();
                    }
                }
            });
        }

        // 初始化表单验证控件
        function initValidator() {
            $.validator.addMethod("antiSqlInject", function (value, element, params) {
                if (value) {
                    return !AntiSqlInject($(element).val());
                } else {
                    return true;
                }
            }, "输入内容中包含非法字符！");

            $('#formWorkFlowMessage').validate({
                rules: {
                    txtWorkFlowMessage: { required: true, antiSqlInject: true }
                },
                messages: {
                    txtWorkFlowMessage: { required: '审批意见不能为空！' }
                },
                showErrors: jqValidationShowErrors
            });
        }

        // 绑定事件
        function bindEvent() {
            // 回到顶部功能
            $(window).scroll(function () {
                if ($(this).scrollTop() < 100) {
                    $('#totop').fadeOut();
                } else {
                    $('#totop').fadeIn();
                }
            });
            $('#totop').on('click', function () {
                $('html,body').animate({ scrollTop: 0 }, 'fast');
                return false;
            });

            // 常用词选择
            $('#btnSelectApproveWords').on('click', function () {
                openApproveWordSelector();
                return false;
            });
        }

        // 加载表单
        function loadForm() {
            $.ajax({
                url: dataServiceBaseUrl + 'api/NewsInfo/NewsInfo/GetNewsInfoByProcessId?sid=' + sid,
                type: 'get',
                data: {
                    processId: $.url().param("processId").trim()
                },
                async: true,
                cache: false,
                dataType: 'json',
                success: function (data) {
                    if (data && data.Success === true && data.Data) {
                        // 保存业务动态ID
                        $('#hidNewsInfoId').val(data.Data.NewsInfo.ID);
                        // 保存发布单位ID
                        $('#hidPublishOrgID').val(data.Data.NewsInfo.CreateUserOrgID);
                        // 动态名称
                        $('#txtTitle').val(data.Data.NewsInfo.Title);
                        // 新闻类型
                        $('#txtNewsType').val(data.Data.NewsInfo.NewsType);

                        $('#hidPreviewLink').attr('href', 'Preview.html#id=' + data.Data.NewsInfo.ID);
                        // 新闻内容
                        editor.ready(function () {
                            editor.setDisabled();
                            var newsContent = unescape(data.Data.NewsInfo.NewsContent.replace(/\$/g, '%'));
                            var newEditorContent = newsContent.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, function (img, src) {
                                return img.replace(/src=['"]([^'"]+)/, function (newimg, newsrc) {
                                    var requestUrl = dataServiceBaseUrl + 'api/Common/FileManage?sid=' + sid + '&path=';
                                    return 'src="' + requestUrl + newsrc.replace('/Image/', '');
                                });
                            });
                            editor.setContent(newEditorContent);
                        });
                        //图片
                        bindFileInfo('formMainDoc', 2, data.Data.Documents);
                        
                    }
                }
            });
        }

        // 绑定文件信息
        function bindFileInfo(containerId, documentType, data) {
            var $container = $('#' + containerId);

            // 绑定数据
            if (data && data.files.length > 0) {
                var tempData = _.where(data.files);
                //if (containerId === 'formMainDoc' && tempData && tempData.length > 0) {
                //    tempData = _.where(tempData, { Type: 'pdf' });
                //}
                if (tempData && tempData.length > 0) {
                    var docData = { files: tempData };

                    $container.find('tbody.files').html(tmpl(document.getElementById('common-template-show').innerHTML.trim(), docData));

                    $container.on('click', 'tbody.files button.download', function () {
                        return downLoadFile(this);
                    });

                    $container.on('click', 'tbody.files button.delete', function () {
                        var $row = $(this);
                        $.ajax({
                            url: $row.data('deleteurl'),
                            type: 'delete',
                            async: false,
                            cache: false,
                            success: function (data) {
                                if (data && data.Success === true && data.Data === 0) {
                                    $row.parent().parent().parent().remove();
                                    if ($container.find('tbody.files tr').length === 0) {
                                        $container.find('table').hide();
                                        $container.find('div.noRecordTip').show();
                                    }
                                }
                            }
                        });
                        return false;
                    });

                    $container.find('table').show();
                } else {
                    $container.find('div.noRecordTip').show();
                }
            } else {
                $container.find('div.noRecordTip').show();
            }
        }
        

        // 检查表单
        function checkForm(callback) {
            if ($('#formWorkFlowMessage').valid()) {
                callback();
            }
        }

        // 发布动态
        function publishNewsInfo(callback) {
            bootbox.confirm({
                message: '将要发布该动态，是否继续？',
                callback: function (result) {
                    if (result === true) {
                        $.ajax({
                            url: dataServiceBaseUrl + 'api/NewsInfo/NewsInfo/PublishNewsInfo?newsInfoId=' + $('#hidNewsInfoId').val() + '&sid=' + sid + '&clientInfo=' + getClientInfo(),
                            type: 'patch',
                            beforeSend: function () {
                                $('body').loadingUI({ text: '正在发布，请稍候...' });
                            },
                            async: false,
                            cache: false,
                            dataType: 'json',
                            success: function (data) {
                                if (data && data.Success === true && data.Data === 0) {
                                    callback();
                                } else {
                                    bootbox.alert({ message: '发布失败！' });
                                    $('body').loadingUI('hide');
                                }
                            },
                            error: function () {
                                bootbox.alert({ message: '发布失败！' });
                                $('body').loadingUI('hide');
                            }
                        });
                    }
                }
            });
        }

        // 初始化图片查看控件
        function initLightBox() {
            lightbox.option({
                showImageNumberLabel: true,
                albumLabel: '第%1张，共%2张。',
                disableScrolling: false,
                alwaysShowNavOnTouchDevices: true,
                wrapAround: true
            });
        }

        // 打开审批意见选择框
        function openApproveWordSelector() {
            $('#frameApproveWordSelector').attr('src', '../Common/Selector/ApproveWordSelector.html');
            $('#approveWordSelectModal').modal();
        }

        // 选择审批意见
        function addApproveCommonWord() {
            var selectedApproveCommonWords = document.getElementById('frameApproveWordSelector').contentWindow.getCommonWord();
            $('#btnCloseApproveWordSelectModal').click();
            $('#txtWorkFlowMessage').focus().val(selectedApproveCommonWords);
        }
    </script>
</body>
</html>
