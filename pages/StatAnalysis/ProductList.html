<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>统计分析</title>
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/select2/dist/css/select2.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/gw-selectOrg/dist/gw-selectOrg.min.css?v=1.0.1" rel="stylesheet" />
    <link href="../../assets/vendors/smalot-bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/gw-selectSeason/src/gw-selectSeason.css" rel="stylesheet" />
    <link href="../../assets/vendors/iCheck/skins/square/blue.css" rel="stylesheet" />
    <link href="../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.css?v=1.0.1" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/css/statAnalysis.css?v=1.0.0" rel="stylesheet" />
</head>
<body>
    <div class="stat-List">
        <div class="searchArea">
            <div class="btn-toolbar">
                <div class="input-group w302">
                    <span class="input-group-addon">产品名称</span>
                    <input class="form-control w249" type="text" id="txtTitle" placeholder="产品名称"/>
                </div>
                <div class="input-group w331">
                    <span class="input-group-addon">发布单位</span>
                    <div class="GWSelectOrg w250" id="selPublishOrg" name="selPublishOrg"></div>
                </div>
            </div>
            <div class="btn-toolbar">
                <div class="input-group w493">
                    <span class="input-group-addon">发布时间从</span>
                    <input class="form-control w180" id="txtPublishTimeStart" type="text" readonly="readonly" placeholder="开始时间" />
                    <span class="input-group-addon">至</span>
                    <input class="form-control w180" id="txtPublishTimeEnd" type="text" readonly="readonly" placeholder="结束时间" />
                </div>
                <div class="input-group">
                    <div class="btn-group">
                        <button class="btn btn-default" type="button" id="btnSearch">
                            <span class="fa fa-search"></span> 检索
                        </button>
                        <button class="btn btn-default" type="button" id="btnReset">
                            <span class="fa fa-repeat"></span> 重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="dataList">
        </div>
        <div class="modal fade" id="visitAndFavInfoModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <button type="button" class="close none" id="btnCloseVisitAndFavInfoModal" data-dismiss="modal" aria-hidden="true" title="关闭">&times;</button>
                        <iframe id="frameVisitAndFavInfoModal" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--[if lt IE 9]>
    <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <script src="../../assets/vendors/jquery/dist/jquery.min.js"></script>
    <script src="../../assets/js/jquery-tools-min.js"></script>
    <script src="../../assets/js/config.min.js?v=1.0.0"></script>
    <script src="../../assets/js/auth.min.js?v=1.0.0"></script>
    <script src="../../assets/js/common.min.js?v=1.0.3"></script>
    <script src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../../assets/vendors/gw-selectOrg/dist/gw-selectOrg.min.js?v=1.0.1" type="text/javascript"></script>
    <script src="../../assets/vendors/select2/dist/js/select2.full.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/smalot-bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/smalot-bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" type="text/javascript"></script>
    <script src="../../assets/vendors/gw-selectSeason/src/gw-selectSeason.js"></script>
    <script src="../../assets/vendors/iCheck/icheck.min.js"></script>
    <script src="../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script src="../../assets/vendors/twbs-pagination/jquery.twbsPagination.js"></script>
    <script src="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.js?v=1.0.1"></script>
    <script src="../../assets/vendors/xss/dist/xss.min.js"></script>
    <script src="../../assets/vendors/platform.js/platform.js" type="text/javascript"></script>
    <script src="../../assets/vendors/bootbox.js/bootbox.js"></script>
    <script type="text/javascript">
        $('select').select2({ width: '100%' });
    </script>
    <script type="text/javascript">
        var dataListScModel = {
            Title: '',
            CreateUserOrgID: '0',
            PublishTimeStart: '',
            PublishTimeEnd: '',
            PageNum: 1,
            PageSize: 0
        };

        $(function () {
            AuthUtility.Auth(function () {
                initSearch();
                initEvent();
                initDataList();
            });
        });

        function initSearch() {
            initSelPublishOrg();
        }

        // 初始化日期选择框
        function initDateSelecter() {
            var option = {
                language: 'zh-CN',
                weekStart: 1,
                todayBtn: 1,
                todayHighlight: 1,
                startView: 2,
                minView: 2,
                autoclose: 1,
                format: 'yyyy-mm-dd',
                forceParse: true,
                pickerPosition: "bottom-right"
            }

            $('#txtPublishTimeStart').datetimepicker(option);
            $('#txtPublishTimeEnd').datetimepicker(option);
        }

        // 初始化单位选择
        function initSelPublishOrg() {
            $('#selPublishOrg').GWSelectOrg({
                dataUrl: dataServiceBaseUrl + 'api/UserOrg/Org/GetOrgDeptList?sid=' + sid,
                singleSelect: false,
                onDataLoadCompleted: function () {
                    initDateSelecter();
                }
            });
        }

        function initDataList() {
            $('.dataList').css('height', $('.stat-List').height() - $('.searchArea').outerHeight(true));
            var option = {
                tableTitle: '统计结果',
                tableIcon: true,
                columns:
                [
                    //{
                    //    title: '产品名称',
                    //    field: 'Title',
                    //    align: 'left',
                    //    formatter: function (value, row) {
                    //        var linkTitle = 'javascript:void(0);';

                    //        switch (row.ModuleTypeKV) {
                    //            case 1:
                    //                linkTitle = '../NewsInfo/Read.html#id=' + row.ItemID;
                    //                break;

                    //            case 2:
                    //                linkTitle = '../ProductInfo/Read.html#id=' + row.ItemID;
                    //                break;

                    //            case 3:
                    //                linkTitle = '../ProjectInfo/Read.html#id=' + row.ItemID;
                    //                break;

                    //            case 4:
                    //                linkTitle = '../CaseInfo/Read.html#id=' + row.ItemID;
                    //                break;

                    //            case 5:
                    //                linkTitle = '../FileInfo/Read.html#id=' + row.ItemID;
                    //                break;

                    //            case 6:
                    //                linkTitle = '../StatAnalysis/ReportItemList.html?ReportInfoID=' + row.ItemID + '&FolderName=' + encodeURIComponent(value);
                    //                return '<a href="' + linkTitle + '" title="' + value + '" onclick="javascript: void(0);" >' + value + '</a>';

                    //            default:
                    //                break;
                    //        }
                    //        return '<a href="' + linkTitle + '" target="_blank" title="' + value + '" onclick="javascript: void(0);" >' + value + '</a>';
                    //    }
                    //},
                    //{ title: '类型', field: 'ModuleType', align: 'left', width: '160' },\
                    {
                        title: '产品名称', field: 'Title', align: 'left',
                        formatter: function (value, rowData) {
                            var titleClass = '';
                            return '<a href="../Productinfo/Read.html#id=' + rowData.ID + '" target="_blank" title="' + value + '" data-titleclass="' + titleClass + '">' + (rowData.Status === 4 ? '（暂时关闭）' : '') + value + '</a>';
                        }
                    },
                    {
                        title: '发布单位',
                        field: 'CreateUserOrgName',
                        align: 'left',
                        width: '240',
                        formatter: function (value) {
                            return '<span title="' + value + '">' + value + '</span>';
                        }
                    },
                    {
                        title: '点击量', field: 'click', align: 'left', width: '100',
                        formatter: function (value) {
                            
                                return value + '次';

                        }
                    },
                    {
                        title: '收藏量', field: 'favorite', align: 'left', width: '100',
                        formatter: function (value) {
                                return value+'次';
                        }
                    },
                    {
                        title: '咨询量', field: 'consult', align: 'left', width: '100',
                        formatter: function (value) {
                                return value+'次';
                        }
                    },
                    {
                        title: '产品规模', field: 'Worth', align: 'left', width: '130',
                        formatter: function (value) {
                                return value+'万元';
                        }
                    },
                    {
                        title: '成交规模', field: 'amount', align: 'left', width: '130',
                        formatter: function (value) {
                                return value+'万元';
                        }
                    },
                    {
                        title: '产品创建时间',
                        field: 'PublishTime',
                        align: 'left',
                        width: '160'
                    }
                ],
                dataUrl: dataServiceBaseUrl + 'api/StatAnalysis/StatAnalysis/GetStatAnalysisproductBySC?sid=' + sid,
                queryParams: function (pageNumber, pageSize) {
                    dataListScModel.PageNum = pageNumber;
                    dataListScModel.PageSize = pageSize;
                    return { scModel: dataListScModel };
                },
                pagination: true,
                onLoadSuccess: function (table,data) {
                    setTitleClass(table);

                    $(table).find('.table-content-container .table-body .Title a').each(function () {
                        var txtTitle = $('#txtTitle').val().trim();
                        if (txtTitle != '' && txtTitle != '+') {
                            var html = $(this).html().replace(new RegExp(txtTitle, 'gi'), '<label class="highlight">' + txtTitle + '</label>');
                            $(this).html(html);
                        }
                    });
                    $('.table-title-text').html("统计结果&emsp;&emsp;累计点击量" + data.sum.click + "次,收藏量" + data.sum.favorite + "次,咨询量" + data.sum.consult + "次,产品规模" + data.sum.worth + "万元,成交规模" + data.sum.amount + "万元");
                    $(window).on('resize', function () {
                        setTitleClass(table);
                    });
                }
            };

            $('.dataList').GWDataTable(option);
        }

        function initEvent() {
            $('#btnSearch').on('click', function () {
                dataListScModel.Title = $('#txtTitle').val();
                dataListScModel.CreateUserOrgID = $('#selPublishOrg').GWSelectOrg('getSelectedOrgIDs').join(',');
                dataListScModel.PublishTimeStart = $('#txtPublishTimeStart').val();
                if ($('#txtPublishTimeEnd').val() != '') {
                    dataListScModel.PublishTimeEnd = $('#txtPublishTimeEnd').val() + ' 23:59:59.999';
                } else {
                    dataListScModel.PublishTimeEnd = $('#txtPublishTimeEnd').val();
                }

                $('.dataList').GWDataTable('load', dataListScModel);
            });

            $('#btnReset').click(function () {
                $('#txtTitle').val('');
                $('#selPublishOrg').GWSelectOrg('reSetSelected');
                $('#txtPublishTimeStart').val('');
                $('#txtPublishTimeEnd').val('');
                dataListScModel.Title = '';
                dataListScModel.CreateUserOrgID = '0';
                dataListScModel.PublishTimeStart = '';
                dataListScModel.PublishTimeEnd = '';

                $('.dataList').GWDataTable('load', dataListScModel);
            });

            $('#txtTitle').on('keydown', function (e) {
                if (e.keyCode === 13 && $(this).val().trim() != "") {
                    $("#btnSearch").click();
                }
            });

            $('#visitAndFavInfoModal').on('hidden.bs.modal', function () {
                $('#frameVisitAndFavInfoModal').attr('src', '');
            });
        }

        function openVisitAndFavInfoList(itemId, moduleTypeId, statType) {
            $('#visitAndFavInfoModal').on('shown.bs.modal', function () {
                if (moduleTypeId == 6) {
                    $('#frameVisitAndFavInfoModal').attr('src', 'VisitAndFavInfoList.html?ItemID=' + itemId + '&IsReportID=1&ModuleTypeKV=' + moduleTypeId + '&StatType=' + statType + '&t=' + new Date().getMilliseconds());
                } else {
                    $('#frameVisitAndFavInfoModal').attr('src', 'VisitAndFavInfoList.html?ItemID=' + itemId + '&IsReportID=0&ModuleTypeKV=' + moduleTypeId + '&StatType=' + statType + '&t=' + new Date().getMilliseconds());
                }
            });
            $('#visitAndFavInfoModal').modal();
        }
    </script>
</body>
</html>
