<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>待办列表</title>
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.css?v=1.0.1" rel="stylesheet" />
    <link href="../../assets/vendors/select2/dist/css/select2.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/smalot-bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />
</head>
<body>
    <div class="myWork-todoList">
        <div class="searchArea">
            <div class="btn-toolbar">
                <div class="input-group w233">
                    <span class="input-group-addon">名称</span>
                    <input type="text" class="form-control w180" id="txtTitle" placeholder="名称" />
                </div>
                <div class="input-group w213">
                    <span class="input-group-addon">类型</span>
                    <select class="form-control w160" id="selModelType"></select>
                </div>
                <div class="input-group w414">
                    <span class="input-group-addon">到达时间从</span>
                    <input type="text" class="form-control w150" id="txtTaskArriveStartTime" readonly="readonly" placeholder="开始时间" />
                    <span class="input-group-addon">至</span>
                    <input type="text" class="form-control w150" id="txtTaskArriveEndTime" readonly="readonly" placeholder="结束时间" />
                </div>
                <div class="input-group">
                    <div class="btn-group">
                        <button class="btn btn-default" type="button" id="btnSearch" disabled="disabled">
                            <span class="fa fa-search"></span> 检索
                        </button>
                        <button class="btn btn-default" type="button" id="btnReset" disabled="disabled">
                            <span class="fa fa-repeat"></span> 重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="dataList">
        </div>
    </div>
    <!--[if lt IE 9]>
    <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <script src="../../assets/vendors/jquery/dist/jquery.min.js"></script>
    <script src="../../assets/js/jquery-tools-min.js"></script>
    <script src="../../assets/js/config.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/js/auth.min.js?v=1.0.0" type="text/javascript"></script>
    <script src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="../../assets/js/common.min.js?v=1.0.3" type="text/javascript"></script>
    <script src="../../assets/js/workFlow.min.js?v=1.0.2" type="text/javascript"></script>
    <script src="../../assets/vendors/select2/dist/js/select2.full.min.js"></script>
    <script src="../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script src="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.js?v=1.0.1"></script>
    <script src="../../assets/vendors/xss/dist/xss.min.js"></script>
    <script src="../../assets/vendors/smalot-bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="../../assets/vendors/smalot-bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    <script type="text/javascript">
        $('#selModelType').select2({ width: 'resolve' });
    </script>
    <script type="text/javascript">
        var dataListScModel = {
            Title: '',
            ModelType: 0,
            TaskArriveStartTime: '',
            TaskArriveEndTime: '',
            PageNum: 1,
            PageSize: 0
        };

        $(function () {
            AuthUtility.Auth(function () {
                initSearch();
                initDataList();
            });
        });

        function initSearch() {
            initModelTypeSelector();
            initDateTimeSelecter();

            $("#btnSearch").click(function () {
                dataListScModel.Title = filterXSS($('#txtTitle').val().trim());
                dataListScModel.ModelType = $('#selModelType').val();
                dataListScModel.TaskArriveStartTime = filterXSS($('#txtTaskArriveStartTime').val());
                dataListScModel.TaskArriveEndTime = filterXSS($('#txtTaskArriveEndTime').val());
                dataListScModel.PageNum = 1;
                dataListScModel.PageSize = 0;
                $('.dataList').GWDataTable('load', dataListScModel);
            }).prop('disabled', false);

            $("#btnReset").click(function () {
                $('#txtTitle').val('');
                $('#selModelType').val('0');
                $('#selModelType').trigger('change.select2');
                $('#txtTaskArriveStartTime').val('');
                $('#txtTaskArriveEndTime').val('');
                dataListScModel.Title = '';
                dataListScModel.ModelType = 0;
                dataListScModel.TaskArriveStartTime = '';
                dataListScModel.TaskArriveEndTime = '';
                dataListScModel.PageNum = 1;
                dataListScModel.PageSize = 0;
                $('.dataList').GWDataTable('load', dataListScModel);
            }).prop('disabled', false);

            $('#txtTitle').on('keydown', function (e) {
                if (e.keyCode === 13 && $(this).val().trim() != "") {
                    $("#btnSearch").click();
                }
            });
        }

        function initModelTypeSelector() {
            var sel = $("#selModelType");
            var url = dataServiceBaseUrl + 'api/SysMaintain/Dictionary?sid=' + sid;
            var data = {
                searchModel: {
                    TypeId: 1,
                    PageNum: 1,
                    PageSize: 0,
                    IsActive: 1
                }
            };
            bindSelector(sel, url, data);
        }

        //select2绑定数据
        function bindSelector(sel, url, data, val) {
            sel.select2({
                selectOnClose: false,
                allowClear: false,
                minimumResultsForSearch: Infinity
            });

            $.ajax({
                url: url,
                data: data,
                type: 'get',
                async: false,
                cache: false,
                success: function (result) {
                    if (result && result.Success === true && result.Data) {
                        sel.empty();
                        sel.append("<option value='0'>全部</option>");
                        $.each(result.Data.rows, function (i, item) {
                            if (item.Dkey !== 6) {
                                sel.append("<option value='" + item.Dkey + "'>" + item.DValue + "</option>");
                            }
                        });
                        sel.val(sel[0][0].value);
                        sel.trigger('change.select2');
                        $('#btnSearch,#btnReset').prop('disabled', false);
                    }
                }
            });
        }

        function initDateTimeSelecter() {
            var option = {
                language: 'zh-CN',
                weekStart: 1,
                todayBtn: 1,
                todayHighlight: 1,
                startView: 2,
                minView: 0,
                autoclose: 1,
                forceParse: true,
                pickerPosition: "bottom-right"
            }
            $('#txtTaskArriveStartTime').datetimepicker(option);
            $('#txtTaskArriveEndTime').datetimepicker(option);
        }

        function initDataList() {
            $('.dataList').css('height', $('.myWork-todoList').height() - $('.searchArea').outerHeight(true));

            var option = {
                tableTitle: '待办',
                tableIcon: true,
                showLine: true,
                columns:
                [
                    {
                        title: '标题',
                        field: 'Title',
                        align: 'left',
                        formatter: function (value, rowData) {
                            var titleClass = '';
                            if (rowData.IsBack === 1) {
                                titleClass = 'Back';
                            } else {
                                if ((rowData.ModelId === 1 && rowData.TaskId === 3) ||
                                (rowData.ModelId === 2 && rowData.TaskId === 3) ||
                                (rowData.ModelId === 3 && rowData.TaskId === 3)) {
                                    titleClass = 'Edit';
                                }else {
                                    titleClass = 'Approve';
                                }
                            }
                            var title = value;
                            switch (rowData.ModuleTypeKV){
                                case 4:
                                    title = value + '（咨询信息）';
                                    break;
                                case 5:
                                    title = value + '（定制信息）';
                                    break;
                                case 6:
                                    title = value + '（用户注册审核）';
                                    break;
                                default:
                                    break;
                            }

                            if ((rowData.ModuleTypeKV == 4 || rowData.ModuleTypeKV == 5 || rowData.ModuleTypeKV == 6) && (rowData.InstanceStatus == 0 || rowData.InstanceStatus == 2)) {
                                return '<a data-titleclass="' + titleClass + '" href="javascript: void(0);" title="' + title + '" onclick="redirectApprove(' + rowData.ID + ',' + rowData.ModuleTypeKV + ',' + rowData.InstanceStatus + ')">' + HtmlEncode(title) + '</a>';
                            } else {
                                return '<a data-titleclass="' + titleClass + '" href="javascript: void(0);" title="' + title + '" onclick="javascript: WorkflowEngine.TaskForm(' + rowData.ProcessId + ',' + rowData.InstanceId + ');">' + HtmlEncode(title) + '</a>';
                            }
                        }
                    },
                    { title: '类型', field: 'ModuleType', align: 'left', width: '160' },
                    {
                        title: '当前状态', field: 'TaskName', align: 'left', width: '200', formatter: function (value, rowData) {
                            var val=value;
                            switch (rowData.ModuleTypeKV) {
                                case 4:
                                    val = '待联络岗分发咨询信息';
                                    break;
                                case 5:
                                    val = '待联络岗分发定制信息';
                                    break;
                                case 6:
                                    val = '待管理员审核注册信息';
                                    break;
                                default:
                                    break;
                            }
                            return '<span>' + val + '</span>';
                        }
                    },
                    {
                        title: '到达时间', field: 'CreatedTime', align: 'left', width: '140', formatter: function (value) {
                            return new Date(value.replace(/-/g, '/')).Format('yyyy-MM-dd HH:mm');
                        }
                    }
                ],
                dataUrl: dataServiceBaseUrl + 'api/Common/Common/GetMyToDoListBySC?sid=' + sid + '&t=' + new Date().getMilliseconds(),
                queryParams: function () {
                    return { scModel: dataListScModel };
                },
                noDataImgPath: '../../assets/img/NoToDoList.png',
                onLoadSuccess: function (table) {
                    setTitleClass(table);

                    $(table).find('.table-content-container .table-body .Title a').each(function () {
                        var txtTitle = $('#txtTitle').val().trim();
                        if (txtTitle != '' && txtTitle != '+') {
                            var html = $(this).html().replace(new RegExp(txtTitle, 'gi'), '<label class="highlight">' + txtTitle + '</label>');
                            $(this).html(html);
                        }
                    });

                    $(window).on('resize', function () {
                        setTitleClass(table);
                    });
                }
            };

            $('.dataList').GWDataTable(option);
        }

        //待办列表moduleid = 4，5，6跳转审批页面
        function redirectApprove(id, moduleId, status) {
            switch(moduleId){
                case 4:
                    createConsultInfo(id);
                    break;
                case 5:
                    createDemandInfo(id);
                    break;
                case 6:
                    createCustomInfo(id, status);
                    break;
                default:
                    break;
            }
           
        }


        // 新建用户咨询流程
        function createConsultInfo(id) {
            WorkflowEngine.CreateProcess({
                modelId: 4,
                callback: function (data) {
                    var taskPage = data.TaskPage;
                    window.location.href = taskPage + '&ConsultInfoID=' + id + '&sourceUrl=' + window.location.pathname;
                }
            });
        }

        // 新建用户定制流程
        function createDemandInfo(id) {
            WorkflowEngine.CreateProcess({
                modelId: 5,
                callback: function (data) {
                    var taskPage = data.TaskPage;
                    window.location.href = taskPage + '&DemandInfoID=' + id + '&sourceUrl=' + window.location.pathname;
                }
            });
        }

        // 新建用户审核流程
        function createCustomInfo(id, status) {
            if (status == 2) {
                window.location.href = '../CustomInfo/Approve.html?CustomInfoID=' + id + '&Status='+status+'&sourceUrl=' + window.location.pathname;
            } else {
                WorkflowEngine.CreateProcess({
                    modelId: 6,
                    callback: function (data) {
                        var taskPage = data.TaskPage;
                        window.location.href = taskPage + '&CustomInfoID=' + id + '&sourceUrl=' + window.location.pathname;
                    }
                });
            }
        }
    </script>
</body>
</html>
