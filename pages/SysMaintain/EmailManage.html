<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>推介邮件管理</title>
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../assets/vendors/select2/dist/css/select2.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/smalot-bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.css" rel="stylesheet" />
    <link href="../../assets/vendors/gw-userOrgSelector/dist/gw-userOrgSelector.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.css?v=1.0.1" rel="stylesheet" />
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />
</head>
<body>
    <div class="sysMaintain-EmailPromoteManageFrame">
        <ul class="nav nav-tabs nav-tabs-dic" role="tablist">
            <li class="active" role="presentation"><a data-toggle="tab" href="#UnSendEmail" role="tab">未发送邮件</a></li>
            <li role="presentation"><a data-toggle="tab" href="#SendedEmail" role="tab">已发送邮件</a></li>
        </ul>
        <div id="content">
            <div class="tab-content">  
                <div class="tab-pane active" id="UnSendEmail" role="tabpanel">
                    <div class="searchArea">
                        <div class="row">
                            <div class="col-xs-4">
                                <div class="input-group">
                                    <span class="input-group-addon">收件人</span>
                                    <input class="form-control" id="txtOutBoxReceiveUser" name="txtOutBoxReceiveUser"  type="text"  placeholder="收件人" />
                                </div>
                            </div>
                            <div class="col-xs-4">
                                <div class="input-group">
                                    <span class="input-group-addon">邮箱地址</span>
                                    <input class="form-control" id="txtOutEmail" name="txtOutEmail" type="text" placeholder="邮箱地址" />
                                </div>
                            </div>
                            <div class="col-xs-3">
                                <div class="input-group">
                                    <div class="btn-group">
                                        <button class="btn btn-default" id="btnOutBoxSearch" type="button">
                                            <span class="fa fa-search"></span> 检索
                                        </button>
                                        <button class="btn btn-default" id="btnOutBoxReset" type="button">
                                            <span class="fa fa-repeat"></span> 重置
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dataList" id="EmailOutBoxList"></div>
                </div>

                <div class="tab-pane active" id="SendedEmail" role="tabpanel">
                    <div class="searchArea">
                        <div class="row">
                            <div class="col-xs-4">
                                <div class="input-group">
                                    <span class="input-group-addon">收件人</span>
                                    <input class="form-control" id="txtLogReceiveUser" name="txtLogReceiveUser"  type="text"  placeholder="收件人" />
                                </div>
                            </div>
                            <div class="col-xs-4">
                                <div class="input-group">
                                    <span class="input-group-addon">邮箱地址</span>
                                    <input class="form-control" id="txtLogEmail" name="txtLogEmail" type="text" placeholder="邮箱地址" />
                                </div>
                            </div>
                            <div class="col-xs-3">
                                <div class="input-group">
                                    <div class="btn-group">
                                        <button class="btn btn-default" id="btnLogEmailSearch" type="button">
                                            <span class="fa fa-search"></span> 检索
                                        </button>
                                        <button class="btn btn-default" id="btnLogEmailBoxReset" type="button">
                                            <span class="fa fa-repeat"></span> 重置
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dataList" id="EmailLogList"></div>
                </div>                
            </div>
        </div>

        <!--邮件预览模态框-->
        <div class="modal fade" id="EmailPreviewModel" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="close" id="btnCloseEmailPreviewModel" data-dismiss="modal" type="button" aria-hidden="true" title="关闭">&times;</button>
                        <h5 class="modal-title bold">推介邮件</h5>
                    </div>
                    <div class="modal-body">
                        <iframe id="iframeEmailContent" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>
        <!--邮件预览模态框end-->
    </div>
    <!--[if lt IE 9]>
    <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <script type="text/javascript" src="../../assets/vendors/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="../../assets/js/jquery-tools-min.js"></script>
    <script type="text/javascript" src="../../assets/js/config.min.js?v=1.0.0"></script>
    <script type="text/javascript" src="../../assets/js/auth.min.js?v=1.0.0"></script>
    <script type="text/javascript" src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/select2/dist/js/select2.full.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script type="text/javascript" src="../../assets/vendors/twbs-pagination/jquery.twbsPagination.js"></script>
    <script type="text/javascript" src="../../assets/vendors/smalot-bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/smalot-bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    <script type="text/javascript" src="../../assets/js/common.min.js?v=1.0.3"></script>
    <script src="../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.js" type="text/javascript"></script>
    <script src="../../assets/vendors/gw-userOrgSelector/dist/gw-userOrgSelector.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/bootbox.js/bootbox.js"></script>
    <script src="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.js?v=1.0.1" type="text/javascript"></script>
    <script type="text/javascript">
        var dataListHeight = 0;
        //未发送邮件查询条件
        var OutBoxEmailLisScModel = {
            ReceiveUserName: '',
            ReceiveEmail: ''
        }

        //已发送邮件查询条件
        var LogEmailLisScModel = {
            ReceiveUserName: '',
            ReceiveEmail: ''
        }

        $(function () {
            bootbox.setLocale("zh_CN");
            AuthUtility.Auth(function () {
                initSearch();
                initEmailLogList();
                initEmailOutBoxList();
            });
        });

        //初始化查询条件
        function initSearch() {

            //未发送邮件查询按钮事件
            $('#btnOutBoxSearch').on('click', function () {
                var userName = '';
                OutBoxEmailLisScModel.ReceiveUserName = $('#txtOutBoxReceiveUser').val().trim();
                OutBoxEmailLisScModel.ReceiveEmail = $('#txtOutEmail').val().trim();
                $('#EmailOutBoxList').GWDataTable('load', OutBoxEmailLisScModel);
            });

            //未发送邮件重置事件
            $('#btnOutBoxReset').on('click', function () {
                OutBoxEmailLisScModel.ReceiveUserName = '';
                OutBoxEmailLisScModel.ReceiveEmail = '';
                $('#txtOutBoxReceiveUser').val('');
                $('#txtOutEmail').val('');
                $('#EmailOutBoxList').GWDataTable('load', OutBoxEmailLisScModel);
            });

            //$('#txtOutEmail').on('keydown', function (e) {
            //    if (e.keyCode === 13 && $(this).val().trim() != "") {
            //        $("#btnOutBoxSearch").click();
            //    }
            //});

            //已发送邮件查询按钮事件
            $('#btnLogEmailSearch').on('click', function () {
                var userName = '';
                LogEmailLisScModel.ReceiveUserName = $('#txtLogReceiveUser').val().trim();
                LogEmailLisScModel.ReceiveEmail = $('#txtLogEmail').val().trim();
                $('#EmailLogList').GWDataTable('load', LogEmailLisScModel);
            });

            //已发送邮件重置事件
            $('#btnLogEmailBoxReset').on('click', function () {
                LogEmailLisScModel.ReceiveUserName = '';
                LogEmailLisScModel.ReceiveEmail = '';
                $('#txtLogReceiveUser').val('');
                $('#txtLogEmail').val('');
                $('#EmailLogList').GWDataTable('load', OutBoxEmailLisScModel);
            });

            //$('#txtLogEmail').on('keydown', function (e) {
            //    if (e.keyCode === 13 && $(this).val().trim() != "") {
            //        $("#btnLogEmailSearch").click();
            //    }
            //});
        }

        //未发送邮件初始化
        function initEmailOutBoxList() {
            $('#EmailOutBoxList').css('height', dataListHeight);
            var option = {
                tableTitle: '未发送邮件',
                tableIcon: true,
                showLine: true,
                columns: [
                    { title: '收件人姓名', field: 'CustomerName', align: 'left',width:120},
                    {
                        title: '类型', field: 'EmailTypeID', align: 'left', width: '100',
                        formatter: function (value) {
                            var str = '';
                            if (value === 1) {
                                str = '注册验证码';
                            } else if (value === 2) {
                                str = '注册审核';
                            }
                            return '<span title=\"' + str + '\">' + str + '</span>';
                        }
                    },

                    {
                        title: '邮箱', field: 'CustomerEmailAddress', align: 'left', width: '180', formatter: function (value) {
                            var newValue;
                            if (value != null) {
                                newValue = HtmlEncode(value);
                            }
                            return '<span title="' + newValue + '">' + newValue + '</span>';
                        }
                    },
                    //{ title: '邮件主题', field: 'EmailSubject', align: 'left', width: '140' },                    
                    {
                        title: '内容', field: 'EmailContent', align: 'left', 
                        formatter: function (value) {
                            var val = value.replace('<br/>', '');
                            return '<span title="' + val + '">' + value + '</span>';
                        }
                    },
                    //{ title: '请求时间', field: 'RequestTime', align: 'left', width: '160' },
                    {
                        title: '状态', field: 'Status', align: 'left', width: '80',
                        formatter: function (value) {
                            var str = '';
                            if (value === 0) {
                                str = '待发送';
                            } else if (value === 1) {
                                str = '发送中';
                            }
                            return str;
                        }
                    },                   
                    { title: '发送时间', field: 'LastModifyTime', align: 'center', width: '180' },
                ],
                dataUrl: dataServiceBaseUrl + 'api/SysMaintain/EmailPromoteManage/GetSendEmailOutBoxListBySC?sid=' + sid,
                queryParams: function (pageNumber, pageSize) {
                    OutBoxEmailLisScModel.PageNum = pageNumber;
                    OutBoxEmailLisScModel.PageSize = pageSize;
                    return { searchModel: OutBoxEmailLisScModel };
                },
                pagination: true,
                onLoadSuccess: function (table) {
                    setTitleClass(table);
                    $(table).find('.table-content-container .table-body .CustomerName').each(function () {
                        var txtOutBoxReceiveUser = $('#txtOutBoxReceiveUser').val().trim();
                        if (txtOutBoxReceiveUser != '' && txtOutBoxReceiveUser != '+') {
                            var html = $(this).html().replace(new RegExp(txtOutBoxReceiveUser, 'gi'), '<label class="highlight">' + txtOutBoxReceiveUser + '</label>');
                            $(this).html(html);
                        }
                    });

                    $(table).find('.table-content-container .table-body .CustomerEmailAddress').each(function () {
                        var txtOutEmail = $('#txtOutEmail').val().trim();
                        if (txtOutEmail != '' && txtOutEmail != '+') {
                            var html = $(this).html().replace(new RegExp(txtOutEmail, 'gi'), '<label class="highlight">' + txtOutEmail + '</label>');
                            $(this).html(html);
                        }
                    });
                }
            };

            $('#EmailOutBoxList').GWDataTable(option);
        }

        //已发送邮件列表
        function initEmailLogList() {
            dataListHeight = $('.sysMaintain-EmailPromoteManageFrame').height() - $('.searchArea').outerHeight(true) - $('.nav-tabs-dic').outerHeight(true);
            $('#EmailLogList').css('height', dataListHeight);
            $('#SendEmailManage iframe').css('height', dataListHeight + $('.searchArea').outerHeight(true));
            var option = {
                tableTitle: '已发送邮件',
                tableIcon: true,
                showLine: true,
                columns: [
                    { title: '收件人姓名', field: 'CustomerName', align: 'left', width: '120' },
                    {
                        title: '类型', field: 'EmailTypeID', align: 'left', width: '100',
                        formatter: function (value) {
                            var str = '';
                            if (value === 1) {
                                str = '用户注册验证码';
                            } else if (value === 2) {
                                str = '用户注册审核通过';
                            }
                            return '<span title=\"' + str + '\">' + str + '</span>';
                        }
                    },                    
                    {
                        title: '邮箱', field: 'CustomerEmailAddress', align: 'left', width: '180', formatter: function (value) {
                            var newValue;
                            if (value != null) {
                                newValue = HtmlEncode(value);
                            }
                            return '<span title="' + newValue + '">' + newValue + '</span>';
                        }
                    },
                    { title: '邮件主题', field: 'EmailSubject', align: 'left', width: '130' },
                    {
                        title: '内容', field: 'EmailContent', align: 'left', 
                        formatter: function (value) {
                            var val = value.replace('<br/>', '');
                            return '<span title="' + val + '">' + value + '</span>';
                        }
                    },
                    //{ title: '请求时间', field: 'RequestTime', align: 'left', width: '160' },
                    { title: '发送时间', field: 'SendTime', align: 'left', width: '180' }

                ],
                dataUrl: dataServiceBaseUrl + 'api/SysMaintain/EmailPromoteManage/GetSendEmailSendLogListBySC?sid=' + sid,
                queryParams: function (pageNumber, pageSize) {
                    LogEmailLisScModel.PageNum = pageNumber;
                    LogEmailLisScModel.PageSize = pageSize;
                    return { searchModel: LogEmailLisScModel };
                },
                pagination: true,
                onLoadSuccess: function (table) {
                    setTitleClass(table);
                    $(table).find('.table-content-container .table-body .CustomerName').each(function () {
                        var txtLogReceiveUser = $('#txtLogReceiveUser').val().trim();
                        if (txtLogReceiveUser != '' && txtOutBoxReceiveUser != '+') {
                            var html = $(this).html().replace(new RegExp(txtLogReceiveUser, 'gi'), '<label class="highlight">' + txtLogReceiveUser + '</label>');
                            $(this).html(html);
                        }
                    });

                    $(table).find('.table-content-container .table-body .CustomerEmailAddress').each(function () {
                        var txtLogEmail = $('#txtLogEmail').val().trim();
                        if (txtLogEmail != '' && txtOutEmail != '+') {
                            var html = $(this).html().replace(new RegExp(txtLogEmail, 'gi'), '<label class="highlight">' + txtLogEmail + '</label>');
                            $(this).html(html);
                        }
                    });
                }
            };

            $('#EmailLogList').GWDataTable(option);
        }

        //展示未发送邮件内容
        function displayOutBoxEmailContent(index) {
            var emailContent = $('#EmailOutBoxList').GWDataTable('getData')[index].EmailContent;
            $('#EmailPreviewModel .modal-body').html(emailContent);
            $('#EmailPreviewModel').modal({ backdrop: 'static', keyboard: false });
        }

        //展示已发送邮件内容
        function displayEmailLogContent(index) {
            var emailContent = $('#EmailLogList').GWDataTable('getData')[index].EmailContent;
            $('#EmailPreviewModel .modal-body').html(emailContent);
            $('#EmailPreviewModel').modal({ backdrop: 'static', keyboard: false });
        }
    </script>
</body>
</html>
