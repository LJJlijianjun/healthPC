<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>授权管理</title>
    <!--plugin styles-->
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/datatables/media/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/select2/dist/css/select2.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/jquery-ui/themes/base/autocomplete.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap-switch/dist/css/bootstrap3/bootstrap-switch.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.css" rel="stylesheet" />
    <!--mine plugin-->
    <link href="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.css?v=1.0.1" rel="stylesheet" />
    <link href="../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../assets/vendors/gw-selectOrg/dist/gw-selectOrg.min.css?v=1.0.1" rel="stylesheet" />
    <link href="../../assets/vendors/gw-userOrgSelector/src/gw-userOrgSelector.css" rel="stylesheet" />
    <!--mine style-->
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/vendors/iCheck/skins/square/blue.css" rel="stylesheet" />
</head>
<body style="overflow-y:hidden">
    <div class="sysMaintain-userAuthorizeMaintain">
        <div class="mt10" id="content">
            <div class="btn-toolbar searchContainer">
                
            </div>
            <div class="mt10" id="tablesContain">
            </div>
        </div>
        <a id="totop" href="#" title="回到顶部"><i class="fa fa-angle-up"></i></a>
        <!--选人模态框beging-->
        <div class="modal fade" id="AuthorizeModal" tabindex="-1" role="dialog" aria-labelledby="AuthorizeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <button class="close" id="btnCloseAuthorizeModal" data-dismiss="modal" type="button" aria-hidden="true" title="关闭">&times;</button>
                        <iframe id="userSelectorFrame" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>
        <!--选人模态框end-->
        <!--执行权限回顾详情模态框beging-->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="close" data-dismiss="modal" type="button" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h5 class="modal-title bold">详情</h5>
                    </div>
                    <div class="modal-body">
                        <p class="lh30 break-all" id="myModal_Content"></p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <!--执行权限回顾详情模态框end-->
    </div>
    <!--[if lt IE 9]>
    <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <!-- 应该先引用jQuery UI 再引用BootStrap -->
    <!--base js-->
    <script type="text/javascript" src="../../assets/vendors/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="../../assets/js/jquery-tools-min.js"></script>
    <script type="text/javascript" src="../../assets/js/config.min.js?v=1.0.0"></script>
    <script type="text/javascript" src="../../assets/js/auth.min.js?v=1.0.0"></script>
    <script type="text/javascript" src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/bootstrap-switch/dist/js/bootstrap-switch.min.js"></script>
    <script src="../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.js" type="text/javascript"></script>
    <script type="text/javascript" src="../../assets/vendors/select2/dist/js/select2.full.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script type="text/javascript" src="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.js?v=1.0.1"></script>
    <script src="../../assets/vendors/gw-userOrgSelector/src/gw-userOrgSelector.js"></script>
    <script src="../../assets/vendors/gw-selectOrg/dist/gw-selectOrg.min.js?v=1.0.1"></script>
    <script type="text/javascript" src="../../assets/vendors/bootbox.js/bootbox.js"></script>
    <script type="text/javascript" src="../../assets/vendors/jquery-validation/dist/jquery.validate.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/twbs-pagination/jquery.twbsPagination.js"></script>
    <script type="text/javascript" src="../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script type="text/javascript" src="../../assets/vendors/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/json3/lib/json3.min.js"></script>
    <script type="text/javascript" src="../../assets/js/common.min.js?v=1.0.3"></script>
    <script type="text/javascript" src="../../assets/vendors/iCheck/icheck.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/platform.js/platform.js"></script>
    <script type="text/javascript">
        //用户机构所在机构Id
        var Global_UserOrgId = '';
        var Global_ArrRole = [];
        var Global_UserName = '';
        //查询用户权限类别
        var userAuthorizeScModel = {
            OrgID: '',
            RoleId: ''
        }

        /*
         *添加用户授权参数
         *因子窗口调用父窗口函数，保存参数
         */
        var Global_addUserAuthorizeParam = {
            roleId: 0,
            tableId: ''
        }
        $(function () {
            AuthUtility.Auth(function () {
                getBtnList(function () {
                    loadtUserInfo(function () {
                        loadUserAuthorizeList(loadUserAuthorizeListItem);
                    });
                    initSelUserOrg();
                    toTopEvent();
                });
            });
        });

        // 获取该页面操作按钮
        function getBtnList(fun) {
            $.ajax({
                type: 'get',
                url: dataServiceBaseUrl + 'api/UserRole/UserAuthorize/GetUserAuthorizeBtnPage?sid=' + sid,
                success: function (data) {
                    var lstElement = null;
                    if (data && data.Success === true) {
                        if (Array.isArray(data.Data) && data.Data.length > 0) {
                            lstElement = data.Data;
                            for (var i = 0; i < lstElement.length; i++) {
                                $('.searchContainer').append($(' <div class="input-group" style="width: 600px;"><span class="input-group-addon">' + lstElement[i].Span_Content + '</span><div class="w190 GWSelectOrg" id="' + lstElement[i].Div_Id + '"></div></div>'));
                            }
                        }
                        $('.searchContainer').append($('<div class="btn-group" style="float:right;"><button class="btn btn-default"  type="button" id="btnExecUserAuthorizeReview" onclick="execUserAuthorizeReview()" data-loading-text="回顾中..."><span class="fa fa-lock"></span>&nbsp;权限回顾</button></div>'));
                    }
                    fun();
                }
            });
        }

        //获取当前用户信息
        function loadtUserInfo(fun) {
            $.ajax({
                url: dataServiceBaseUrl + 'api/UserOrg/User/GetUserInfoByUserAccountID?sid=' + sid,
                type: "GET",
                dataType: "json",
                async: true,
                success: function (d) {
                    if (d.Success && d.Data) {
                        var data = d.Data;
                        if (data.MainUserInfo.TopOrgID == 1) {
                            Global_UserOrgId = data.MainUserInfo.DepID;
                        } else {
                            Global_UserOrgId = data.MainUserInfo.TopOrgID;
                        }
                        Global_UserName = data.MainUserInfo.Name;
                        fun();
                    }
                },
                error: function () {
                    bootbox.alert("获取当前账户信息出错！");
                }
            });
        }

        //机构选择
        function initSelUserOrg() {
            $('#SelUserOrg').GWSelectOrg({
                data: null,
                dataUrl: dataServiceBaseUrl + 'api/UserOrg/Org/GetOrgDeptList?sid=' + sid,
                singleSelect: true,
                onLoadingError: function () { },
                onDataLoaded: function () { },
                onDataLoadCompleted: function () { },
                onSelelcted: function (selectedOrgStr) {
                    var orgId = $('#SelUserOrg').find('div.GWSelectOrg-selection__rendered').val() || '';
                    $('.GWDataTable .fa-plus-square-o').each(function () {
                        $(this).trigger('click');
                    });
                    $('.dataList').each(function (index, item) {
                        userAuthorizeScModel.OrgID = orgId;
                        userAuthorizeScModel.RoleId = $(this).data('role');
                        $('#' + this.id).GWDataTable('load', userAuthorizeScModel);
                    });
                    if (orgId == '') {
                        $('.GWSelectOrg-selection__rendered').html('全公司');
                    }
                }
            });
        }

        //人员选择用户框打开
        function openUserSelector(tableId, roleId) {
            Global_addUserAuthorizeParam.tableId = tableId;
            Global_addUserAuthorizeParam.roleId = roleId;
            var isMultiSelect = '';
            //if (roleId == '5' || roleId == '8') {
            //    isMultiSelect = '1';
            //} else {
                isMultiSelect = '2';
            //}

            //选择部门，只有系统管理员有此权限
            var orgId = '0';
            if ($('#SelUserOrg').length > 0) {
                orgId = $('#SelUserOrg').find('div.GWSelectOrg-selection__rendered').val() || '';
                // 如果角色为“综合岗”或“初审岗”或“复审岗”，只能授权部门人员
                // 如果角色为“平台公司综合岗”只能授权平台公司人员
                if (ArrayGWWealthDeptRoleID.indexOf(roleId) != -1) {
                    orgId = GWWealthDeptOrgID;
                } else if (ArrayPlatformCompanyRoleID.indexOf(roleId) != -1) {
                    orgId = -2;
                }
            } else {
                orgId = Global_UserOrgId;
            }

            $('#userSelectorFrame').attr('src', '../../assets/vendors/gw-userOrgSelector/src/UserOrgSelector.html?' +
                //关闭按钮名
                'inputId=Authorize' +
                //选择人员
                '&selectOrgOrUser=1' +
                //是否允许多选
                '&isMultiSelect=' + isMultiSelect+
                //机构id
                '&orgRootId=' + (orgId || '0') + '&g=' + newGuid());
            $('#AuthorizeModal').modal({ backdrop: 'static', keyboard: false });
        }

        //返回顶部
        function toTopEvent() {
            // 回到顶部功能
            $('.sysMaintain-userAuthorizeMaintain').scroll(function () {
                if ($('.sysMaintain-userAuthorizeMaintain').scrollTop() < 100) {
                    $('#totop').fadeOut();
                } else {
                    $('#totop').fadeIn();
                }
            });
            $('#totop').on('click', function () {
                $('.sysMaintain-userAuthorizeMaintain').animate({ scrollTop: 0 }, 'fast');
                return false;
            });
        }

        //执行权限回顾
        function execUserAuthorizeReview() {
            //需要选择部门
            $('#btnExecUserAuthorizeReview').button('loading');
            var orgId = '';
            if ($('#SelUserOrg').length > 0) {
                orgId = $('#SelUserOrg').find('div.GWSelectOrg-selection__rendered').val() || '';
            } else {
                orgId = Global_UserOrgId;
            }
            $('.sysMaintain-userAuthorizeMaintain').loadingUI({ text: '执行中...' });
            $.ajax({
                url: dataServiceBaseUrl + 'api/UserRole/UserAuthorize/GetUserAuthorizeReviewInfo?sid=' + sid + '&orgId=' + orgId + '&roleId=' + Global_ArrRole.join(','),
                type: "GET",
                dataType: "json",
                async: true,
                success: function (data, textStatus) {
                    $('.sysMaintain-userAuthorizeMaintain').loadingUI('hide');
                    $('#btnExecUserAuthorizeReview').button('reset');
                    if (data.Success) {
                        var strInnerHTML = '<div>长城资产财富管理中心网络平台用户授权信息回顾：</div><ul>';
                        if (Array.isArray(data.Data.ErrorInfo) && data.Data.ErrorInfo.length > 0 && (data.Data.ErrorInfo[0].Data.length > 0 || data.Data.ErrorInfo[1].Data.length > 0)) {
                            $.each(data.Data.ErrorInfo, function (index, item) {
                                var arrUserName = [];
                                if (item.ErrorType === 1) {
                                    for (var i = 0; i < item.Data.length; i++) {
                                        $('[data-id = "' + item.Data[i].RoleKeyID + '"]').css("color", "red");
                                        strInnerHTML += '<li>' + item.Data[i].Name + '用户已不存在，请将授权信息删除。</li>';
                                    }
                                }
                                if (item.ErrorType == 2) {
                                    for (var j = 0; j < item.Data.length; j++) {
                                        $('[data-id = "' + item.Data[j].RoleKeyID + '"]').css("color", "red");
                                        if (arrUserName.indexOf(item.Data[j].Name) === -1) {
                                            strInnerHTML += '<li>' + item.Data[j].Name + '用户所属机构已改变，请将原授权信息删除。</li>';
                                            arrUserName.push(item.Data[j].Name);
                                        }
                                    }
                                }
                            });
                        } else {
                            strInnerHTML += '<li>共回顾' + data.Data.CountInfo.UserCount + '个用户，' + data.Data.CountInfo.AuthorizeCount + '个授权信息，授权信息完全正确。</li>';
                            strInnerHTML += '<li>回顾时间：' + new Date().Format("yyyy-MM-dd HH:mm:ss") + '。</li>';
                            strInnerHTML += '<li>回顾人：' + Global_UserName + '。</li>';
                        }
                        strInnerHTML += '<ul>';
                        $('#myModal_Content').html($(strInnerHTML));
                        $('#myModal').modal({ backdrop: 'static', keyboard: false });
                    } else {
                        bootbox.alert({ message: data.Message || "执行权限回顾失败！", size: 'small' });
                    }
                },
                error: function () {
                    $('#btnExecUserAuthorizeReview').button('reset');
                    $('.sysMaintain-userAuthorizeMaintain').loadingUI('hide');
                    bootbox.alert({ message: "执行权限回顾失败！", size: 'small' });
                }
            });
        }

        // 加载权限列表
        function loadUserAuthorizeList(fun) {
            $.ajax({
                url: dataServiceBaseUrl + 'api/UserRole/UserAuthorize/GetUserHasRoleList?sid=' + sid,
                type: "GET",
                dataType: "json",
                async: true,
                success: function (data) {
                    var userRoleList = data.Data;
                    var tablePrefix = "userAuthorize_";
                    $.each(data.Data, function (index, item) {
                        var tableId = tablePrefix + item.Role_ID;
                        var strHtml = '<div id="' + tableId + '" class="dataList" data-role="' + item.Role_ID + '" style="min-height: 100px;margin-bottom:30px;"></div>';
                        $('#tablesContain').append(strHtml);
                        Global_ArrRole.push(item.Role_ID);
                        fun(tableId, item.Role_ID, item.Role_Name);
                    });
                },
                error: function () {
                    bootbox.alert("获取当前账户可维护的权限列表出错！");
                }
            });
        }

        // 加载权限列表项
        function loadUserAuthorizeListItem(tableId, roleId, roleName) {
            var orgId = '';
            if ($('#SelUserOrg').length>0) {
                orgId = $('#SelUserOrg').find('div.GWSelectOrg-selection__rendered').val() || '';
            } else {
                orgId = Global_UserOrgId;
            }
            userAuthorizeScModel.OrgID = orgId;
            userAuthorizeScModel.RoleId = roleId;

            var btnList = [];
            btnList.push({ 'id': 'btnAdd_' + tableId, 'faClass': 'plus', 'text': '添加', 'onclick': 'openUserSelector(\'' + tableId + '\',\'' + roleId + '\')' });
            btnList.push({ 'id': 'btnDel_' + tableId, 'faClass': 'trash-o', 'text': '删除', 'onclick': 'delUserAuthorize(\'' + tableId + '\',\'' + roleId + '\')' });

            var option = {
                dataUrl: dataServiceBaseUrl + 'api/UserRole/UserAuthorize/GetUserAuthorizeList?sid=' + sid,
                queryParams: function () {
                    return { scModel: userAuthorizeScModel };
                },
                tableTitle: roleName,
                tableIcon: true,
                checkbox: true,
                multiCheck: true,
                tableOverflowY: 'visible',
                tableCollapse: true,
                showLine: true,
                toolbar: { 'btn': btnList },
                columns: [
                        {
                            title: '姓名', field: 'Name', align: 'left', width: '130', formatter: function (value, rowData) {
                                return '<div data-ID="' + rowData.ID + '"><a href="javascript:void(0);" onclick="openUserProfile(\'' + rowData.Account + '\');">' + value + '</a></div>';
                            }
                        },
                        {
                            title: '所属机构', field: 'TopOrgName', align: 'left', width: '130', formatter: function (value, rowData) {
                                return "<div data-ID=" + rowData.ID + ">" + value + "</div>";
                            }
                        },
                        {
                            title: '所属部门', field: 'DepName', align: 'left', width: '130', formatter: function (value, rowData) {
                                return "<div data-ID=" + rowData.ID + ">" + value + "</div>";
                            }
                        }
                ],
                pagination: false,
                onLoadSuccess: function (table, data) {
                    var len = data.rows.length;
                    $('#' + tableId + ' .table-title-text').html(roleName + '（' + len + '人）');
                }
              
            };

            $('#' + tableId).GWDataTable(option);
        }

        // 用户授权选择用户框的回调函数，将返回的人员添加到对用的角色中
        function addUserOrgToList() {
            var selectedUserArr = document.getElementById('userSelectorFrame').contentWindow.getSelectedItems();
            $('#btnCloseAuthorizeModal').click();
            var arrUserAuthorize = [];
            if (selectedUserArr && selectedUserArr.length > 0) {
                for (var i = 0; i < selectedUserArr.length; i++) {
                    var userAuthorize = {};
                    userAuthorize.Emp_ID = selectedUserArr[i].Emp_ID;
                    userAuthorize.Org_ID = -1;
                    userAuthorize.Role_ID = Global_addUserAuthorizeParam.roleId;
                    userAuthorize.Role_Type = 1;
                    userAuthorize.Module_ID = 0;
                    userAuthorize.Auth_Type = 0;
                    userAuthorize.Object_Id = null;
                    userAuthorize.OrgEmp_ID = selectedUserArr[i].OrgEmpId;
                    userAuthorize.Role_OrgID = null;
                    arrUserAuthorize.push(userAuthorize);
                }
            }
            $.ajax({
                url: dataServiceBaseUrl + 'api/UserRole/UserAuthorize?sid=' + sid + '&clientInfo=' + getClientInfo(),
                type: "POST",
                dataType: "json",
                async: true,
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(arrUserAuthorize),
                success: function (data, textStatus) {
                    if (data.Success == false) {
                        if (data.Message == "InvalidUser") {
                            window.location.replace = '../Common/NoRight.html';
                        } else {
                            if (data.Message) {
                                bootbox.alert(data.Message);
                            } else {
                                bootbox.alert('授权失败');
                            }
                        }
                    }
                    if (data.Success === true) {
                        bootbox.alert('授权成功');
                        var orgId = '';
                        if ($('#SelUserOrg').length > 0) {
                            orgId = $('#SelUserOrg').find('div.GWSelectOrg-selection__rendered').val() || '';
                        } else {
                            orgId = Global_UserOrgId;
                        }
                        userAuthorizeScModel.OrgID = orgId;
                        userAuthorizeScModel.RoleId = Global_addUserAuthorizeParam.roleId;
                        $('#' + Global_addUserAuthorizeParam.tableId).GWDataTable('load', userAuthorizeScModel);
                    }
                },
                error: function () {
                    bootbox.alert('授权失败');
                }
            });
        }

        //删除用户授权
        function delUserAuthorize(tableId, roleId) {
            var rows = $('#' + tableId).GWDataTable('getChecked');
            var arrId = [];
            $.each(rows, function (index, item) {
                arrId.push(item.ID);
            });

            if (arrId.length === 0) {
                bootbox.alert({ message: "请选择要删除的行！", size: 'small' });
            } else {
                bootbox.confirm({
                    size: 'small',
                    message: "确定要删除吗？",
                    callback: function (result) {
                        if (result === true) {
                            $.ajax({
                                url: dataServiceBaseUrl + 'api/UserRole/UserAuthorize?sid=' + sid + "&ids=" + arrId.join(',') + '&clientInfo=' + getClientInfo(),
                                type: "DELETE",
                                dataType: "json",
                                async: true,
                                success: function (data, textStatus) {
                                    if (data.Success == false) {
                                        if (data.Message == "InvalidUser") {
                                            window.location.replace = '../Common/NoRight.html';
                                        } else {
                                            bootbox.alert(data.Message || '删除失败');
                                        }
                                    }
                                    if (data.Success === true) {
                                        bootbox.alert('删除成功');
                                    }
                                    var orgId = '';
                                    if ($('#SelUserOrg').length > 0) {
                                        orgId = $('#SelUserOrg').find('div.GWSelectOrg-selection__rendered').val() || '';
                                    } else {
                                        orgId = Global_UserOrgId;
                                    }
                                    userAuthorizeScModel.OrgID = orgId;
                                    userAuthorizeScModel.RoleId = roleId;
                                    $('#' + tableId).GWDataTable('load', userAuthorizeScModel);
                                },
                                error: function () {
                                    bootbox.alert("删除失败！");
                                }
                            });
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
