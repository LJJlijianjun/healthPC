<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>操作日志</title>
    <link href="../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../assets/vendors/select2/dist/css/select2.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/smalot-bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <link href="../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.css" rel="stylesheet" />
    <link href="../../assets/vendors/gw-userOrgSelector/dist/gw-userOrgSelector.min.css" rel="stylesheet" />
    <link href="../../assets/css/base.css" rel="stylesheet" />
    <link href="../../assets/vendors/jsoneditor/dist/jsoneditor.min.css" rel="stylesheet" />
    <link href="../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.css?v=1.0.1" rel="stylesheet" />
    <style type="text/css">
        .searchArea .btn {
            height: 34px;
        }
    </style>
</head>
<body>
    <div class="sysMaintain-sysOperationLogView">
        <div class="searchArea">
            <div class="row">
                <div class="col-xs-5">
                    <div class="input-group">
                        <span class="input-group-addon">操作人</span>
                        <input class="form-control" id="txtOperationUser" name="txtOperationUser" data-popover-placement="bottom" type="text" readonly="readonly" placeholder="操作人" />
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="input-group">
                        <span class="input-group-addon">模块类型</span>
                        <select class="form-control" name="selModelType" id="selModelType">
                            <option value="-1">全部</option>
                        </select>
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="input-group">
                        <span class="input-group-addon">操作类型</span>
                        <select class="form-control" name="selOperationType" id="selOperationType">
                            <option value="-1">全部</option>
                            <option value="1">新增</option>
                            <option value="2">删除</option>
                            <option value="3">修改</option>
                            <option value="4">查询</option>
                        </select>
                    </div>
                </div>
                <div class="col-xs-5">
                    <div class="input-group">
                        <span class="input-group-addon">操作时间从</span>
                        <input class="form-control" id="txtStartDate" name="txtStartDate" readonly="readonly" type="text" />
                        <span class="input-group-addon">至</span>
                        <input class="form-control" id="txtEndDate" name="txtEndDate" readonly="readonly" type="text" />
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="input-group">
                        <div class="btn-group">
                            <button class="btn btn-default" id="btnSearch" type="button">
                                <span class="fa fa-search"></span> 检索
                            </button>
                            <button class="btn btn-default" id="btnReset" type="button">
                                <span class="fa fa-repeat"></span> 重置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dataList">
        </div>
        <!--modal弹出框 begin-->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button class="close" data-dismiss="modal" type="button" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h5 class="modal-title bold" id="modal-title"></h5>
                    </div>
                    <div class="modal-body">
                        <div id="operationLogDetail"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <!--modal弹出框 end-->
    </div>
    <div class="none" id="btnList">
        <!--<button class="btn btn-default" type="button" id="btnExprot" onclick="exportExcel()"><span class="fa fa-download"></span>&nbsp;导出Excel</button>-->
    </div>
    <iframe class="w1 h1 none" id="hidFileFrame"></iframe>
    <!--[if lt IE 9]>
    <script src="../../assets/vendors/html5shiv/dist/html5shiv.min.js" type="text/javascript"></script>
    <script src="../../assets/vendors/respond/src/respond.js" type="text/javascript"></script>
    <![endif]-->
    <script type="text/javascript" src="../../assets/vendors/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="../../assets/js/jquery-tools-min.js"></script>
    <script type="text/javascript" src="../../assets/js/config.min.js?v=1.0.0"></script>
    <script type="text/javascript" src="../../assets/js/auth.min.js?v=1.0.0"></script>
    <script type="text/javascript" src="../../assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/select2/dist/js/select2.full.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
    <script type="text/javascript" src="../../assets/vendors/twbs-pagination/jquery.twbsPagination.js"></script>
    <script type="text/javascript" src="../../assets/vendors/smalot-bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/smalot-bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    <script type="text/javascript" src="../../assets/js/common.min.js?v=1.0.3"></script>
    <script src="../../assets/vendors/gw-userOrgSelector/dist/gw-userOrgSelector.min.js"></script>
    <script type="text/javascript" src="../../assets/vendors/bootbox.js/bootbox.js"></script>
    <script type="text/javascript" src="../../assets/vendors/jsoneditor/dist/jsoneditor.min.js"></script>
    <script src="../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.js" type="text/javascript"></script>
    <script src="../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.js?v=1.0.1" type="text/javascript"></script>
    <script type="text/javascript">
        var sysOperationScModel = {
            UserName: '',
            ModuleTypeKV: -1,
            OperationType: -1,
            StartTime: '',
            EndTime: ''
        }

        $(function () {
            bootbox.setLocale("zh_CN");
            AuthUtility.Auth(function () {
                initSearch();
                initOperationUserTagsInput();
                initDataList();
            });
        });

        var clientInfo = function () {
            var _clientInfo = {
                BrowserType: platform.name,
                BrowserVersion: platform.version,
                BrowserPlatform: platform.os.toString().replace(/\s{1,}/g, '&npsb'),
                Screen: { Width: screen.width, Height: screen.height }
            }
            return JSON.stringify(_clientInfo);
        }

        //初始化查询条件
        function initSearch() {
            initDateSelecter();
            var scModel = {};
            scModel.TypeId = 7;
            scModel.IsActive = 1;
            scModel.PageNum = 1;
            scModel.PageSize = 0;
            $.ajax({
                url: dataServiceBaseUrl + 'api/SysMaintain/Dictionary?sid=' + sid,
                type: "GET",
                dataType: "json",
                async: true,
                data: scModel,
                success: function (data) {
                    var items = [];
                    if (data.Data) {
                        $.each(data.Data.rows, function (index, obj) {
                            var item = {};
                            item.id = obj.Dkey;
                            item.text = obj.DValue;
                            items.push(item);
                        });
                    }
                    $("#selModelType").select2({ minimumResultsForSearch: -1, data: items });
                },
                error: function () {
                    bootbox.alert("加载数据字典类型失败！");
                }
            });

            $("#selOperationType").select2({
                minimumResultsForSearch: -1
            });

            $("#btnReset").click(function () {
                $('[name=txtStartDate]').val('');
                $('[name=txtEndDate]').val('');
                $('#selModelType').val('-1').trigger('change.select2');
                $('#selOperationType').val('-1').trigger('change.select2');
                $('#txtOperationUser').tagsinput('removeAll');

                sysOperationScModel.UserName = '';
                sysOperationScModel.ModuleTypeKV = -1;
                sysOperationScModel.OperationType = -1;
                sysOperationScModel.StartTime = '';
                sysOperationScModel.EndTime = '';
                $('.dataList').GWDataTable('load', sysOperationScModel);
            });

            $("#btnSearch").click(function () {
                var userName = '';
                if ($('#txtOperationUser').tagsinput('items').length > 0) {
                    userName = $('#txtOperationUser').tagsinput('items')[0].UserAccountID;
                }
                sysOperationScModel.UserName = userName;
                sysOperationScModel.ModuleTypeKV = $('#selModelType').val();
                sysOperationScModel.OperationType = $('#selOperationType').val();
                sysOperationScModel.StartTime = $('[name=txtStartDate]').val();
                sysOperationScModel.EndTime = $('[name=txtEndDate]').val();

                $('.dataList').GWDataTable('load', sysOperationScModel);
            });

        }

        function initDateSelecter() {
            var option = {
                language: 'zh-CN',
                weekStart: 1,
                todayBtn: 1,
                todayHighlight: 1,
                startView: 2,
                minView: 2,
                autoclose: 1,
                format: 'yyyy-mm-dd',
                forceParse: true,
                pickerPosition: "bottom-right"
            }
            $('[name=txtStartDate]').datetimepicker(option);
            $('[name=txtEndDate]').datetimepicker(option);
        }

        var openModal = (function () {
            var editor;
            return function (columnName, index) {
                var message = $('.dataList').GWDataTable('getData')[index][columnName];
                var title = '';
                if (columnName === 'OperationContent') {
                    title = '操作详情';
                } else if (columnName === 'ClientInfo') {
                    title = '客户端详情';
                }

                if (!editor) {
                    var container = document.getElementById('operationLogDetail');
                    var options = {};
                    editor = new JSONEditor(container, options);
                    editor.set(JSON.parse(message));
                } else {
                    editor.set(JSON.parse(message));
                }

                $('#modal-title').html(title);
                $('#myModal').modal({ backdrop: 'static', keyboard: false });
            }
        })();

        // 初始化收件人控件
        function initOperationUserTagsInput() {
            $('#txtOperationUser').GWUserOrgSelector({
                selectOrgOrUser: 1, // 选择部门还是人员 1：人员，2：部门。
                isMultiSelect: false,
                selectorPath: '../../assets/vendors/gw-userOrgSelector/src/UserOrgSelector.html',
                orgRootId: 0
            });
        }

        // 初始化数据dataList
        function initDataList() {
            $('.dataList').css('height', $('.sysMaintain-sysOperationLogView').height() - $('.searchArea').outerHeight(true));
            var option = {
                tableTitle: '操作日志',
                tableIcon: true,
                toolbar: { 'selector': '#btnList' },
                showLine: true,
                columns:
                 [
                    {
                        title: '操作人', field: 'CreateUserName', align: 'left', formatter: function (value, rowData) {
                            return '<a href="javascript:void(0);" onclick="openUserProfile(\'' + rowData.CreateUserAccountID + '\');">' + value + '</a>';
                        }
                    },
                    { title: '模块类型', field: 'ModuleTypeName', align: 'left', width: '180' },
                    { title: '功能名', field: 'FunctionName', align: 'left', width: '180' },
                    { title: '操作类型', field: 'OperationName', align: 'center', width: '150' },
                    { title: '操作时间', field: 'CreateTime', align: 'center', width: '200' },
                    //{
                    //    title: '操作详情', field: 'OperationContent', align: 'center', width: '80',
                    //    formatter: function (value, rowData, index) {
                    //        return '<a href=\"javascript:void(0);\" onclick=openModal(\"OperationContent\",' + index + ')>详情</a>';
                    //    }
                    //},
                    //    {
                    //        title: '客户端信息', field: 'ClientInfo', align: 'center', width: '100',
                    //        formatter: function (value, rowData, index) {
                    //            return '<a href=\"javascript:void(0);\" onclick=openModal(\"ClientInfo\",' + index + ')>详情</a>';
                    //        }
                    //    },
                         { title: '备注', field: 'Remark', align: 'left',width:'200' }
                 ],
                dataUrl: dataServiceBaseUrl + 'api/SysMaintain/SysOperationLog?sid=' + sid,
                queryParams: function (pageNumber, pageSize) {
                    sysOperationScModel.PageNum = pageNumber;
                    sysOperationScModel.PageSize = pageSize;
                    return { scModel: sysOperationScModel };
                },
                pagination: true,
                onLoadSuccess: function (table) {
                }
            };

            $('.dataList').GWDataTable(option);
        }

        // 导出Excel
        //function exportExcel() {

        //    var searchModel = new Object();
        //    searchModel.UserName = sysOperationScModel.UserName;
        //    searchModel.ModuleTypeKV = sysOperationScModel.ModuleTypeKV;
        //    searchModel.OperationType = sysOperationScModel.OperationType;
        //    searchModel.StartTime = sysOperationScModel.StartTime;
        //    searchModel.EndTime = sysOperationScModel.EndTime;
        //    searchModel.PageNum = 1;
        //    searchModel.PageSize = 0;
        //    var url = dataServiceBaseUrl + 'api/SysMaintain/SysOperationLog/ExportToExcel?scModel=' + JSON.stringify(searchModel) + '&sid=' + sid;
        //    $('#hidFileFrame').attr('src', url);
        //}
    </script>
</body>
</html>
