<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>组织机构或用户选择</title>
    <link href="../../../../assets/css/base.css" rel="stylesheet" />
    <link href="../../../../assets/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../../../assets/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../../../assets/vendors/LoadingUI/jquery.loadingui.css" rel="stylesheet" />
    <link href="../../../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.css?v=1.0.1" rel="stylesheet" />
    <link href="../../../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.css" rel="stylesheet" />
    <script src="../../../../assets/vendors/bootbox.js/bootbox.js" type="text/javascript"></script>
    <link href="../../../../assets/vendors/zTree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" />
    <link href="../../../../assets/vendors/iCheck/skins/square/blue.css" rel="stylesheet" />
    <link href="../../../../assets/css/common.min.css?v=1.0.2" rel="stylesheet" />
    <link href="../../../../assets/css/page.min.css?v=1.0.2" rel="stylesheet" />
    <style>
        .user-org-selector .modal-context .modelBody .leftTree .ztree li .chk {
            margin: 3px 2px 0 2px;
        }
    </style>
</head>
<body class="user-org-selector">
    <div class="modal-context">
        <div class="modal-head-search">
            <div class="modal-title">
                <span>选择人员</span>
            </div>
            <div class="input-group searchTool">
                <input class="form-control h35" id="txtTitle" name="txtTitle" type="text" placeholder="拼音首字母、姓名、电话" />
                <span class="input-group-btn">
                    <button class="btn btn-primary required" id="btnSearch">搜索</button>
                </span>
            </div>
            <div>
                <button class="close" id="btnCloseModal" type="button" title="关闭">&times;</button>
            </div>
        </div>

        <div class="modelBody">
            <div class="leftTree">
                <div class="ztree" id="OrgTree">
                </div>
            </div>
            <div class="infoSelector" id="divContent">
            </div>
            <div class="noData fade">
                <div style="display: inline-block;">
                    <img src="../../../../assets/img/clock.png" />
                </div>
                <div class="txtNoData">
                    没有检索到相关数据。
                </div>
            </div>
        </div>
        <div class="footTools" id="footTools">
            <div class="input-group">
                <span class="input-group-addon" id="spanCooperativeItems">已选择人员</span>
                <input id="txtCooperativeItems" name="txtCooperativeItems" type="text" readonly="readonly" />
            </div>
            <div class="footToolBtns">
                <button class="btn btn-primary btn-right-align-first" id="btnAffirmItemsToList" type="button">
                    <span>确定</span><span id="candidateItemsNumBadge" class="badge">0</span>
                </button>
                <button class="btn btn-primary btn-right-align" id="btnReset" type="button">
                    <span>清空</span>
                </button>
            </div>
        </div>
    </div>
    <div class="flyingSign" id="flyingAdd">+</div>
    <div class="flyingSign" id="flyingSubduct">-</div>
</body>
</html>
<script src="../../../../assets/vendors/jquery/dist/jquery.min.js"></script>
<script src="../../../../assets/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="../../../../assets/vendors/bootbox.js/bootbox.js"></script>
<script src="../../../../assets/vendors/mustache.js/mustache.min.js"></script>
<script src="../../../../assets/js/jquery-tools-min.js"></script>
<script src="../../../../assets/vendors/LoadingUI/jquery.loadingui.js"></script>
<script src="../../../../assets/vendors/gw-dataTable/dist/gw-dataTable.min.js?v=1.0.1"></script>
<script src="../../../../assets/vendors/zTree/js/jquery.ztree.core.js"></script>
<script src="../../../../assets/vendors/zTree/js/jquery.ztree.excheck.js"></script>
<script src="../../../../assets/vendors/iCheck/icheck.min.js"></script>
<script src="../../../../assets/js/config.min.js?v=1.0.0"></script>
<script src="../../../../assets/js/auth.min.js?v=1.0.0"></script>
<script src="../../../js/common.js?v=1.0.0"></script>
<script src="../../../../assets/vendors/bootstrap-tagsinput/dist/bootstrap-tagsinput.js" type="text/javascript"></script>
<script type="text/javascript">
    // 是否为确认按钮
    var isAffirmClick = 0;
    // 全局变量，已选择信息数组
    var arrSelectedUser = new Array();
    var arrSelectedOrg = new Array();

    // 控件选择类型
    // selectOrgOrUser = 1; //选择人员
    // selectOrgOrUser = 2;// 选择机构
    var selectOrgOrUser = 1;

    // 多选配置
    // isMultiSelect = 2
    // isMultiSelect = 2
    var isMultiSelect = $.url().param('isMultiSelect');

    // 机构树根节点id
    //orgRootId = 0; 全公司  = -1 分公司  = -2 子公司
    var orgRootId = $.url().param('orgRootId');


    var zTreeObj,
        zTreeSetting
    //==============================组织机构树初始化设置 start====================================================

    // 异步数据过滤
    function ajaxDataFilter(treeId, parentNode, responseData) {
        var orgTreeRoot = new Array();

        if (responseData.Success) {
            var data = responseData.Data;

            if ($.isArray(data)) {

                for (var i = 0; i < data.length; i++) {
                    var obj = new Object();
                    obj.id = data[i].orgInfo.Org_ID;
                    obj.name = data[i].orgInfo.Name;
                    obj.open = false;
                    obj.checked = data[i].isChecked;
                    obj.isParent = (data[i].orgInfo.FatherID == 0) || (data[i].orgInfo.FatherID == 1);
                    obj.children = [];
                    orgTreeRoot.push(obj);
                }
            } else {
                var obj = new Object();
                obj.id = data.orgInfo.Org_ID;
                obj.name = data.orgInfo.Name;
                obj.open = false;
                obj.checked = data.isChecked;
                obj.isParent = (data.orgInfo.FatherID == 0) || (data.orgInfo.FatherID == 1);
                obj.children = [];
                orgTreeRoot.push(obj);
            }
        }
        return orgTreeRoot;
    };

    // 树选择事件
    function zTreeOnCheck(event, treeId, treeNode) {
        $('.user-org-selector').loadingUI({ message: '加载中...' });
        $.ajax({
            url: dataServiceBaseUrl + 'api/SysMaintain/RecommendedUser/GetAllRecommendedUserInfoListByOrgID?sid=' + sid,
            method: 'get',
            data: { orgID: treeNode.id },
            dataType: 'json',
            success: function (data) {
                if (data.Success) {
                    if (data.Data.length > 0) {
                        if (treeNode.checked) {
                            for (var j = 0; j < data.Data.length; j++) {
                                var userInfo = data.Data[j];
                                var idCountFlag = 0;
                                for (var i = 0; i < arrSelectedUser.length; i++) {
                                    if (arrSelectedUser[i].OrgEmpId == userInfo.OrgEmp_ID) {
                                        idCountFlag += 1;
                                        break;
                                    }
                                }

                                if (idCountFlag == 0) {
                                    var obj = new Object();
                                    obj.OrgEmpId = userInfo.OrgEmp_ID;
                                    obj.Emp_ID = userInfo.Emp_ID;
                                    obj.UserAccountID = userInfo.Account;
                                    obj.UserName = userInfo.Name;
                                    obj.Org_ID = userInfo.Org_ID;
                                    obj.Organize_Name = userInfo.Organize_Name;
                                    obj.IsMainOrg = userInfo.IsMainOrg;

                                    arrSelectedUser.push(obj);
                                }
                            }

                            // 更新徽章计数
                            renewCandidateUserNum();
                            // 更新已选择人员输入框
                            renewCandidateUserBox();
                            // 根据已选择人员选中右侧
                            setUserListChecked()
                        } else {
                            for (var j = 0; j < data.Data.length; j++) {
                                var userInfo = data.Data[j];

                                for (var i = 0; i < arrSelectedUser.length; i++) {
                                    if (arrSelectedUser[i].OrgEmpId == userInfo.OrgEmp_ID) {
                                        arrSelectedUser.splice(i, 1);
                                        break;
                                    }
                                }
                            }

                            // 更新徽章计数
                            renewCandidateUserNum();
                            // 更新已选择人员输入框
                            renewCandidateUserBox();
                            // 根据已选择人员选中右侧
                            setUserListChecked()
                        }

                        $('.user-org-selector').loadingUI('hide');
                    }
                    $('.user-org-selector').loadingUI('hide');
                }
            },
            error: function () {
                $('.user-org-selector').loadingUI('hide');
                bootbox.alert({ message: '人员信息加载失败！' + data.Message, size: 'small' });
            }
        });
    }


    // 根据组织机构父节点id分配查询地址
    function getOrgSourceUrl(orgRootId) {
        var rootUrl;
        switch (parseInt(orgRootId)) {
            case 0:
                rootUrl = dataServiceBaseUrl + 'api/UserOrg/Org/GetRootOrgList?sid=' + sid;
                break;
            case -1:
                rootUrl = dataServiceBaseUrl + 'api/UserOrg/Org/GetAllBranchInfo?sid=' + sid;
                break;
            case -2:
                rootUrl = dataServiceBaseUrl + 'api/UserOrg/Org/GetAllCompanyInfo?sid=' + sid;
                break;
            default:
                rootUrl = dataServiceBaseUrl + 'api/UserOrg/Org/GetOrganizeInfoByOrgID?orgId=' + orgRootId + '&sid=' + sid;
                break;
        }

        return rootUrl;
    }
    // 获取树异步加载地址
    function getAsyncUrl(treeId, treeNode) {
        orgEmpIDs = '';
        for (var i = 0; i < arrSelectedUser.length; i++) {
            orgEmpIDs += arrSelectedUser[i].OrgEmpId;
            orgEmpIDs += ','
        }
        orgEmpIDs = orgEmpIDs.substr(0, orgEmpIDs.length - 1)
        return dataServiceBaseUrl + 'api/SysMaintain/RecommendedUser/GetSubOrgListRecommendedByID?sid=' + sid;  //?orgID=' + treeNode.id + '&sid=' + sid;
    };

    // 获取树异步加载地址
    function getOrgEmpIDs() {
        orgEmpIDs = '';
        for (var i = 0; i < arrSelectedUser.length; i++) {
            orgEmpIDs += arrSelectedUser[i].OrgEmpId;
            orgEmpIDs += ','
        }
        return orgEmpIDs = orgEmpIDs.substr(0, orgEmpIDs.length - 1)
    };

    // 异步加载报错信息
    function zTreeOnAsyncError(event, treeId, treeNode, XMLHttpRequest, textStatus, errorThrown) {
        bootbox.alert({ message: '加载机构树失败！', size: 'small' });
    };

    // 点击机构树节点时触发
    function zTreeOnClick(event, treeId, treeNode) {

        if (treeNode.id) {
            // 点击激活树节点后 根据配置项（开始加载人员信息数据 或 开始加载组织机构信息）
            if (selectOrgOrUser == 1) {
                if (treeNode.id != 0) {
                    if (treeNode.id > 1) {
                        $('.infoSelector').loadingUI();

                        $('.noData').removeClass('in');
                        $('.noData').css('z-index', '-1');

                        // 开始加载人员信息数据
                        loadUserInfo(treeNode);
                    }
                }
            } 
        }
    };

    function ztreeBind(data) {
        var orgTreeRoot = new Array();
        if ($.isArray(data)) {
            for (var i = 0; i < data.length; i++) {
                var obj = new Object();
                obj.id = data[i].Org_ID;
                obj.name = data[i].Name;
                obj.open = false;
                obj.isParent = (data[i].FatherID == 0) || (data[i].FatherID == 1);
                obj.children = [];
                orgTreeRoot.push(obj);
            }
        } else {
            var obj = new Object();
            obj.id = data.Org_ID;
            obj.name = data.Name;
            obj.open = false;
            obj.isParent = (data.FatherID == 0) || (data.FatherID == 1);
            obj.children = [];
            orgTreeRoot.push(obj);
        }
        zTreeObj = $.fn.zTree.init($("#OrgTree"), zTreeSetting, orgTreeRoot);
    }

    //==============================组织机构树初始化设置 end====================================================
    // 供引用页面获取已选择信息
    function getSelectedItems() {
        if (selectOrgOrUser == 1) {
            return arrSelectedUser;
        }
    }

    // 供引用页面查询关闭事件源头
    function getAffirmClickSource() {
        return isAffirmClick;
    }

    $(function () {
        AuthUtility.Auth(function () {
            var orgEmpIDs = '';
            zTreeSetting = {
                view: {
                    showLine: false,
                    selectedMulti: false,
                    showTitle: true
                },
                key: {
                    title: "Name",
                    name: "Name"
                },
                async: {
                    enable: true,
                    url: getAsyncUrl,
                    autoParam: ['id=SCOrgID'],
                    type: "post",
                    dataType: "json",
                    dataFilter: ajaxDataFilter,
                    otherParam: { "SCOrgEmpIDs": getOrgEmpIDs }
                },
                check: {
                    enable: true,
                    chkStyle: "checkbox",
                    nocheckInherit: true
                },
                callback: {
                    onAsyncError: zTreeOnAsyncError,
                    onClick: zTreeOnClick,
                    onCheck: zTreeOnCheck
                }
            }
            initElement();
        });
        bindEvent();
    });

    // 初始化控件
    function initElement() {
        var orgTreeRoot = new Array();

        if (selectOrgOrUser == 1) {
            $('.modal-title span').text('人员选择');
        }

        if (isMultiSelect == 1) {
            $('.modal-title span').text($('.modal-title span').text() + '（单选）');
        } else if (isMultiSelect == 2) {
            $('.modal-title span').text($('.modal-title span').text() + '（多选）');
        }

        switch (parseInt(orgRootId)) {
            case 0:

                orgTreeRoot = [{ id: 1, name: '公司总部', open: false, isParent: true, children: [] },
                                { id: -1, name: '分公司', open: false, isParent: true, children: [] },
                                { id: -2, name: '平台公司', open: false, isParent: true, children: [] }]
                zTreeObj = $.fn.zTree.init($("#OrgTree"), zTreeSetting, orgTreeRoot);

                break;
            case -1:
                orgTreeRoot = [{ id: -1, name: '分公司', open: false, isParent: true, children: [] }]
                zTreeObj = $.fn.zTree.init($("#OrgTree"), zTreeSetting, orgTreeRoot);

                // 若根节点不为最上级 则展开
                var node = zTreeObj.getNodeByParam("id", orgRootId, null);
                if (node) {
                    zTreeObj.expandNode(node, true, true, true);
                }
                break;
            case -2:
                orgTreeRoot = [{ id: -2, name: '平台公司', open: false, isParent: true, children: [] }]
                zTreeObj = $.fn.zTree.init($("#OrgTree"), zTreeSetting, orgTreeRoot);

                // 若根节点不为最上级 则展开
                var node = zTreeObj.getNodeByParam("id", orgRootId, null);
                if (node) {
                    zTreeObj.expandNode(node, true, true, true);
                }
                break;
            default:
                $.ajax({
                    url: dataServiceBaseUrl + 'api/UserOrg/Org/GetOrganizeInfoByOrgID?sid=' + sid,
                    method: 'get',
                    data: { orgId: orgRootId },
                    dataType: 'json',
                    success: function (data) {
                        if (data.Success) {
                            var obj = new Object();
                            obj.id = data.Data.Org_ID;
                            obj.name = data.Data.Name;
                            obj.open = orgRootId > 1;
                            obj.isParent = (data.Data.FatherID == 0) || (data.Data.FatherID == 1);
                            obj.children = [];
                            orgTreeRoot.push(obj);
                        }

                        zTreeObj = $.fn.zTree.init($("#OrgTree"), zTreeSetting, orgTreeRoot);


                        // 若根节点不为最上级 则展开
                        if (orgRootId > 1) {
                            var node = zTreeObj.getNodeByParam("id", orgRootId, null);
                            if (node) {
                                zTreeObj.expandNode(node, true, true, true);
                            }
                        }
                    }
                });
                break;
        }

        /********以下为直接展开root下的节点********/
        //$.ajax({
        //    url: getOrgSourceUrl(parseInt(orgRootId)),
        //    method: 'get',
        //    dataType: 'json',
        //    success: function (data) {
        //        if (data.Success) {
        //            if (data.Data) {
        //                var data = data.Data;
        //                var orgTreeRoot = new Array();
        //                if ($.isArray(data)) {
        //                    for (var i = 0; i < data.length; i++) {
        //                        var obj = new Object();
        //                        obj.id = data[i].Org_ID;
        //                        obj.name = data[i].Name;
        //                        obj.open = orgRootId > 1;
        //                        obj.isParent = (data[i].FatherID == 0) || (data[i].FatherID == 1);
        //                        obj.children = [];
        //                        orgTreeRoot.push(obj);
        //                    }
        //                } else {
        //                    var obj = new Object();
        //                    obj.id = data.Org_ID;
        //                    obj.name = data.Name;
        //                    obj.open = orgRootId > 1;
        //                    obj.isParent = (data.FatherID == 0) || (data.FatherID == 1);
        //                    obj.children = [];
        //                    orgTreeRoot.push(obj);
        //                }

        //                zTreeObj = $.fn.zTree.init($("#OrgTree"), zTreeSetting, orgTreeRoot);


        //                // 若根节点不为最上级 则展开
        //                if (orgRootId > 1) {
        //                    var node = zTreeObj.getNodeByParam("id", orgRootId, null);
        //                    if (node) {
        //                        zTreeObj.expandNode(node, true, true, true);
        //                    }
        //                } else {

        //                }
        //            }
        //        }
        //    }
        //});

        if (selectOrgOrUser == 1) {

            $('.modal-head-search .input-group').css('visibility', 'visible');
            // 初始化已选择人员输入框
            initCooperativeUserTagsInput();
        } 
    }

    // ============================人员类初始化函数 start ==============================================
    // 刷新人员选择徽章计数
    function renewCandidateUserNum() {
        // 将候选徽章计数变更为已选择数量
        $('#candidateItemsNumBadge').text(arrSelectedUser.length);
    }

    // 更新已选择条目输入框（人员选择）
    function renewCandidateUserBox() {
        $('#txtCooperativeItems').tagsinput('removeAll');
        if (arrSelectedUser && arrSelectedUser.length > 0) {
            $('.bootstrap-tagsinput input').val('');
            for (var i = 0; i < arrSelectedUser.length; i++) {
                $('#txtCooperativeItems').tagsinput('add', arrSelectedUser[i]);
            }
        }
    }

    // 根据已选择人员列表选中人员列表中的人员
    function setUserListChecked() {
        var itemChecker = undefined;
        $('.infoSelector').find('li input[type=checkbox]').iCheck('uncheck');
        for (var i = 0; i < arrSelectedUser.length; i++) {
            itemChecker = $('.infoSelector').find('input[data-orgempid=' + arrSelectedUser[i].OrgEmpId + ']');
            if (itemChecker) {
                itemChecker.iCheck('check');
                var intAllSelectedFlag = itemChecker.parent().parent().parent().parent().find('li input[type=checkbox]').length
                            - itemChecker.parent().parent().parent().parent().find('li input[type=checkbox]:checked').length;
                if (intAllSelectedFlag == 0) {
                    itemChecker.parent().parent().parent().parent().prev().find('li input[type=checkbox]').iCheck('check');
                } else {
                    itemChecker.parent().parent().parent().parent().prev().find('li input[type=checkbox]').iCheck('uncheck');
                }
            }
        }
        $('.infoSelector').loadingUI('hide')
    }

    // 初始化人员选择选择框
    function initUserCheckBox() {
        $('.infoSelector input[type=checkbox]').iCheck({
            checkboxClass: 'icheckbox_square-blue-16'
        }).on('ifClicked', function () {
            if (isMultiSelect == 2) {
                // 多项选择
                // 判断当前checkbox是否被选中
                if (!$(this).is(':checked')) {
                    $(this).iCheck('check');
                    if ($(this).hasClass('itemAll')) {

                        $(this).parent().parent().parent().parent().next().find('li input[type=checkbox]').iCheck('check');
                        $(this).parent().parent().parent().parent().next().find('li input[type=checkbox]').each(function () {
                            var userInfo = $(this).data('userinfo');
                            var obj = new Object();
                            obj.OrgEmpId = userInfo.OrgEmp_ID;
                            obj.Emp_ID = userInfo.Emp_ID;
                            obj.UserAccountID = userInfo.Account;
                            obj.UserName = userInfo.Name;
                            obj.Org_ID = userInfo.Org_ID;
                            obj.Organize_Name = userInfo.Organize_Name;
                            obj.IsMainOrg = userInfo.IsMainOrg;

                            var idCountFlag = 0;
                            for (var i = 0; i < arrSelectedUser.length; i++) {
                                if (arrSelectedUser[i].OrgEmpId == userInfo.OrgEmp_ID) {
                                    idCountFlag += 1;
                                }
                            }

                            if (idCountFlag == 0) {
                                arrSelectedUser.push(obj);
                            }
                        });

                        var node = zTreeObj.getNodeByParam("id", $(this).data('orgid'), null);
                        if (node && !node.isParent) {
                            zTreeObj.checkNode(node, true, true);
                        }

                    } else {
                        var userInfo = $(this).data('userinfo');
                        var obj = new Object();
                        obj.OrgEmpId = userInfo.OrgEmp_ID;
                        obj.Emp_ID = userInfo.Emp_ID;
                        obj.UserAccountID = userInfo.Account;
                        obj.UserName = userInfo.Name;
                        obj.Org_ID = userInfo.Org_ID;
                        obj.Organize_Name = userInfo.Organize_Name;
                        obj.IsMainOrg = userInfo.IsMainOrg;

                        var idCountFlag = 0;
                        for (var i = 0; i < arrSelectedUser.length; i++) {
                            if (arrSelectedUser[i].OrgEmpId == userInfo.OrgEmp_ID) {
                                idCountFlag += 1;
                            }
                        }

                        if (idCountFlag == 0) {
                            arrSelectedUser.push(obj);
                        }

                        var intAllSelectedFlag = $(this).parent().parent().parent().parent().find('li input[type=checkbox]').length
                        - $(this).parent().parent().parent().parent().find('li input[type=checkbox]:checked').length;
                        if (intAllSelectedFlag < 1) {
                            $(this).parent().parent().parent().parent().prev().find('li input[type=checkbox]').iCheck('check');

                            var node = zTreeObj.getNodeByParam("id", userInfo.Org_ID, null);
                            if (node && !node.isParent) {
                                zTreeObj.checkNode(node, true, true);
                            }
                        }
                    }

                    // 加号动画
                    flyingAnimate(this, $('#flyingAdd'), $('#btnAffirmItemsToList'), renewCandidateUserNum);

                    // 更新到已选择名单
                    renewCandidateUserBox();

                } else {
                    $(this).iCheck('uncheck');
                    if ($(this).hasClass('itemAll')) {

                        $(this).parent().parent().parent().parent().next().find('li input[type=checkbox]').iCheck('uncheck');
                        $(this).parent().parent().parent().parent().next().find('li input[type=checkbox]').each(function () {
                            var orgempid = $(this).data('orgempid');
                            var indexFlag;
                            for (var i = 0; i < arrSelectedUser.length; i++) {
                                if (arrSelectedUser[i].OrgEmpId == orgempid) {
                                    indexFlag = i;
                                    break;
                                }
                            }

                            arrSelectedUser.splice(indexFlag, 1);

                        });

                        var node = zTreeObj.getNodeByParam("id", $(this).data('orgid'), null);
                        if (node && !node.isParent) {
                            zTreeObj.checkNode(node, false, true);
                        }
                        
                    } else {
                        $(this).parent().parent().parent().parent().prev().find('li input[type=checkbox]').iCheck('uncheck');
                        var orgempid = $(this).data('orgempid');
                        var node = zTreeObj.getNodeByParam("id", $(this).data('orgid'), null);
                        if (node && !node.isParent) {
                            zTreeObj.checkNode(node, false, true);
                        }
                        var indexFlag;
                        for (var i = 0; i < arrSelectedUser.length; i++) {
                            if (arrSelectedUser[i].OrgEmpId == orgempid) {
                                indexFlag = i;
                                break;
                            }
                        }

                        arrSelectedUser.splice(indexFlag, 1);

                    }

                    // 减号动画
                    flyingAnimate(this, $('#flyingSubduct'), $('#btnAffirmItemsToList'), renewCandidateUserNum);

                    // 添加到已选择名单
                    renewCandidateUserBox();
                }
            } else {
                // 单项选择 默认
                // 判断当前checkbox是否被选中
                if (!$(this).is(':checked')) {
                    if ($(this).hasClass('itemAll')) {
                        return false;
                    } else {
                        $('.infoSelector').find('li input[type=checkbox]:checked').iCheck('uncheck');
                        $(this).iCheck('check');

                        var userInfo = $(this).data('userinfo');
                        var obj = new Object();
                        obj.OrgEmpId = userInfo.OrgEmp_ID;
                        obj.Emp_ID = userInfo.Emp_ID;
                        obj.UserAccountID = userInfo.Account;
                        obj.UserName = userInfo.Name;
                        obj.Org_ID = userInfo.Org_ID;
                        obj.Organize_Name = userInfo.Organize_Name;
                        obj.IsMainOrg = userInfo.IsMainOrg;

                        arrSelectedUser.length = 1;
                        arrSelectedUser[0] = obj;
                    }

                    // 加号动画
                    flyingAnimate(this, $('#flyingAdd'), $('#btnAffirmItemsToList'), renewCandidateUserNum);

                    // 更新到已选择名单
                    renewCandidateUserBox();


                } else {
                    if ($(this).hasClass('itemAll')) {
                        return false;
                    } else {
                        $(this).iCheck('uncheck');
                        arrSelectedUser.length = 0;
                    }

                    // 减号动画
                    flyingAnimate(this, $('#flyingSubduct'), $('#btnAffirmItemsToList'), renewCandidateUserNum);

                    // 添加到已选择名单
                    renewCandidateUserBox();

                }
            }
        });
        setUserListChecked()
    }

    // 初始化已选择人员输入框
    function initCooperativeUserTagsInput() {
        $('#txtCooperativeItems').tagsinput({
            itemValue: 'OrgEmpId',
            itemText: 'UserName',
            tagClass: function () {
                return 'label label-info';
            }
        });
        $('#spanCooperativeItems').text('已选择人员');

        // 使tagsinput不能自定义添加项
        $('#txtCooperativeItems').prev().find('input').css('width', 50).prop('readonly', true);

        $('#txtCooperativeItems').on('itemAdded', function (event) {
            $('.infoSelector').find('input[data-orgempid=' + event.item.OrgEmpId + ']').iCheck('check');
        });

        $('#txtCooperativeItems').on('itemRemoved', function (event) {

            var indexFlag;
            for (var i = 0; i < arrSelectedUser.length; i++) {
                if (arrSelectedUser[i].OrgEmpId == event.item.OrgEmpId) {
                    indexFlag = i;
                    break;
                }
            }

            arrSelectedUser.splice(indexFlag, 1);

            renewCandidateUserNum();
            setUserListChecked()

            var $checkBox = $('.infoSelector').find('input[data-orgempid=' + event.item.OrgEmpId + ']');

            if ($checkBox.length > 0) {
                if ($checkBox.parent().parent().parent().parent().find('li input[type=checkbox]:checked').length < 1) {
                    node = zTreeObj.getNodeByParam("id", $checkBox.parent().parent().parent().parent().prev().find('label').data('orgid'), null);

                    if (node) {
                        zTreeObj.checkNode(node, false, true);
                    }

                    $('.infoSelector').find('input[data-orgempid=' + event.item.OrgEmpId + ']').iCheck('uncheck');
                }
            } else {
                var unCheckBoxFlag = 1;
                for (var i = 0; i < arrSelectedUser.length; i++) {
                    if (arrSelectedUser[i].Org_ID == event.item.Org_ID) {
                        unCheckBoxFlag = 0;
                        break;
                    }
                }

                if (unCheckBoxFlag) {
                    node = zTreeObj.getNodeByParam("id", event.item.Org_ID, null);

                    if (node) {
                        zTreeObj.checkNode(node, false, true);
                    }

                    $('.infoSelector').find('input[data-orgempid=' + event.item.OrgEmpId + ']').iCheck('uncheck');
                }
            }
        });
        // 设置已选择的项
        setSelectedUser();
    }

    // 右侧内容区根据选择加载用户数据
    function loadUserInfo(node) {
        $.ajax({
            url: dataServiceBaseUrl + 'api/SysMaintain/RecommendedUser/GetAllRecommendedUserInfoListByOrgID?orgID=' + node.id + '&sid=' + sid,
            method: 'get',
            dataType: 'json',
            success: function (data) {
                if (data.Success) {
                    $('.infoSelector').data('nodeid', node.id);

                    if (data.Data.length > 0) {
                        var userInfoHtml = "";
                        var arrGroup = new Array();
                        var arrGroupIds = new Array();
                        for (var i = 0; i < data.Data.length; i++) {
                            data.Data[i].Photo = null;
                            var flag = arrGroupIds.indexOf(data.Data[i].Org_ID)
                            if (flag < 0) {
                                arrGroupIds[arrGroupIds.length] = data.Data[i].Org_ID
                                var obj = new Object();
                                obj.startHtml = "<div class=\"group\">" +
                                            "<ul class=\"list-inline exp-e\"><span class=\"expander showList\" data-itemlistid=\"itemList" + data.Data[i].Org_ID + "\"></span><li><label data-orgid=\"" + data.Data[i].Org_ID
                                if (isMultiSelect != 2) {
                                    obj.startHtml += "\"><span class=\"fw\">" + data.Data[i].Organize_Name + "</span></label></li>";
                                } else {
                                    obj.startHtml += "\"><input type=\"checkbox\" class=\"itemAll\" data-orgid=\"" + data.Data[i].Org_ID + "\"><span class=\"fw\">" + data.Data[i].Organize_Name + "</span></label></li>";
                                }
                                obj.startHtml += "</ul>" +
                                "<ul id=\"itemList" + data.Data[i].Org_ID + "\"class=\"list-inline collapse in itemList\">";
                                obj.endHtml = "</ul></div>"
                                obj.contextHtml = "<li><label data-orgempid=\"" + data.Data[i].OrgEmp_ID + "\" data-userid=\"" + data.Data[i].Emp_ID + "\"data-useraccountid=\"" + data.Data[i].Account + "\"" +
                                                      " data-isparttimejob=\"" + data.Data[i].IsPartTimeJob + "\"><input type=\"checkbox\" data-orgempid=\"" + data.Data[i].OrgEmp_ID + "\"data-orgid=\"" + data.Data[i].Org_ID + "\"" +
                                                      " data-userinfo =\'" + JSON.stringify(data.Data[i]) + "\' ><span class=\"textOverFlowEllipsis\"" +
                                                        "title=\"" + data.Data[i].Name + "\">" + data.Data[i].Name + "</span></label></li>";

                                arrGroup[arrGroup.length] = obj;
                            } else {
                                arrGroup[flag].contextHtml += "<li><label data-orgempid=\"" + data.Data[i].OrgEmp_ID + "\" data-userid=\"" + data.Data[i].Emp_ID + "\"data-useraccountid=\"" + data.Data[i].Account + "\"" +
                                                            " data-isparttimejob=\"" + data.Data[i].IsPartTimeJob + "\"><input type=\"checkbox\" data-orgempid=\"" + data.Data[i].OrgEmp_ID + "\"data-orgid=\"" + data.Data[i].Org_ID + "\" class=\"exceedlongtitle\"" +
                                                        " data-userinfo =\'" + JSON.stringify(data.Data[i]) + "\' ><span class=\"textOverFlowEllipsis\"" +
                                                        "title=\"" + data.Data[i].Name + "\">" + data.Data[i].Name + "</span></label></li>";

                            }
                        }

                        for (var j = 0; j < arrGroup.length; j++) {
                            userInfoHtml += arrGroup[j].startHtml;
                            userInfoHtml += arrGroup[j].contextHtml;
                            userInfoHtml += arrGroup[j].endHtml;
                        }
                        $('.infoSelector').html(userInfoHtml);

                    } else {
                        $('.infoSelector').html('');
                        $('.noData').addClass('in');
                        $('.noData').css('z-index', '1');

                        $('.txtNoData').text('该组织机构下无符合条件人员信息。');
                    }
                    // 初始化人员信息阵列
                    initUserCheckBox();
                    // 设置收起展开人员信息
                    setCollapseTool()
                    // 选中已选择输入框中的人员
                    setUserListChecked()

                    $('.infoSelector').scrollTop(0);

                } else {
                    bootbox.alert({ message: '人员信息为空！' + data.Message, size: 'small' });
                    $('.infoSelector').loadingUI('hide');
                }
            },
            error: function () {
                bootbox.alert({ message: '人员信息加载失败！' + data.Message, size: 'small' });
                $('.infoSelector').loadingUI('hide');
            }
        });
    }

    // 初始化根据已选择人员选择当前显示的相应人员
    function setSelectedUser() {
        var selectedItems = $.url().param('selectedItems');

        if (!selectedItems || selectedItems.length == 0) { return; }
        if (selectedItems && selectedItems.length > 0) {
            $.ajax({
                url: dataServiceBaseUrl + 'api/SysMaintain/RecommendedUser/GetUserInfoRecommendedByArrOrgEmpID?arrOrgEmpID=' + selectedItems + '&sid=' + sid,
                method: 'get',
                dataType: 'json',
                success: function (data) {
                    if (data.Success) {
                        if (data.Data) {
                            $('#txtCooperativeItems').tagsinput('removeAll');

                            for (var i = 0; i < data.Data.length; i++) {
                                var objUser = new Object();
                                objUser.OrgEmpId = data.Data[i].OrgEmp_ID;
                                objUser.Emp_ID = data.Data[i].Emp_ID;
                                objUser.UserAccountID = data.Data[i].Account;
                                objUser.UserName = data.Data[i].Name;
                                objUser.Org_ID = data.Data[i].Org_ID;
                                objUser.IsMainOrg = data.Data[i].IsMainOrg;


                                $('#txtCooperativeItems').tagsinput('add', objUser);
                                arrSelectedUser.push(objUser);
                            }

                            // 刷新已选择项计数徽章
                            renewCandidateUserNum();

                        } else {
                            bootbox.alert({ message: '获取已选择人员信息为空！' + data.Message, size: 'small' });
                            $('.infoSelector').loadingUI('hide');
                        }
                    } else {
                        bootbox.alert({ message: '获取已选择人员信息失败1！' + data.Message, size: 'small' });
                        $('.infoSelector').loadingUI('hide');
                    }
                },
                error: function (data) {
                    bootbox.alert({ message: '获取已选择人员信息失败2！', size: 'small' });
                }
            });
        }
    }

    // 人员信息检索
    function loadUserList() {
        if (!$('#txtTitle').val() && !$('#txtTitle').val().trim()) {
            $('.infoSelector').loadingUI('hide');
            return;
        }
        $('#divContent').html('<div id="dataList"></div>');
        var obj = new Object();
        var searchKey = $('#txtTitle').val().trim();
        if (searchKey) {
            obj.PinYinFirstLetter = searchKey;
            obj.Name = searchKey;
            obj.Telephone = searchKey;
            obj.MobilePhone = searchKey;
            obj.Org_ID = orgRootId;
            obj.DepID = orgRootId;
            obj.TopOrgID = orgRootId;

        }
        $.ajax({
            url: dataServiceBaseUrl + 'api/SysMaintain/RecommendedUser/GetRecommendedUserInfoListBySearchFilter?searchCondition=' + escape(JSON.stringify(obj)) + '&sid=' + sid,
            method: 'get',
            dataType: 'json',
            success: function (data) {
                if (data.Success) {
                    if (data.Data.length < 1) {
                        $('.noData').addClass('in');
                        $('.noData').css('z-index', '1');

                        $('.txtNoData').text('结果为空，换个关键词试试吧。');
                        $('.infoSelector').loadingUI('hide');
                        return;
                    }
                    //else if (data.Data.length > 200) {
                    //    $('.noData').addClass('in');
                    //    $('.noData').css('z-index', '1');

                    //    $('.txtNoData').text('结果太多，换个关键词试试吧。');
                    //    $('.infoSelector').loadingUI('hide');
                    //    return;
                    //}
                    var rowData = {
                        'totalcount': data.Data.length,
                        'rows': data.Data
                    }
                    $('#dataList').css('height', $('#divContent').height() - 6);
                    $('#dataList').GWDataTable({
                        data: rowData,
                        tableTitle: '查询结果',
                        tableTitleIcon: false,
                        rowHover: false,
                        pagination: false,
                        multiCheck: (isMultiSelect == 2),
                        checkbox: true,
                        idField: 'OrgEmp_ID',
                        columns:
                        [
                            {
                                title: '姓名', field: 'Name', align: 'left', width: '80'
                                , formatter: function (value, row, index) {
                                    return setKeyPoint(value, searchKey);
                                }
                            },
                            {
                                title: '座机', field: 'Telephone', align: 'left', width: '110'
                                , formatter: function (value, row, index) {
                                    return setKeyPoint(value, searchKey);
                                }
                            },
                            {
                                title: '手机', field: 'MobilePhone', align: 'left', width: '110'
                                , formatter: function (value, row, index) {
                                    return setKeyPoint(value, searchKey);
                                }
                            },
                            {
                                title: '组织机构', field: 'Organize_Name', align: 'left', width: '200'
                                , formatter: function (value, row, index) {
                                    if (row.FatherID == 0) {
                                        return '<div title =\"' + value + '\">' + value + '</div>'
                                    } else if (row.FatherID == row.TopOrgID) {
                                        return '<div title =\"' + (row.TopOrgName + '-\>' + row.DepName) + '\">' + (row.TopOrgName + '-\>' + row.DepName) + '</div>'
                                    } else {
                                        return '<div title =\"' + (row.TopOrgName + '-\>' + row.DepName + '-\>' + row.Organize_Name) + '\">'
                                                    + (row.TopOrgName + '-\>' + row.DepName + '-\>' + value) + '</div>'
                                    }
                                }
                            }
                        ],
                        onLoadSuccess: function (table) {
                            var rows = table.find('div[class=table-row]');
                            $.each(rows, function (index, element) {
                                for (var i = 0; i < arrSelectedUser.length; i++) {
                                    if (arrSelectedUser[i].OrgEmpId == $(element).data('id')) {
                                        $(element).find('.table-cell input[type=checkbox]').iCheck('check');
                                    }
                                }
                            });
                            $('.infoSelector').loadingUI('hide');
                        },
                        onRowCheck: function (rowIndex, rowData) {
                            var objUser = new Object();
                            objUser.OrgEmpId = rowData.OrgEmp_ID;
                            objUser.Emp_ID = rowData.Emp_ID;
                            objUser.UserAccountID = rowData.Account;
                            objUser.UserName = rowData.Name;
                            objUser.Org_ID = rowData.Org_ID;
                            objUser.IsMainOrg = rowData.IsMainOrg;

                            if (isMultiSelect == 2) {
                                $('#txtCooperativeItems').tagsinput('add', objUser);
                                arrSelectedUser.push(objUser);

                                // 更新到已选择名单
                                renewCandidateUserBox();
                                // 更新徽章计数
                                renewCandidateUserNum();
                            } else {
                                arrSelectedUser.length = 1;
                                arrSelectedUser[0] = objUser;

                                // 更新到已选择名单
                                renewCandidateUserBox();
                                // 更新徽章计数
                                renewCandidateUserNum();
                            }
                        },
                        onRowCheckAll: function (rows) {
                            for (var i = 0; i < rows.length; i++) {
                                var objUser = new Object();
                                objUser.OrgEmpId = rows[i].OrgEmp_ID;
                                objUser.Emp_ID = rows[i].Emp_ID;
                                objUser.UserAccountID = rows[i].Account;
                                objUser.UserName = rows[i].Name;
                                objUser.Org_ID = rows[i].Org_ID;
                                objUser.IsMainOrg = rows[i].IsMainOrg;
                                $('#txtCooperativeItems').tagsinput('add', objUser);
                                arrSelectedUser.push(objUser);
                            }
                            // 更新到已选择名单
                            renewCandidateUserBox();
                            // 更新徽章计数
                            renewCandidateUserNum();
                        },
                        onRowUnCheck: function (rowIndex, rowData) {
                            if (isMultiSelect == 2) {
                                for (var i = 0; i < arrSelectedUser.length; i++) {
                                    if (arrSelectedUser[i].OrgEmpId == rowData.OrgEmp_ID) {
                                        arrSelectedUser.splice(i, 1);
                                        break;
                                    }
                                }
                                // 更新到已选择名单
                                renewCandidateUserBox();
                                // 更新徽章计数
                                renewCandidateUserNum();
                            } else {
                                arrSelectedUser.length = 0;
                                // 更新到已选择名单
                                renewCandidateUserBox();
                                // 更新徽章计数
                                renewCandidateUserNum();
                            }
                        },
                        onRowUnCheckAll: function (rows) {
                            arrSelectedUser.length = 0;
                            if (isMultiSelect == 2) {
                                for (var i = 0; i < arrSelectedUser.length; i++) {
                                    for (var j = 0; j < rows.length; j++) {
                                        if (arrSelectedUser[i].OrgEmpId == rows[j].OrgEmp_ID) {
                                            arrSelectedUser.splice(i, 1);
                                            break;
                                        }
                                    }
                                }
                                // 更新到已选择名单
                                renewCandidateUserBox();
                                // 更新徽章计数
                                renewCandidateUserNum();
                            } else {
                                arrSelectedUser.length = 0;
                                // 更新到已选择名单
                                renewCandidateUserBox();
                                // 更新徽章计数
                                renewCandidateUserNum();
                            }
                        }
                    });
                }
            }
        });
    }

    // 将匹配字段相应部分高亮显示
    function setKeyPoint(strSource, strKey) {
        if (!strSource) {
            return '';
        }
        strSource = '<div class=\"textOverFlowEllipsis\" title=\"' + strSource + '\"><span>' + strSource.replace(strKey, '</span><span class=\"stressKey\">' + strKey + '</span><span>') + '</span></div>'
        return strSource;
    }

    // ============================人员类初始化函数 end ==============================================

    // ============================公共工具类函数 start ==============================================

    // 根据组织机构父节点id分配查询地址
    function getSubOrgSourceUrl(orgRootId) {
        var rootUrl;
        switch (parseInt(orgRootId)) {
            case 0:
                rootUrl = dataServiceBaseUrl + 'api/UserOrg/Org/GetRootOrgList?sid=' + sid;
                break;
            case -1:
                rootUrl = dataServiceBaseUrl + 'api/UserOrg/Org/GetAllBranchInfo?sid=' + sid;
                break;
            case -2:
                rootUrl = dataServiceBaseUrl + 'api/UserOrg/Org/GetAllCompanyInfo?sid=' + sid;
                break;
            default:
                rootUrl = dataServiceBaseUrl + 'api/UserOrg/Org/GetSubOrgListByID?orgId=' + orgRootId + '&sid=' + sid;
                break;
        }

        return rootUrl;
    }

    // 设置收起展开阵列信息
    function setCollapseTool() {
        $('.showList').on('click', function () {

            var isIE10 = true;

            try {
                if ($.browser && $.browser.msie && $.browser.version && parseInt($.browser.version) < 10) {
                    isIE10 = false;
                }
            } catch (e) {
            }
            var itemlistid = $(this).data().itemlistid;

            if ($(this).parent().hasClass('exp-e')) {
                $(this).parent().removeClass('exp-e');

                if (!isIE10) {
                    $('#' + itemlistid).removeClass('collapse in').addClass('collapse');
                }

            } else {
                $(this).parent().addClass('exp-e');
                if (!isIE10) {
                    $('#' + itemlistid).removeClass('collapse').addClass('collapse in');
                }
            }

            if (isIE10) {
                $('#' + itemlistid).collapse('toggle');
            }
        });
    }

    // 加减动作动画
    function flyingAnimate(ev, thingFly, flyToDom, callback) {
        $offset = $(ev).offset();
        $offsetfavbar = $(flyToDom).offset();
        $(thingFly).css('left', $offset.left + 'px');
        $(thingFly).css('top', $offset.top + 'px');
        $(thingFly).animate({
            left: ($offsetfavbar.left + 30) + "px",
            top: ($offsetfavbar.top - 5) + "px",
            opacity: "0.8",
            fontSize: "24px"
        }, 500, function () {
            $(thingFly).css({
                left: "-1000px",
                top: "-100px",
                opacity: "1",
                fontSize: "50px"
            });
            callback();
        });
    }

    // ============================公共工具类函数 end ==============================================

    // 绑定事件
    function bindEvent() {
        var inputId = $.url().param('inputId');

        $('#btnAffirmItemsToList').on('click', function () {
            isAffirmClick = 1;
            parent.addRecommendedUserToList(inputId);
            return false;
        });
        $('#btnCloseModal').on('click', function () {
            isAffirmClick = 0;
            $('#btnClose' + inputId + 'Modal', parent.document).click();
            return false;
        });

        $('#btnReset').on('click', function () {
            if (selectOrgOrUser == 1) {
                arrSelectedUser.length = 0;
                $('.infoSelector').find('input[type=checkbox]:checked').iCheck('uncheck');

                // 更新到已选择名单
                renewCandidateUserBox();

                // 更新计数
                renewCandidateUserNum();
            }

            return false;
        });
        if (selectOrgOrUser == 1) {
            $('#btnSearch').on('click', function () {

                $('.noData').removeClass('in');
                $('.noData').css('z-index', '-1');

                $('.infoSelector').loadingUI();
                loadUserList();

            });
            $(document).on('keydown', function (event) {
                if (event.target.id == 'txtTitle') {
                    $('.noData').removeClass('in');
                    $('.noData').css('z-index', '-1');

                }

                // 回车搜索
                if (event.keyCode == 13) {
                    $('.infoSelector').loadingUI();
                    loadUserList();
                }
            });
        } 
    }
</script>
